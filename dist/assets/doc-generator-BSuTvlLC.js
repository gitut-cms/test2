import{F as k}from"./constants-DfStgaks.js";import{g as R}from"./geminiService-CD7J7Ty3.js";import{c as m}from"./fileUtils-Cb1IM2ig.js";const F='<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2"><circle cx="50" cy="50" r="50" fill="#ccc"/><g><path d="M50 62.5c-10.3 0-18.75 8.45-18.75 18.75V87.5h37.5v-6.25c0-10.3-8.45-18.75-18.75-18.75z" fill="#fff"/><path d="M50 25c-6.9 0-12.5 5.6-12.5 12.5S43.1 50 50 50s12.5-5.6 12.5-12.5S56.9 25 50 25z" fill="#fff"/></g></svg>',L=`data:image/svg+xml;base64,${btoa(F)}`,M=async(p,i)=>{try{const o=`Translate the following HTML content to ${i}. Keep the HTML structure and tags intact, only translate the text nodes. HTML: ${p}`,r=R({model:"gemini-2.5-flash",contents:o});let f="";for await(const e of r)f+=e;return f}catch(o){throw console.error("Translation via service failed:",o),new Error("Failed to translate document content.")}},O=async(p,i,o,r)=>{var f;try{let e;for(let t=p.length-1;t>=0;t--){const a=p[t];if(a.id===i||a.slug===i||a.name===i){e=a;break}}let n="";if(r.templateType==="final"){if(e!=null&&e.finalTemplateHtml)n=e.finalTemplateHtml;else if(e!=null&&e.finalTemplateUrl){const t=await fetch(m(e.finalTemplateUrl));if(!t.ok)throw new Error(`Could not fetch final template from ${m(e.finalTemplateUrl)}`);n=await t.text()}}else if(e!=null&&e.previewTemplateHtml)n=e.previewTemplateHtml;else if(e!=null&&e.previewTemplateUrl){const t=await fetch(m(e.previewTemplateUrl));if(!t.ok)throw new Error(`Could not fetch preview template from ${m(e.previewTemplateUrl)}`);n=await t.text()}n||(console.error(`Template type '${r.templateType}' for document '${(e==null?void 0:e.name)||i}' not found.`),n=`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <title>خطأ</title>
                    <style>body { font-family: sans-serif; padding: 2rem; text-align: center; }</style>
                </head>
                <body>
                    <h1>خطأ في إنشاء المستند</h1>
                    <p>عذراً، لم نتمكن من العثور على القالب المطلوب.</p>
                </body></html>
            `),r.targetLang!=="ar"&&!n.includes("<h1>خطأ")&&(n=await M(n,r.targetLang));const w=new Date,b=String(w.getDate()).padStart(2,"0"),S=String(w.getMonth()+1).padStart(2,"0"),$=w.getFullYear(),P=`${b}/${S}/${$}`;if(n=n.replace(/\[DateToday\]/g,P),n.includes("[profilePicture]")){const a=`<img src="${o.profilePicture?m(o.profilePicture):L}" alt="Profile Picture" style="width: 120px; height: 120px; border-radius: 4px; object-fit: cover; border: 1px solid #ccc; display:block; margin: 0 auto;">`;n=n.replace(/\[profilePicture\]/g,a)}if(Object.keys(o).forEach(t=>{if(t!=="profilePicture"){const a=new RegExp(`\\[${t}\\]`,"g");n=n.replace(a,o[t]||"")}}),Object.keys(k).forEach(t=>{const a=t;if(!o.hasOwnProperty(a)){const h=new RegExp(`\\[${a}\\]`,"g");n=n.replace(h,"")}}),n=n.replace(/\[[^\]]+\]/g,""),r.action==="download"){const t=document.createElement("iframe");t.style.width="794px",t.style.height="1123px",t.style.position="absolute",t.style.left="-9999px",t.style.top="0",t.style.border="none",document.body.appendChild(t);const a=t.contentDocument||((f=t.contentWindow)==null?void 0:f.document);if(!a)throw new Error("Could not access iframe document");const h='<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Merriweather:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=Noto+Serif+TR:wght@400;700&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">';n.includes("<head>")?n=n.replace("<head>",`<head>${h}`):n=`<html><head>${h}</head>`+n,a.open(),a.write(n),a.close(),await new Promise(s=>{const c=t.contentWindow;if(!c){setTimeout(s,1e3);return}const d=()=>{setTimeout(s,500)};c.document.fonts&&c.document.fonts.ready?c.document.fonts.ready.then(d).catch(()=>{console.warn("Font loading promise failed, continuing anyway."),d()}):setTimeout(d,2e3)}),await html2canvas(a.body,{scale:2,useCORS:!0,logging:!1,windowWidth:794,windowHeight:1123,allowTaint:!1}).then(s=>{const c=s.toDataURL("image/png"),{jsPDF:d}=jspdf,g=new d({orientation:"portrait",unit:"pt",format:"a4"}),u=g.internal.pageSize.getWidth(),y=g.internal.pageSize.getHeight(),H=s.width,C=s.height,T=H/C,D=u/y;let v,x;T>D?(v=u,x=u/T):(x=y,v=y*T),g.addImage(c,"PNG",0,0,v,x);const E=`${(e==null?void 0:e.slug)||i}.pdf`;g.save(E)}),document.body.removeChild(t);return}const l=window.open("","_blank");l?(l.document.write(n),l.document.close(),l.onload=function(){l.focus(),r.action==="print"&&l.print()}):alert("يرجى السماح بالنوافذ المنبثقة لطباعة المستند.")}catch(e){throw console.error("Error generating document:",e),alert(`حدث خطأ أثناء تجهيز المستند: ${e.message}.`),e}};export{O as g};
