import{b as _,a as $,o as q,u as z,c as B,r as m,j as e,F as H,L as k,aM as G,am as K,aN as Q}from"./index-DgmZNK3x.js";import{F as V}from"./constants-DfStgaks.js";import{S as W}from"./SpeechRecognitionControl-BM9TYsD7.js";import"./geminiService-CD7J7Ty3.js";const te=()=>{const{siteId:F}=_(),I=$(),{user:a,updateUserCredits:D}=q(),{sites:N,cafes:v,siteSettings:c,loading:E}=z(),{t:r}=B(),l=m.useMemo(()=>N.find(s=>s.id===F),[F,N]),f=m.useMemo(()=>v.find(s=>s.id===(a==null?void 0:a.cafeId)),[v,a]),o=(f==null?void 0:f.formFillMode)||"json",[g,b]=m.useState({}),[i,h]=m.useState(null),[C,j]=m.useState(""),[P,M]=m.useState(!0);m.useEffect(()=>{o==="json"&&(l!=null&&l.jsonTemplate)?h(l.jsonTemplate):h(null)},[l,o]);const w=(s,t)=>{b(n=>({...n,[s]:t}))},U=s=>{const t={...g};s.forEach(({fieldId:n,value:p})=>{t[n]=p}),b(t)},J=s=>{var p;const t=(p=s.target.files)==null?void 0:p[0];if(!t)return;j("");const n=new FileReader;n.onload=y=>{var u;try{const x=(u=y.target)==null?void 0:u.result,d=JSON.parse(x);if(d&&d.siteId&&Array.isArray(d.fields))h(d);else throw new Error("Invalid JSON structure.")}catch(x){j(r("fillSitePage.jsonError.invalid")),console.error(x)}},n.onerror=()=>{j(r("fillSitePage.jsonError.read"))},n.readAsText(t)},A=async s=>{if(s.preventDefault(),!a||!c||!l){alert(r("fillSitePage.submitError.missingData"));return}const t=a.credits.currency==="USD"?c.pricing.siteFormFill.usd:c.pricing.siteFormFill.dzd,n=await K(a,t);if(!n.success){alert(n.message),I(`/${a.countryCode}/app/billing`);return}if(D(a.credits.amount-t),P){const u={},x=o==="json"?i==null?void 0:i.fields.map(d=>({id:d.fieldId,label:d.label})):l==null?void 0:l.templateFields;x&&(x.forEach(d=>{const S=d.id;Object.keys(V).includes(S)&&(u[S]=g[S])}),Object.keys(u).length>0&&Q.create(u))}const p={source:"gitut-webapp",type:"client_data_update",payload:g};window.postMessage(p,"*"),window.open(l.url,"_blank");const y=(a==null?void 0:a.credits.currency)==="USD"?"$":"دج";alert(r("fillSitePage.successMessage",{cost:t,currency:y})),b({})},O=m.useMemo(()=>o==="json"&&i?i.fields.map(s=>({id:s.fieldId,label:s.label})):o==="ai"&&(l!=null&&l.templateFields)?l.templateFields.map(s=>({id:s.id,label:s.label})):[],[l,o,i]);if(E)return e.jsx("div",{className:"flex justify-center items-center p-10",children:e.jsx(H,{className:"animate-spin text-4xl text-green-600"})});if(!l||l.type!=="template")return e.jsxs("div",{className:"text-center py-20",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:r("fillSitePage.notFound.title")}),e.jsx("p",{className:"text-gray-600 mb-6",children:r("fillSitePage.notFound.message")}),e.jsx(k,{to:"/app",className:"bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors",children:r("fillSitePage.notFound.backButton")})]});const T=(a==null?void 0:a.credits.currency)==="USD"?c==null?void 0:c.pricing.siteFormFill.usd:c==null?void 0:c.pricing.siteFormFill.dzd,L=(a==null?void 0:a.credits.currency)==="USD"?"$":"دج",R=()=>{var s;return o==="json"?i?i.fields.map(t=>e.jsxs("div",{children:[e.jsx("label",{htmlFor:t.fieldId,className:"block text-sm font-medium text-gray-700 mb-1",children:t.label}),e.jsx("input",{type:"text",id:t.fieldId,name:t.fieldId,value:g[t.fieldId]||"",onChange:n=>w(n.target.name,n.target.value),required:!0,className:"block w-full px-3 py-2 border border-gray-300 rounded-md"})]},t.cssSelector)):e.jsxs("div",{className:"text-center p-6 border-2 border-dashed rounded-lg",children:[e.jsx("p",{className:"font-semibold text-gray-700",children:r("fillSitePage.jsonStep1.title")}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r("fillSitePage.jsonStep1.subtitle")})]}):(s=l.templateFields)==null?void 0:s.map(t=>e.jsxs("div",{children:[e.jsx("label",{htmlFor:t.id,className:"block text-sm font-medium text-gray-700 mb-1",children:t.label}),e.jsx("input",{type:"text",id:t.id,name:t.id,value:g[t.id]||"",onChange:n=>w(n.target.name,n.target.value),required:!0,className:"block w-full px-3 py-2 border border-gray-300 rounded-md"})]},t.id))};return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800 mb-2",children:r("fillSitePage.title",{name:l.name})}),e.jsxs("p",{className:"text-gray-600",children:[r("fillSitePage.cost")," ",e.jsxs("span",{className:"font-bold font-mono",children:[T," ",L]})]})]}),e.jsxs(k,{to:`/${a==null?void 0:a.countryCode}/app`,className:"text-sm bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors",children:["← ",r("fillSitePage.back")]})]}),e.jsxs("form",{onSubmit:A,className:"space-y-6 bg-white p-8 rounded-lg border",children:[o==="json"&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border",children:[e.jsxs("label",{htmlFor:"json-upload",className:"flex items-center gap-3 cursor-pointer text-blue-800 font-semibold",children:[e.jsx(G,{className:"text-2xl"}),e.jsxs("div",{children:[e.jsx("span",{children:i?r("fillSitePage.loadedTemplate",{name:i.siteName}):r("fillSitePage.uploadJsonLabel")}),e.jsx("p",{className:"text-xs font-normal text-gray-600",children:r("fillSitePage.uploadJsonHint")})]})]}),e.jsx("input",{id:"json-upload",type:"file",accept:".json",onChange:J,className:"hidden"}),C&&e.jsx("p",{className:"text-red-500 text-sm mt-2",children:C})]}),(o==="ai"||o==="json"&&i)&&e.jsx(W,{formFields:O,onFieldUpdate:U}),R(),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("input",{id:"saveClient",name:"saveClient",type:"checkbox",checked:P,onChange:s=>M(s.target.checked),className:"h-4 w-4 text-green-600"}),e.jsx("label",{htmlFor:"saveClient",className:"mr-2 block text-sm text-gray-900",children:r("fillSitePage.saveClient")})]}),e.jsx("button",{type:"submit",className:"w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition-colors flex items-center justify-center gap-2",children:e.jsx("span",{children:r("fillSitePage.submitButton")})})]})]})]})};export{te as default};
