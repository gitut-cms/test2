import{o as ue,u as xe,c as pe,n as ge,r as h,j as e,F as X,H as ee,l as he,I as te,z as be,A as fe,E as ye,B as je,k as ve,D as Ne,a9 as we,am as De}from"./index-hpjxKmld.js";import{F as se,f as Ce}from"./constants-DfStgaks.js";import{g as ae}from"./doc-generator-Ct1URtxh.js";import{I as Fe}from"./ImageCapture-CWevzux-.js";import{asBlob as Pe}from"https://esm.sh/html-docx-js-typescript@0.1.5";import Se from"https://esm.sh/file-saver@2.0.5";import"./geminiService-DifXNJPz.js";import"./fileUtils-Cb1IM2ig.js";const ke=(u,v)=>{if(!v||v.length===0)return"";const f=u.displayType||"table";if(f==="table"){let c='<table style="width:100%; border-collapse: collapse; margin: 20px 0; font-size: 14pt;"><thead><tr>';return u.itemFields.forEach(y=>{c+=`<th style="border:1px solid #000; padding: 8px; background: #f0f0f0; text-align: center;">${y.label}</th>`}),c+="</tr></thead><tbody>",v.forEach(y=>{c+="<tr>",u.itemFields.forEach(E=>{c+=`<td style="border:1px solid #000; padding: 8px; text-align: center;">${y[E.id]||""}</td>`}),c+="</tr>"}),c+="</tbody></table>",c}const x=v.map(c=>u.itemFields.map(y=>c[y.id]).filter(y=>y!=null&&y!=="").join(" - ")).filter(c=>c!=="");if(x.length===0)return"";if(f==="comma")return x.join("، ");const N=f==="ol"?"ol":"ul";return`<${N}>${x.map(c=>`<li>${c}</li>`).join("")}</${N}>`},$e=(u,v)=>{var f,x;return!!((f=v.fieldCustomizations)!=null&&f[u])||!!((x=v.questions)!=null&&x[u])},Je=()=>{const{user:u,updateUserCredits:v}=ue(),{siteSettings:f}=xe(),{t:x}=pe(),N=ge(),[c,y]=h.useState([]),[E,_]=h.useState(!0),[j,w]=h.useState([]),[re,T]=h.useState(!1),[S,M]=h.useState(""),[P,q]=h.useState(""),[k,I]=h.useState([]),[C,$]=h.useState(0),[ne,A]=h.useState(!1),[oe,L]=h.useState(null),V=h.useMemo(()=>!u||!f?0:u.credits.currency==="USD"?f.pricing.dynamicDocument.usd:f.pricing.dynamicDocument.dzd,[u,f]);h.useEffect(()=>{(async()=>{if(!(u!=null&&u.countryCode)){_(!1);return}try{const s=await we(u.countryCode);y(s)}catch(s){console.error("Failed to load country documents:",s)}finally{_(!1)}})()},[u==null?void 0:u.countryCode]),h.useEffect(()=>{if(N.state&&N.state.preSelectedDocIds&&c.length>0){const t=N.state.preSelectedDocIds,s=c.filter(r=>t.includes(r.id));if(s.length>0){const r={id:Date.now(),name:"زبون جديد",documentIds:s.map(a=>a.id),formData:{},complexFormData:{},saveClient:!0,isFromClientList:!1};w([r]),A(!0),$(0),window.history.replaceState({},document.title)}}},[N.state,c]);const R=h.useMemo(()=>{if(!P)return[];const t=P.toLowerCase();return c.filter(s=>s.name.toLowerCase().includes(t))},[P,c]),le=t=>{k.find(s=>s.id===t.id)||I(s=>[...s,t]),q("")},ie=t=>{I(s=>s.filter(r=>r.id!==t))},ce=()=>{if(!S.trim()||k.length===0){alert(x("multiPersonJobPage.alerts.enterNameAndDoc"));return}const t={id:Date.now(),name:S,documentIds:k.map(s=>s.id),formData:{fullName:S},complexFormData:{},saveClient:!0,isFromClientList:!1};w(s=>[...s,t]),M(""),I([]),q(""),T(!1)},U=h.useCallback(t=>{const s=new Map;return c.filter(a=>t.documentIds.includes(a.id)).forEach(a=>{var o;(o=a.requiredFields)==null||o.forEach(n=>{var K,W,B,G,Q,Y,Z;if(n==="DateToday")return;const i=$e(n,a)||!se[n],l=se[n];let m=n;(K=a.questions)!=null&&K[n]?m=a.questions[n]:(B=(W=a.fieldCustomizations)==null?void 0:W[n])!=null&&B.customQuestion?m=a.fieldCustomizations[n].customQuestion:l?(m=x(l.label),m===l.label&&(m=Ce[n]||l.label)):m=n;const g=((Q=(G=a.fieldCustomizations)==null?void 0:G[n])==null?void 0:Q.type)||(l==null?void 0:l.type)||"text";let d;const D=(Z=(Y=a.fieldCustomizations)==null?void 0:Y[n])==null?void 0:Z.options;D?d=D.map(b=>typeof b=="string"?{value:b,label:b}:{value:b.value,label:b.label,mappedValues:b.mappedValues}):l!=null&&l.options&&(d=l.options.map(b=>({value:b.value,label:x(b.label)})));const F=i?`${a.id}_${n}`:n;if(s.has(F)){const b=s.get(F);b.sourceDocs.includes(a.name)||b.sourceDocs.push(a.name)}else s.set(F,{uniqueId:F,fieldId:n,label:m,type:g,options:d,isCustom:i,sourceDocs:[a.name]})})}),Array.from(s.values())},[c,x]),p=j[C],O=h.useMemo(()=>p?U(p):[],[p,U]),z=(t,s,r)=>{w(a=>a.map((o,n)=>{if(n!==C)return o;const i={...o.formData};return O.forEach(l=>{if(l.fieldId===s&&(i[l.uniqueId]=r,l.uniqueId.includes("_")||(i[s]=r),l.type==="select"&&l.options)){const m=l.options.find(g=>g.value===r);m&&m.mappedValues&&Object.entries(m.mappedValues).forEach(([g,d])=>{i[g]=d})}}),{...o,formData:i}}))},H=(t,s)=>{const r={};return Object.keys(t.formData).forEach(a=>{a.includes("_")||(r[a]=t.formData[a])}),Object.keys(t.formData).forEach(a=>{if(a.startsWith(`${s.id}_`)){const o=a.replace(`${s.id}_`,"");r[o]=t.formData[a]}}),s.complexFields&&s.complexFields.forEach(a=>{var i;const o=((i=t.complexFormData)==null?void 0:i[a.id])||[],n=a.templatePlaceholder.replace(/[\[\]]/g,"");r[n]=ke(a,o)}),s.fieldCustomizations&&Object.entries(s.fieldCustomizations).forEach(([a,o])=>{if(o.type==="select"&&o.options){const n=`${s.id}_${a}`,i=t.formData[n]||t.formData[a];if(i){const l=o.options,g=(Array.isArray(l)?l.map(d=>typeof d=="string"?{value:d,label:d}:d):[]).find(d=>d.value===i);if(g&&g.outputTemplate){const d=`${n}_sub`,D=t.formData[d]||"";r[a]=g.outputTemplate.replace("{subValue}",D).replace("{self}",g.label)}}}}),r},J=async(t,s,r,a="pdf")=>{if(u){L(`${t.id}-${s}`);try{const o=await De(u,V);if(!o.success){alert(o.message),L(null);return}v(u.credits.amount-V),r==="download"?await de(t,s,a):await me(t,s)}catch(o){console.error("Credit deduction or processing error:",o),alert("حدث خطأ أثناء العملية.")}finally{L(null)}}},de=async(t,s,r)=>{const a=c.find(o=>o.id===s);if(a)try{const o=H(t,a);if(r==="docx"){let n=a.finalTemplateHtml||"";if(!n&&a.finalTemplateUrl)try{const d=await fetch(a.finalTemplateUrl);d.ok&&(n=await d.text())}catch(d){console.error("Failed to fetch docx template",d)}if(!n)throw new Error("Template content not found.");const l=new Date().toLocaleDateString("ar-DZ");n=n.replace(/\[DateToday\]/g,l),Object.keys(o).forEach(d=>{n=n.replace(new RegExp(`\\[${d}\\]`,"g"),o[d]||"")}),n=n.replace(/\[[^\]]+\]/g,"");const m=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"></head><body>${n}</body></html>`,g=await Pe(m,{orientation:"portrait",margins:{top:720,right:720,bottom:720,left:720}});Se.saveAs(g,`${a.slug||a.name}.docx`)}else await ae([a],a.id,o,{action:"download",targetLang:"ar",templateType:"final"})}catch(o){console.error("Generation failed:",o),alert("فشل إنشاء المستند.")}},me=async(t,s)=>{const r=c.find(a=>a.id===s);if(r)try{const a=H(t,r);await ae([r],r.id,a,{action:"print",targetLang:"ar",templateType:"final"})}catch(a){console.error(a),alert("فشل الطباعة")}};return E?e.jsx("div",{className:"flex justify-center items-center p-10",children:e.jsx(X,{className:"animate-spin text-4xl text-green-600"})}):ne?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("button",{onClick:()=>A(!1),className:"text-sm bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200",children:["← ",x("multiPersonJobPage.buttons.backToSetup")]}),e.jsxs("div",{className:"flex items-center bg-white rounded-full shadow-sm border p-1",children:[e.jsx("button",{onClick:()=>$(t=>(t-1+j.length)%j.length),className:"p-2 rounded-full hover:bg-gray-100 text-gray-600",disabled:j.length<=1,children:e.jsx(be,{})}),e.jsxs("span",{className:"font-bold text-gray-800 px-4 min-w-[150px] text-center",children:[p==null?void 0:p.name," ",e.jsxs("span",{className:"text-gray-400 text-sm font-normal",children:["(",C+1,"/",j.length,")"]})]}),e.jsx("button",{onClick:()=>$(t=>(t+1)%j.length),className:"p-2 rounded-full hover:bg-gray-100 text-gray-600",disabled:j.length<=1,children:e.jsx(fe,{})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 bg-white rounded-xl shadow-md border p-6",children:[e.jsxs("h2",{className:"text-xl font-bold mb-4 text-gray-800 border-b pb-2",children:["بيانات ",p==null?void 0:p.name]}),e.jsxs("div",{className:"space-y-4 max-h-[65vh] overflow-y-auto pr-2",children:[O.length===0?e.jsx("p",{className:"text-gray-500 italic",children:"لا توجد حقول مطلوبة للمستندات المختارة."}):O.map(t=>e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg border border-gray-100",children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:[t.label,t.isCustom&&e.jsxs("span",{className:"text-xs text-blue-600 font-normal mr-2",children:["(مخصص لـ: ",t.sourceDocs.join(", "),")"]}),!t.isCustom&&t.sourceDocs.length>1&&e.jsxs("span",{className:"text-xs text-green-600 font-normal mr-2",children:["(مشترك بين ",t.sourceDocs.length," مستندات)"]})]}),t.type==="file"||t.fieldId==="profilePicture"?e.jsx(Fe,{value:p.formData[t.uniqueId]||"",onChange:s=>z(t.uniqueId,t.fieldId,s)}):t.options?e.jsxs("select",{value:p.formData[t.uniqueId]||"",onChange:s=>z(t.uniqueId,t.fieldId,s.target.value),className:"w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-500",children:[e.jsxs("option",{value:"",children:["-- ",x("formPage.selectOption")||"اختر"," --"]}),t.options.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}):e.jsx("input",{type:t.type,value:p.formData[t.uniqueId]||"",onChange:s=>z(t.uniqueId,t.fieldId,s.target.value),className:"w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500",placeholder:t.label})]},t.uniqueId)),p.documentIds.map(t=>{const s=c.find(r=>r.id===t);return s!=null&&s.complexFields?s.complexFields.map(r=>{var a;return e.jsxs("div",{className:"border-2 border-blue-100 p-4 rounded-lg bg-blue-50 mt-6",children:[e.jsx("label",{className:"block font-bold text-gray-800 mb-1",children:r.label}),e.jsxs("p",{className:"text-xs text-blue-600 mb-3",children:["(مخصص لـ: ",s.name,")"]}),e.jsx("div",{className:"space-y-3",children:(((a=p.complexFormData)==null?void 0:a[r.id])||[]).map((o,n)=>e.jsxs("div",{className:"bg-white p-3 rounded shadow-sm border relative",children:[e.jsx("button",{type:"button",onClick:()=>{const i={...p.complexFormData};i[r.id]=(i[r.id]||[]).filter((l,m)=>m!==n),w(l=>l.map((m,g)=>g===C?{...m,complexFormData:i}:m))},className:"absolute top-2 left-2 text-red-400 hover:text-red-600",children:e.jsx(ee,{size:12})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 pr-4",children:r.itemFields.map(i=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:i.label}),e.jsx("input",{type:i.type,value:o[i.id]||"",onChange:l=>{const m={...p.complexFormData},g=[...m[r.id]||[]];g[n]={...g[n],[i.id]:l.target.value},m[r.id]=g,w(d=>d.map((D,F)=>F===C?{...D,complexFormData:m}:D))},className:"w-full p-1 border rounded text-sm"})]},i.id))})]},n))}),e.jsxs("button",{onClick:()=>{const o={...p.complexFormData};o[r.id]=[...o[r.id]||[],{}],w(n=>n.map((i,l)=>l===C?{...i,complexFormData:o}:i))},className:"mt-3 text-sm flex items-center gap-1 text-blue-600 font-semibold hover:text-blue-800",children:[e.jsx(te,{})," ",r.addItemButtonLabel||"إضافة عنصر جديد"]})]},`${t}_${r.id}`)}):null})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-xl shadow-inner p-6 border h-fit",children:[e.jsx("h2",{className:"text-xl font-bold mb-4 text-gray-800",children:"المستندات الجاهزة"}),e.jsx("div",{className:"space-y-3",children:p.documentIds.map(t=>{const s=c.find(a=>a.id===t);if(!s)return null;const r=oe===`${p.id}-${s.id}`;return e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-sm border",children:[e.jsx("h3",{className:"font-bold text-gray-800 mb-2 truncate",title:s.name,children:s.name}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>J(p,s.id,"print"),disabled:r,className:"flex-1 bg-gray-100 text-gray-700 py-2 rounded-md hover:bg-gray-200 flex items-center justify-center gap-1 font-medium text-sm transition-colors",children:[r?e.jsx(X,{className:"animate-spin"}):e.jsx(ye,{}),"طباعة"]}),e.jsxs("div",{className:"relative group flex-1",children:[e.jsxs("button",{className:"w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 flex items-center justify-center gap-1 font-medium text-sm transition-colors",children:[e.jsx(je,{}),"تحميل"]}),e.jsxs("div",{className:"absolute top-full right-0 w-full bg-white border shadow-lg rounded-md hidden group-hover:block z-10 overflow-hidden mt-1",children:[e.jsxs("button",{onClick:()=>J(person,s.id,"download","pdf"),className:"w-full text-right px-3 py-2 hover:bg-gray-100 text-sm flex items-center gap-2",children:[e.jsx(ve,{className:"text-red-500"})," PDF"]}),e.jsxs("button",{onClick:()=>J(person,s.id,"download","docx"),className:"w-full text-right px-3 py-2 hover:bg-gray-100 text-sm flex items-center gap-2",children:[e.jsx(Ne,{className:"text-blue-500"})," Word"]})]})]})]})]},s.id)})})]})]})]}):e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800 mb-2",children:x("multiPersonJobPage.title")}),e.jsx("p",{className:"text-gray-600 mb-6",children:x("multiPersonJobPage.step1Subtitle")}),e.jsx("div",{className:"space-y-4",children:j.map((t,s)=>e.jsxs("div",{className:"bg-white p-4 rounded-lg border flex justify-between items-center shadow-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-bold text-lg text-gray-800",children:[s+1,". ",t.name]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:t.documentIds.map(r=>{const a=c.find(o=>o.id===r);return a?e.jsx("span",{className:"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full",children:a.name},r):null})})]}),e.jsx("button",{onClick:()=>w(r=>r.filter(a=>a.id!==t.id)),className:"text-red-500 hover:text-red-700 bg-red-50 p-2 rounded-full",children:e.jsx(ee,{})})]},t.id))}),re?e.jsxs("div",{className:"bg-gray-50 p-6 rounded-lg border border-gray-200 mt-6 animate-fadeIn shadow-inner",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 text-gray-800",children:x("multiPersonJobPage.section.addPerson")}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"الاسم الكامل"}),e.jsx("input",{type:"text",value:S,onChange:t=>M(t.target.value),placeholder:"مثال: أحمد محمد",className:"w-full p-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"المستندات المطلوبة"}),e.jsx("div",{className:"flex gap-2",children:e.jsx("input",{type:"text",value:P,onChange:t=>q(t.target.value),placeholder:x("multiPersonJobPage.placeholders.searchService"),className:"flex-grow p-2 border rounded-md"})}),P&&R.length>0&&e.jsx("ul",{className:"mt-1 bg-white border rounded-md shadow-lg max-h-40 overflow-y-auto",children:R.map(t=>e.jsx("li",{onClick:()=>le(t),className:"px-4 py-2 hover:bg-gray-100 cursor-pointer",children:t.name},t.id))}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:k.map(t=>e.jsxs("div",{className:"flex items-center gap-1 bg-green-100 text-green-800 rounded-full px-3 py-1 text-sm",children:[e.jsx("span",{children:t.name}),e.jsx("button",{onClick:()=>ie(t.id),className:"text-green-900 hover:text-red-600",children:e.jsx(he,{})})]},t.id))})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx("button",{onClick:ce,className:"bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700",children:x("multiPersonJobPage.buttons.confirmAdd")}),e.jsx("button",{onClick:()=>T(!1),className:"bg-gray-200 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-300",children:x("multiPersonJobPage.buttons.cancel")})]})]})]}):e.jsxs("button",{onClick:()=>T(!0),className:"mt-6 w-full py-4 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-green-500 hover:text-green-600 flex items-center justify-center gap-2 transition-colors",children:[e.jsx(te,{}),e.jsx("span",{className:"font-semibold",children:x("multiPersonJobPage.buttons.addPerson")})]}),e.jsx("div",{className:"mt-8 pt-6 border-t",children:e.jsx("button",{onClick:()=>{A(!0),$(0)},disabled:j.length===0,className:"w-full bg-blue-600 text-white font-bold text-lg py-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed shadow-lg",children:x("multiPersonJobPage.buttons.startFilling",{count:j.length})})})]})};export{Je as default};
