import{u as V,c as A,r as n,j as e,b as B,L as _,z as G,A as J}from"./index-hpjxKmld.js";import{F as K}from"./constants-DfStgaks.js";const Q=({onSearch:h})=>{const{wilayas:x,dairas:i,communes:N,locationsLoading:y}=V(),{t:m}=A(),[f,P]=n.useState(""),[l,j]=n.useState(""),[v,w]=n.useState(""),[F,C]=n.useState(""),[L,D]=n.useState([]),[I,b]=n.useState([]),U=a=>{const d=a.target.value;P(d),j(""),w(""),d?(D(i.filter(c=>c.wilaya_code===d)),b([])):(D([]),b([]))},S=a=>{const d=a.target.value;j(d),w(""),b(d&&f?N.filter(c=>c.daira_name===d&&c.wilaya_code===f):[])},W=a=>{w(a.target.value)},k=a=>{var c;a.preventDefault();const d=((c=x.find(M=>M.code===f))==null?void 0:c.name)||"";h({wilaya:d,daira:l,commune:v,name:F})};return e.jsxs("form",{onSubmit:k,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("select",{value:f,onChange:U,className:"p-3 bg-white border border-gray-300 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-green-500",disabled:y,"aria-label":"Select Wilaya",children:[e.jsx("option",{value:"",children:m(y?"signup.loading":"signup.selectWilaya")}),x.map(a=>e.jsx("option",{value:a.code,children:a.name},a.id))]}),e.jsxs("select",{value:l,onChange:S,className:"p-3 bg-white border border-gray-300 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-green-500",disabled:!f||L.length===0,"aria-label":"Select Daira",children:[e.jsx("option",{value:"",children:m("signup.selectDaira")}),L.map(a=>e.jsx("option",{value:a.name,children:a.name},a.id))]}),e.jsxs("select",{value:v,onChange:W,className:"p-3 bg-white border border-gray-300 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-green-500",disabled:!l||I.length===0,"aria-label":"Select Commune",children:[e.jsx("option",{value:"",children:m("signup.selectCommune")}),I.map(a=>e.jsx("option",{value:a.name,children:a.name},a.id))]}),e.jsx("input",{type:"text",placeholder:m("searchForm.searchByName"),value:F,onChange:a=>C(a.target.value),className:"p-3 bg-white border border-gray-300 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-green-500","aria-label":"Search by cafe name"})]}),e.jsx("button",{type:"submit",className:"w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition-colors",children:m("searchForm.search")})]})};function X(h,x){function i(v){return v*Math.PI/180}const N=6371,y=i(x.latitude-h.latitude),m=i(x.longitude-h.longitude),f=i(h.latitude),P=i(h.latitude),l=Math.sin(y/2)*Math.sin(y/2)+Math.sin(m/2)*Math.sin(m/2)*Math.cos(f)*Math.cos(P),j=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l));return N*j}const ee=()=>{const{countryCode:h,type:x,id:i}=B(),{documents:N,staticDocuments:y,sites:m,cafes:f,loading:P}=V(),[l,j]=n.useState(null),[v,w]=n.useState([]),[F,C]=n.useState(!1),[L,D]=n.useState(!1),[I,b]=n.useState(!1),[U,S]=n.useState(""),[W,k]=n.useState(!1),[a,d]=n.useState([]),[c,M]=n.useState(0),$=n.useMemo(()=>{if(!l)return"";let t="";if("description"in l&&l.description?t=l.description:"url"in l&&(t=`<p>${l.url}</p>`),!t)return"<p>لا يوجد وصف متاح لهذا المستند.</p>";const o=`<div class="my-6 p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded-md" role="alert">
            <p class="font-bold">ملاحظة هامة</p>
            <p>أزرار معاينة وتحميل أو تعبئة هذا المستند موجودة في <strong>أسفل هذه الصفحة</strong>.</p>
        </div>`,s=t.indexOf("</p>");return s!==-1?t.slice(0,s+4)+o+t.slice(s+4):o+t},[l]);n.useEffect(()=>{j(null),S(""),(()=>{let o=null;if(x==="doc"&&i){const s=N.find(r=>r.id===i||r.slug===i);if(s){o={...s,type:"doc"};const g=N.filter(u=>u.groupId===s.groupId).sort((u,R)=>u.name.localeCompare(R.name,"ar"));d(g);const E=g.findIndex(u=>u.id===s.id);M(E>=0?E:0)}}else if(x==="site"&&i){const s=m.find(r=>r.id===i||r.slug===i);s&&(o={...s,type:"site"},d([]))}else if(x==="static-doc"&&i){const s=y.find(r=>r.id===i||r.slug===i);s&&(o={...s,type:"static-doc"},d([]))}o&&o.countryCode&&o.countryCode!==h?j(null):j(o)})()},[x,i,N,m,y,h]),n.useEffect(()=>{const t=async()=>{if(a.length>0&&c<a.length){const s=a[c].previewTemplateUrl;if(!s){S(""),k(!1);return}k(!0);try{const r=await fetch(s);r.ok?S(await r.text()):S("")}catch(r){console.error("Error fetching preview:",r),S("")}finally{k(!1)}}};(l==null?void 0:l.type)==="doc"&&a.length>0&&t()},[a,c,l]);const z=()=>{M(t=>(t+1)%a.length)},H=()=>{M(t=>(t-1+a.length)%a.length)},q=t=>{if(!l)return;let s=f;const r=t.name.trim().toLowerCase();t.wilaya&&(s=s.filter(g=>g.address.wilaya===t.wilaya)),t.daira&&(s=s.filter(g=>g.address.daira===t.daira)),t.commune&&(s=s.filter(g=>g.address.commune===t.commune)),r&&(s=s.filter(g=>g.name.toLowerCase().includes(r))),w(s),b(!0),C(!1)},O=t=>{const o=t.target.checked;if(C(o),o){if(!navigator.geolocation){alert("المتصفح لا يدعم تحديد الموقع الجغرافي."),C(!1);return}D(!0),b(!1),navigator.geolocation.getCurrentPosition(s=>{const r={latitude:s.coords.latitude,longitude:s.coords.longitude},E=f.filter(u=>u.address.latitude&&u.address.longitude).map(u=>({...u,distance:X(r,u.address)})).sort((u,R)=>u.distance-R.distance);w(E),D(!1),b(!0)},s=>{console.error("Geolocation error:",s),alert(`حدث خطأ أثناء تحديد الموقع: ${s.message}`),D(!1),C(!1)})}else w([]),b(!1)},p=n.useMemo(()=>{if((l==null?void 0:l.type)==="doc"&&a.length>0){const t=a[c];return t?{...t,type:"doc"}:null}else if((l==null?void 0:l.type)==="static-doc")return{...l,type:"static-doc"};return l},[l,a,c]),T=n.useMemo(()=>{if((p==null?void 0:p.type)!=="doc")return[];const t=p;return(t.spokenFields&&t.spokenFields.length>0?t.spokenFields:t.requiredFields).filter(s=>s!=="profilePicture").map(s=>K[s]).filter(s=>!!s)},[p]);return p?e.jsxs("div",{className:"max-w-5xl mx-auto space-y-8",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 md:p-8 text-center",children:[e.jsx("h1",{className:"text-4xl font-bold text-gray-900 mb-2",children:p.name}),e.jsx("div",{className:"text-lg text-gray-600 prose max-w-none mx-auto",dangerouslySetInnerHTML:{__html:$}})]}),l.type==="doc"&&e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 md:p-8",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"معاينة المستند"}),e.jsxs("div",{className:"relative",children:[a.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:H,className:"absolute right-3 top-1/2 -translate-y-1/2 z-10 bg-black bg-opacity-50 text-white p-4 rounded-full hover:bg-opacity-75 transition-all","aria-label":"التصميم السابق",children:e.jsx(G,{className:"h-6 w-6"})}),e.jsx("button",{onClick:z,className:"absolute left-3 top-1/2 -translate-y-1/2 z-10 bg-black bg-opacity-50 text-white p-4 rounded-full hover:bg-opacity-75 transition-all","aria-label":"التصميم التالي",children:e.jsx(J,{className:"h-6 w-6"})}),e.jsxs("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 z-10 bg-black bg-opacity-50 text-white text-sm px-3 py-1 rounded-full",children:[c+1," / ",a.length]})]}),W?e.jsx("div",{className:"flex justify-center items-center h-64 bg-gray-50 rounded-md",children:e.jsx("p",{className:"text-gray-500",children:"جاري تحميل المعاينة..."})}):U?e.jsx("iframe",{srcDoc:U,title:"معاينة المستند",className:"w-full h-[70vh] border rounded-md bg-white"}):e.jsx("div",{className:"flex justify-center items-center h-64 bg-gray-50 rounded-md",children:e.jsx("p",{className:"text-gray-500",children:"لا توجد معاينة متاحة لهذا المستند."})})]})]}),l.type==="static-doc"&&"fileUrl"in l&&e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 md:p-8",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"معاينة المستند"}),e.jsx("iframe",{src:l.fileUrl,title:"معاينة المستند",className:"w-full h-[70vh] border rounded-md bg-white"}),e.jsx("div",{className:"mt-4 text-center",children:e.jsx("a",{href:l.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"inline-block bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700",children:"فتح في نافذة جديدة أو تحميل"})})]}),p.type==="doc"&&e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 md:p-8",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"التعليمات الخاصة بهذا التصميم"}),p.visitorExamplePrompt&&e.jsxs("div",{className:"bg-blue-50 border-r-4 border-blue-400 p-4 rounded-md mb-6",children:[e.jsx("h3",{className:"font-bold text-lg text-blue-800 mb-2",children:"كيفية التسجيل الصوتي (مثال):"}),e.jsxs("p",{className:"text-blue-700 leading-relaxed",children:['"',p.visitorExamplePrompt,'"']})]}),T.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:"المعلومات المطلوبة صوتيًا:"}),e.jsx("ul",{className:"list-disc list-inside mt-2 space-y-1 text-gray-700",children:T.map(t=>e.jsx("li",{children:t.label},t.id))})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 md:p-8",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"ابحث عن مقهى يقدم هذه الخدمة"}),!F&&e.jsx(Q,{onSearch:q}),e.jsx("div",{className:"mt-4",children:e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:F,onChange:O,disabled:L,className:"h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"font-semibold text-gray-700",children:L?"...جاري تحديد موقعك":"البحث عن الأقرب إلى موقعي"})]})})]}),I&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h2",{className:"text-2xl font-bold",children:["النتائج (",v.length,")"]}),v.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:v.map(t=>e.jsxs("article",{className:"bg-white rounded-lg shadow-md overflow-hidden transition-transform hover:scale-105 duration-300 flex flex-col",children:[e.jsx("img",{src:t.imageUrl,alt:t.name,className:"w-full h-48 object-cover"}),e.jsxs("div",{className:"p-4 flex flex-col flex-grow",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:t.name}),e.jsxs("p",{className:"text-gray-600 mb-4 text-sm",children:[t.address.commune,", ",t.address.wilaya]}),t.distance!==void 0&&e.jsxs("p",{className:"text-sm font-bold text-blue-700 bg-blue-100 rounded-full px-3 py-1 self-start mb-4",children:["~ ",t.distance.toFixed(1)," كم"]}),e.jsx("div",{className:"flex-grow"}),e.jsx(_,{to:`/${h}/profile/${t.numericId}`,className:"block text-center w-full mt-auto bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition-colors",children:"عرض التفاصيل"})]})]},t.id))}):e.jsx("div",{className:"text-center py-10 bg-white rounded-lg shadow",children:e.jsx("p",{className:"text-gray-600 text-lg",children:"لم يتم العثور على مقاهٍ تطابق بحثك."})})]})]}):e.jsxs("div",{className:"text-center py-20",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"لم يتم العثور على الخدمة"}),e.jsx(_,{to:`/${h}/services`,className:"bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700",children:"العودة إلى قائمة الخدمات"})]})};export{ee as default};
