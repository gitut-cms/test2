import{o as O,u as G,c as z,r as l,n as W,j as e,F as P,aE as J,aF as V,aG as Q,aH as X,aI as Y,aJ as ee,aK as te,aL as _}from"./index-DgmZNK3x.js";const se=[{amount:2e3},{amount:5e3},{amount:1e4}],ae=2e3,ne=[{amount:10},{amount:50},{amount:100}],le=10,ie=()=>{const{user:n,refetchUser:D}=O(),{siteSettings:i}=G(),{t}=z(),[I,T]=l.useState([]),[m,R]=l.useState(null),[E,U]=l.useState(!0),b=W(),o=(n==null?void 0:n.countryCode)==="dz",p=o?"DZD":"USD",x=o?"دج":"$",C=o?se:ne,d=o?ae:le,[h,y]=l.useState(C[0].amount),[f,j]=l.useState(""),[N,w]=l.useState(""),[S,r]=l.useState(null),[M,A]=l.useState(0),[u,F]=l.useState(null),[v,L]=l.useState(!1),c=l.useMemo(()=>h||parseInt(f)||0,[h,f]);l.useEffect(()=>{(async()=>{if(n){U(!0);try{const[a,g]=await Promise.all([Y(n.id),ee(n.id)]);T(a),R(g.find(K=>K.status==="Pending")||null)}catch(a){console.error("Failed to fetch billing data:",a),r({type:"error",message:t("billing.errorLoad")})}finally{U(!1)}}})()},[n,M,t]),l.useEffect(()=>{n&&(async()=>{const a=new URLSearchParams(b.search);(a.get("PayerID")||a.get("paymentId"))&&(r({type:"success",message:o?"جاري التحقق من الدفع وتحديث الرصيد...":"Verifying payment and updating balance..."}),await new Promise(g=>setTimeout(g,3e3)),await D(),A(g=>g+1),r({type:"success",message:o?"تم شحن الرصيد بنجاح!":"Balance topped up successfully!"}),window.history.replaceState({},"",b.pathname))})()},[b.search,n,D,o]);const k=s=>{s.target.files&&s.target.files[0]&&F(s.target.files[0])},q=async()=>{if(!n||!c||c<d){r({type:"error",message:t("billing.errorMinAmount",{min:d,currency:x})});return}if(!u){r({type:"error",message:t("billing.errorNoProof")});return}L(!0),r(null);let s;try{r({type:"success",message:t("billing.uploadingProof")}),s=await te(u);const a=await _(n.id,c,p,"CCP",s);r({type:a.success?"success":"error",message:a.message}),a.success&&(y(null),j(""),F(null),A(g=>g+1))}catch(a){console.error("Error creating payment request:",a),r({type:"error",message:t("billing.errorSubmit")})}finally{L(!1)}setTimeout(()=>r(null),5e3)},$=async()=>{if(!n||!(i!=null&&i.payment.paypalEmail)||!c||c<d){r({type:"error",message:t("billing.errorMinAmount",{min:d,currency:x})});return}try{await _(n.id,c,p,"PayPal")}catch{console.warn("Could not create pending request record, proceeding to PayPal anyway.")}const a=`https://www.paypal.com/cgi-bin/webscr?${new URLSearchParams({business:i.payment.paypalEmail,item_name:`Gitut Credits for ${n.email}`,amount:c.toFixed(2),currency_code:"USD",no_shipping:"1",return:window.location.href,cancel_return:window.location.href,cmd:"_xclick",custom:n.id}).toString()}`;window.open(a,"_self")},B=s=>{y(s),j(""),w("")},Z=s=>{const a=s.target.value;j(a),y(null),a&&parseInt(a)<d?w(t("billing.minAmountError",{min:d,currency:x})):w("")},H=s=>{switch(s){case"Paid":return e.jsx("span",{className:"px-2 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full",children:t("billing.statusPaid")});case"Pending":return e.jsx("span",{className:"px-2 py-1 text-xs font-medium text-yellow-800 bg-yellow-100 rounded-full",children:t("billing.statusPending")})}};return E?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(P,{className:"animate-spin text-4xl text-green-600"})}):n?e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-800 mb-6 flex items-center gap-2",children:[e.jsx(J,{className:"text-green-600"}),t("billing.title")]}),S&&e.jsx("div",{className:`p-4 mb-4 rounded-md ${S.type==="success"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:S.message}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-gradient-to-br from-green-500 to-green-700 text-white p-6 rounded-lg shadow-lg col-span-2",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2 opacity-90",children:t("billing.currentBalance")}),e.jsxs("div",{className:"text-5xl font-bold font-mono flex items-baseline gap-2",children:[n.credits.amount.toLocaleString("en-US",{minimumFractionDigits:p==="USD"?2:0}),e.jsx("span",{className:"text-2xl opacity-80",children:x})]}),e.jsx("p",{className:"mt-2 opacity-80 text-sm",children:t("billing.balanceDescription")})]}),m&&e.jsxs("div",{className:"bg-yellow-50 p-6 rounded-lg border border-yellow-200 shadow-sm",children:[e.jsxs("h2",{className:"text-xl font-semibold text-yellow-800 flex items-center gap-2",children:[e.jsx(V,{})," ",t("billing.pendingRequestTitle")]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("p",{className:"text-yellow-900 font-bold text-lg",children:[m.amount.toLocaleString()," ",m.currency==="USD"?"$":"دج"]}),e.jsx("p",{className:"text-yellow-700 text-sm mt-1",children:t("billing.pendingRequestMessage",{amount:"",currency:"",date:(typeof m.date=="string"?new Date(m.date):m.date.toDate()).toLocaleDateString(o?"ar-DZ":"en-US")})}),e.jsx("span",{className:"inline-block mt-3 px-3 py-1 bg-yellow-200 text-yellow-800 rounded-full text-xs font-bold",children:m.method})]})]})]}),!m&&e.jsxs("div",{className:"bg-white p-6 rounded-lg border shadow-sm mb-8",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2",children:[e.jsx(Q,{})," ",t("billing.topUpTitle")]}),e.jsx("p",{className:"text-gray-600 mb-4",children:t("billing.step1Title")}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6",children:C.map(s=>e.jsx("button",{onClick:()=>B(s.amount),className:`p-4 border-2 rounded-xl text-center transition-all duration-200 ${h===s.amount?"border-green-500 bg-green-50 ring-2 ring-green-300 transform scale-105":"border-gray-200 bg-gray-50 hover:border-green-300 hover:bg-white"}`,children:e.jsxs("p",{className:"text-2xl font-bold font-mono text-gray-800",children:[s.amount.toLocaleString()," ",e.jsx("small",{className:"text-gray-500 text-lg",children:x})]})},s.amount))}),e.jsxs("div",{className:"mb-6 max-w-sm",children:[e.jsx("label",{htmlFor:"customAmount",className:"block text-sm font-medium text-gray-700 mb-2",children:t("billing.customAmountLabel")}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",id:"customAmount",value:f,onChange:Z,placeholder:t("billing.customAmountPlaceholder",{min:d,currency:x}),min:d,className:`block w-full pl-4 pr-12 py-3 bg-white border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 transition-all ${N?"border-red-500 focus:ring-red-200":"border-gray-300"}`}),e.jsx("span",{className:"absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold",children:x})]}),N&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:N})]}),c>=d&&e.jsx("div",{className:"bg-gray-50 p-6 rounded-xl border border-gray-200 animate-fadeIn",children:o?e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800 mb-3 border-b pb-2",children:t("billing.step2Title")}),e.jsx("p",{className:"text-gray-700 mb-4",dangerouslySetInnerHTML:{__html:t("billing.paymentInstructionDzd",{amount:c.toLocaleString("ar-DZ")})}}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-gray-200 shadow-sm mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-gray-500 text-sm",children:t("billing.recipientName")}),e.jsx("span",{className:"font-bold text-gray-800",children:i==null?void 0:i.payment.baridiMob})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-500 text-sm",children:t("billing.ccpLabel")}),e.jsx("span",{className:"font-bold text-lg text-gray-800 font-mono tracking-wider",children:i==null?void 0:i.payment.ccp})]})]}),e.jsx("h3",{className:"text-lg font-bold text-gray-800 mb-3 border-b pb-2",children:t("billing.step3Title")}),e.jsx("p",{className:"text-gray-700 mb-4 text-sm",children:t("billing.proofInstruction")}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-4 mb-6",children:[e.jsxs("label",{className:`flex-grow w-full sm:w-auto flex items-center justify-center gap-2 bg-white border-2 border-dashed ${u?"border-green-500 bg-green-50":"border-gray-300"} text-gray-700 font-semibold py-4 px-6 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer`,children:[e.jsx("span",{children:u?t("billing.fileSelected",{fileName:u.name}):t("billing.chooseFile")}),e.jsx("input",{type:"file",accept:"image/*",onChange:k,className:"hidden"})]}),u&&e.jsx("div",{className:"h-16 w-16 rounded-lg overflow-hidden border border-gray-200 shadow-sm flex-shrink-0",children:e.jsx("img",{src:URL.createObjectURL(u),alt:"Preview",className:"w-full h-full object-cover"})})]}),e.jsx("h3",{className:"text-lg font-bold text-gray-800 mb-3 border-b pb-2",children:t("billing.step4Title")}),e.jsx("p",{className:"text-gray-700 mb-4 text-sm",children:t("billing.confirmInstruction")}),e.jsxs("button",{onClick:q,disabled:v,className:"w-full bg-green-600 text-white font-bold py-4 px-6 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-wait flex items-center justify-center gap-2 shadow-lg transition-transform hover:-translate-y-1",children:[v?e.jsx(P,{className:"animate-spin"}):null,t(v?"billing.uploading":"billing.confirmButton")]})]}):e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800 mb-3 border-b pb-2",children:t("billing.step2PaypalTitle")}),e.jsx("p",{className:"text-gray-700 mb-6",dangerouslySetInnerHTML:{__html:t("billing.paypalInstruction",{amount:c.toFixed(2)})}}),e.jsxs("button",{onClick:$,className:"w-full flex items-center justify-center gap-3 bg-[#0070BA] text-white font-bold py-4 px-6 rounded-lg hover:bg-[#003087] shadow-lg transition-transform hover:-translate-y-1",children:[e.jsx(X,{size:28}),e.jsx("span",{className:"text-lg",children:t("billing.payWithPaypal")})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-center gap-2 text-xs text-gray-500",children:[e.jsx(P,{className:"animate-spin opacity-0"})," ",e.jsx("p",{children:t("billing.paypalNote")})]})]})})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg border shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-4",children:t("billing.historyTitle")}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-right",children:[e.jsx("thead",{className:"bg-gray-50 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:t("billing.tableInvoiceId")}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:t("billing.tableDate")}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:t("billing.tableAmount")}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:t("billing.tableStatus")})]})}),e.jsx("tbody",{children:I.length>0?I.map(s=>e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsxs("td",{className:"p-3 text-gray-800 text-sm font-mono",children:[s.id.substring(0,8),"..."]}),e.jsx("td",{className:"p-3 text-gray-600",children:(typeof s.date=="string"?new Date(s.date):s.date.toDate()).toLocaleDateString(o?"ar-DZ":"en-US")}),e.jsxs("td",{className:"p-3 text-gray-800 font-bold",children:[s.amount.toLocaleString()," ",s.currency==="USD"?"$":"دج"]}),e.jsx("td",{className:"p-3",children:H(s.status)})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"text-center p-8 text-gray-500",children:t("billing.noHistory")})})})]})})]})]}):e.jsx("div",{children:t("app.error.message")})};export{ie as default};
