import{l as I,p as ee,a as te,u as se,m as ae,r as h,j as e,i as V,a0 as le,Q as oe,_ as G,a1 as ne,Z as re,a2 as ie,a3 as ce,X as de,a4 as ue,$ as me,a5 as pe,w as xe}from"./index-DrB1YgVl.js";import"https://esm.sh/html-docx-js-typescript@0.1.5";import"https://esm.sh/file-saver@2.0.5";const N=y=>y?y.map(j=>typeof j=="string"?{value:j,label:j}:j):[],C=({onResult:y,isSelect:j,options:P})=>{const[w,g]=h.useState(!1),u=h.useRef(null),$=()=>{var n;const b=window.SpeechRecognition||window.webkitSpeechRecognition;if(!b){alert("المتصفح لا يدعم التعرف على الصوت.");return}if(w){(n=u.current)==null||n.stop();return}const x=new b;x.lang="ar-SA",x.continuous=!1,x.interimResults=!1,x.onstart=()=>g(!0),x.onend=()=>g(!1),x.onresult=S=>{const m=S.results[0][0].transcript.trim();if(j&&P){const E=P.find(D=>D.label.toLowerCase().includes(m.toLowerCase())||D.value.toLowerCase().includes(m.toLowerCase()));E&&y(E.value)}else y(m)},u.current=x,x.start()};return e.jsx("button",{type:"button",onClick:$,className:`absolute left-2 top-1/2 -translate-y-1/2 p-2 rounded-full transition-all z-10 ${w?"bg-red-500 text-white animate-pulse scale-110 shadow-lg":"text-gray-400 hover:text-green-600 hover:bg-gray-100"}`,title:"إدخال صوتي",children:w?e.jsx(pe,{size:14}):e.jsx(xe,{size:14})})},fe=()=>{var q,A,M;const y=I(),j=ee(),{fullDocuments:P,loading:w,siteSettings:g}=te(),{user:u,updateUserCredits:$}=se(),{t:b}=ae(),x=(q=y.state)==null?void 0:q.selectedDocId,[n,S]=h.useState(null),[m,E]=h.useState({}),[D,F]=h.useState({}),[_,L]=h.useState(!1),[O,k]=h.useState(""),[K,H]=h.useState(!1),[Q,U]=h.useState(!1);h.useEffect(()=>{w||(async()=>{if(!x)return;const a=P.find(t=>t.id===x);if(a&&a.requiredFields&&a.requiredFields.length>0&&(S(a),a.previewTemplateHtml?k(a.previewTemplateHtml):a.previewTemplateUrl&&(H(!0),fetch(de(a.previewTemplateUrl)).then(t=>t.text()).then(t=>k(t)).catch(t=>console.error("Failed to load preview template",t)).finally(()=>H(!1))),a.complexFields)){const t={};a.complexFields.forEach(l=>{t[l.id]=[{}]}),F(t)}U(!0);try{const t=(a==null?void 0:a.slug)||x,l=(a==null?void 0:a.countryCode)||(u==null?void 0:u.countryCode)||"global";let o=`https://datas.gitut.com/data/json/documents/${t}.json`;l&&l!=="global"&&(o=`https://datas.gitut.com/data/json/documents/${l}/${t}.json`);const i=await fetch(o);if(i.ok){const d=await i.json();if(S(d),d.previewTemplateHtml&&k(d.previewTemplateHtml),d.complexFields){const p={};d.complexFields.forEach(c=>{p[c.id]=D[c.id]||[{}]}),F(p)}}}catch(t){console.warn("Could not fetch fresh document JSON, using context data.",t)}finally{U(!1)}})()},[P,x,w,u==null?void 0:u.countryCode]);const R=h.useMemo(()=>{const s=new Set;return n!=null&&n.fieldCustomizations&&Object.values(n.fieldCustomizations).forEach(a=>{a.type==="select"&&a.options&&N(a.options).forEach(t=>{t.mappedValues&&Object.keys(t.mappedValues).forEach(l=>s.add(l))})}),s},[n]),f=(s,a)=>{let t={...m,[s]:a};if(n&&n.fieldCustomizations&&n.fieldCustomizations[s]){const l=n.fieldCustomizations[s];if(l.type==="select"&&l.options){const i=N(l.options).find(d=>d.value===a);i&&i.mappedValues&&(t={...t,...i.mappedValues})}}E(t)};h.useEffect(()=>{if(!n)return;const s={...m};n.fieldCustomizations&&Object.entries(n.fieldCustomizations).forEach(([o,i])=>{if(i.type==="select"&&i.options){const d=m[o];if(d){const c=N(i.options).find(v=>v.value===d);if(c&&c.outputTemplate){let v=c.outputTemplate;const z=`${o}_sub`,r=m[z]||"";v=v.replace("{subValue}",r),v=v.replace("{self}",c.label),s[o]=v}else c&&(s[o]=c.label)}}});let a=n.previewTemplateHtml||O;if(!a)return;Object.keys(s).forEach(o=>{const i=new RegExp(`\\[${o}\\]`,"g");a=a.replace(i,s[o]||"")});const l=new Date().toLocaleDateString("ar-DZ");if(a=a.replace(/\[DateToday\]/g,l),a.includes("[profilePicture]")){const i=`<img src="${s.profilePicture||"https://via.placeholder.com/150?text=Photo"}" alt="Profile" style="width: 100px; height: 100px; object-fit: cover; border: 1px solid #ccc; display:block; margin: 0 auto;">`;a=a.replace(/\[profilePicture\]/g,i)}k(a)},[m,n,O]);const B=s=>{F(a=>({...a,[s]:[...a[s]||[],{}]}))},Z=(s,a)=>{F(t=>({...t,[s]:(t[s]||[]).filter((l,o)=>o!==a)}))},T=(s,a,t,l)=>{F(o=>{const i=[...o[s]||[]];return i[a]={...i[a],[t]:l},{...o,[s]:i}})},J=async()=>{if(!n||!u||!g)return;L(!0);const s=u.credits.currency==="USD"?g.pricing.dynamicDocument.usd:g.pricing.dynamicDocument.dzd;try{const a=await ue(u,s);if(!a.success){alert(a.message||b("app.error.insufficientBalance")),L(!1);return}$(u.credits.amount-s);const t={...m};n.fieldCustomizations&&Object.entries(n.fieldCustomizations).forEach(([l,o])=>{if(o.type==="select"&&o.options){const i=m[l];if(i){const p=N(o.options).find(c=>c.value===i);if(p&&p.outputTemplate){const c=m[`${l}_sub`]||"";t[l]=p.outputTemplate.replace("{subValue}",c).replace("{self}",p.label)}}}}),n.complexFields&&n.complexFields.forEach(l=>{const o=D[l.id]||[];if(o.length>0){let i='<table style="width:100%; border-collapse: collapse; margin: 20px 0; font-size: 14pt;"><thead><tr>';l.itemFields.forEach(p=>{i+=`<th style="border:1px solid #000; padding: 8px; background: #f0f0f0; text-align: center;">${p.label}</th>`}),i+="</tr></thead><tbody>",o.forEach(p=>{i+="<tr>",l.itemFields.forEach(c=>{i+=`<td style="border:1px solid #000; padding: 8px; text-align: center;">${p[c.id]||""}</td>`}),i+="</tr>"}),i+="</tbody></table>";const d=l.templatePlaceholder.replace(/[\[\]]/g,"");t[d]=i}}),await me([n],n.id,t,{action:"print",targetLang:"ar",templateType:"final"})}catch(a){console.error("Print/Deduction error:",a),alert("حدث خطأ أثناء العملية.")}finally{L(!1)}},X=h.useMemo(()=>{if(!n)return[];const s=new Set,a=[];return n.fieldCustomizations&&Object.keys(n.fieldCustomizations).forEach(t=>{!R.has(t)&&t!=="profilePicture"&&t!=="DateToday"&&(a.push(t),s.add(t))}),(n.requiredFields||[]).forEach(t=>{t==="DateToday"||t==="profilePicture"||s.has(t)||R.has(t)||n.complexFields&&n.complexFields.some(l=>l.templatePlaceholder.includes(t))||(a.push(t),s.add(t))}),a},[n,R]);if(w||Q&&!n)return e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx(V,{className:"animate-spin text-4xl text-green-600"})});if(!x||!n)return e.jsxs("div",{className:"text-center py-20",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-700 mb-4",children:"لم يتم تحديد مستند"}),e.jsx("button",{onClick:()=>j("/app"),className:"text-blue-600 hover:underline",children:"العودة للوحة التحكم"})]});const W=(u==null?void 0:u.credits.currency)==="USD"?"$":"دج",Y=(u==null?void 0:u.credits.currency)==="USD"?g==null?void 0:g.pricing.dynamicDocument.usd:g==null?void 0:g.pricing.dynamicDocument.dzd;return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>j("/app"),className:"text-gray-500 hover:text-gray-700",children:e.jsx(le,{})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:b("generateDocumentPage.createTitle",{docName:n.name})}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["تكلفة الإنشاء: ",e.jsxs("span",{className:"font-bold text-green-600",children:[Y," ",W]})]})]})]}),e.jsxs("button",{onClick:J,disabled:_,className:"flex items-center gap-2 bg-green-600 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition-all shadow-md active:scale-95",children:[_?e.jsx(V,{className:"animate-spin"}):e.jsx(oe,{}),e.jsx("span",{children:b("generateDocumentPage.buttons.print")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-full",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white rounded-lg shadow-md border p-6 overflow-y-auto h-[85vh]",children:[e.jsx("h2",{className:"text-lg font-bold mb-4 text-gray-700 border-b pb-2",children:b("generateDocumentPage.fillDataTitle")}),e.jsxs("div",{className:"space-y-6",children:[(((A=n.requiredFields)==null?void 0:A.includes("profilePicture"))||((M=n.fieldCustomizations)==null?void 0:M.profilePicture))&&e.jsxs("div",{className:"relative group",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:G.profilePicture}),e.jsx(ne,{value:m.profilePicture||"",onChange:s=>f("profilePicture",s)})]}),X.map(s=>{var v,z;const a=s,t=re[a],l=(v=n.fieldCustomizations)==null?void 0:v[a];let o=(l==null?void 0:l.customQuestion)||((z=n.questions)==null?void 0:z[a]);!o&&t&&(o=b(t.label),o===t.label&&(o=G[a]||t.label)),o||(o=s);const i=(l==null?void 0:l.type)||(t==null?void 0:t.type)||"text";let d;l!=null&&l.options?d=N(l.options):t!=null&&t.options&&(d=t.options.map(r=>({value:r.value,label:b(r.label)})));const p=d==null?void 0:d.find(r=>r.value===m[s]),c=p==null?void 0:p.subField;return e.jsxs("div",{className:"space-y-3 relative group",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:o})}),e.jsx("div",{className:"relative",children:i==="select"&&d?e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:m[s]||"",onChange:r=>f(s,r.target.value),className:"w-full p-2 pl-12 border rounded-md focus:ring-2 focus:ring-green-500 outline-none transition-shadow bg-white",children:[e.jsx("option",{value:"",children:b("formPage.selectOption")}),d.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]}),e.jsx(C,{onResult:r=>f(s,r),isSelect:!0,options:d})]}):i==="textarea"?e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{value:m[s]||"",onChange:r=>f(s,r.target.value),className:"w-full p-2 pl-12 border rounded-md focus:ring-2 focus:ring-green-500 outline-none transition-shadow",rows:3}),e.jsx(C,{onResult:r=>f(s,r)})]}):e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:i,value:m[s]||"",onChange:r=>f(s,r.target.value),className:"w-full p-2 pl-12 border rounded-md focus:ring-2 focus:ring-green-500 outline-none transition-shadow"}),e.jsx(C,{onResult:r=>f(s,r)})]})}),c&&e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200 animate-fadeIn ml-4 border-r-4 border-r-blue-400 relative",children:[e.jsx("label",{className:"block text-sm font-bold text-blue-800 mb-1",children:c.customQuestion||c.placeholder||"يرجى التحديد:"}),e.jsx("div",{className:"relative",children:c.type==="select"&&c.options?e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:m[`${s}_sub`]||"",onChange:r=>f(`${s}_sub`,r.target.value),className:"block w-full px-3 py-2 pl-12 bg-white border border-blue-300 rounded-md shadow-sm",children:[e.jsx("option",{value:"",children:"-- اختر --"}),N(c.options).map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]}),e.jsx(C,{onResult:r=>f(`${s}_sub`,r),isSelect:!0,options:N(c.options)})]}):e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:c.type||"text",value:m[`${s}_sub`]||"",onChange:r=>f(`${s}_sub`,r.target.value),placeholder:c.placeholder||"",className:"block w-full px-3 py-2 pl-12 bg-white border border-blue-300 rounded-md shadow-sm"}),e.jsx(C,{onResult:r=>f(`${s}_sub`,r)})]})})]})]},s)}),n.complexFields&&n.complexFields.map(s=>e.jsxs("div",{className:"border-2 border-blue-100 p-4 rounded-lg bg-blue-50 mt-6",children:[e.jsx("label",{className:"block font-bold text-gray-800 mb-3 border-b border-blue-200 pb-2",children:s.label}),e.jsx("div",{className:"space-y-3",children:(D[s.id]||[]).map((a,t)=>e.jsxs("div",{className:"bg-white p-3 rounded shadow-sm border relative",children:[e.jsx("button",{onClick:()=>Z(s.id,t),className:"absolute top-2 left-2 text-red-400 hover:text-red-600",children:e.jsx(ie,{size:12})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 pr-4",children:s.itemFields.map(l=>e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:l.label}),l.type==="select"&&l.options?e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:a[l.id]||"",onChange:o=>T(s.id,t,l.id,o.target.value),className:"w-full p-1 pl-10 border rounded text-sm bg-white",children:[e.jsx("option",{value:"",children:"-- اختر --"}),l.options.map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))]}),e.jsx(C,{onResult:o=>T(s.id,t,l.id,o),isSelect:!0,options:l.options})]}):e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:l.type||"text",value:a[l.id]||"",onChange:o=>T(s.id,t,l.id,o.target.value),className:"w-full p-1 pl-10 border rounded text-sm"}),e.jsx(C,{onResult:o=>T(s.id,t,l.id,o)})]})]},l.id))})]},t))}),e.jsxs("button",{onClick:()=>B(s.id),className:"mt-3 text-sm flex items-center gap-1 text-blue-600 font-semibold hover:text-blue-800",children:[e.jsx(ce,{})," ",s.addItemButtonLabel||"إضافة عنصر جديد"]})]},s.id))]})]}),e.jsxs("div",{className:"lg:col-span-2 bg-gray-100 rounded-lg shadow-inner border p-4 flex flex-col h-[85vh]",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-700 mb-2",children:b("generateDocumentPage.previewTitle")}),K?e.jsx("div",{className:"flex-grow flex items-center justify-center",children:e.jsx(V,{className:"animate-spin text-4xl text-gray-400"})}):e.jsx("iframe",{srcDoc:O+"<style>body { user-select: none; cursor: default; } ::selection { background: none; }</style>",title:"Document Preview",className:"w-full flex-grow border bg-white rounded shadow-sm"})]})]})]})};export{fe as default};
