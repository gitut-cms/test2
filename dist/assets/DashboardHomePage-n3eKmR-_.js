import{u as q,o as H,r as o,c as O,a as Z,b as G,j as e,a5 as J,a6 as W,m as K,f as X,a7 as Y,h as U,a8 as ee,L as v,a9 as Q,d as te,k as se,F as ae,aa as re,ab as ne,Q as le,ac as oe,ad as ie,ae as ce,af as de,ag as xe,E as ue,ah as he,ai as ge}from"./index-hpjxKmld.js";import{A as me}from"./AdBanner-Asof6Iy0.js";const P=a=>a?a.replace(/[أإآ]/g,"ا").replace(/ة/g,"ه").toLowerCase():"",be=({enableMultiSelect:a=!1})=>{const{staticDocuments:y,sites:f}=q(),{user:i}=H(),[r,w]=o.useState([]),{t:A}=O(),[m,S]=o.useState(""),T=Z(),{countryCode:p}=G(),[M,D]=o.useState(!1),x=o.useRef(null),$=window.SpeechRecognition||window.webkitSpeechRecognition,h=!!$,[L,b]=o.useState(!1),[c,k]=o.useState(!1),[g,C]=o.useState(new Set);o.useEffect(()=>{(async()=>{if(i!=null&&i.countryCode)try{const s=await Q(i.countryCode);w(s)}catch(s){console.error(s)}})()},[i==null?void 0:i.countryCode]);const F=o.useMemo(()=>[...r.map(t=>({item:t,type:"doc"})),...y.map(t=>({item:t,type:"staticDoc"})),...f.filter(t=>t.type==="template").map(t=>({item:t,type:"site"}))],[r,y,f]),j=o.useMemo(()=>{if(!m.trim())return[];const t=P(m);return F.filter(({item:s})=>P(s.name).includes(t)||"description"in s&&s.description&&P(s.description).includes(t))},[m,F]);o.useEffect(()=>{if(!h)return;const t=new $;return t.continuous=!1,t.interimResults=!1,t.lang="ar-SA",t.onresult=s=>{const u=s.results[0][0].transcript;S(u)},t.onerror=s=>{console.error("Speech recognition error",s.error)},t.onend=()=>{D(!1)},x.current=t,()=>{x.current&&x.current.abort()}},[h]);const n=()=>{var t,s;if(!h){alert("متصفحك لا يدعم خاصية البحث الصوتي.");return}M?(t=x.current)==null||t.stop():((s=x.current)==null||s.start(),D(!0))},d=(t,s)=>{if(c&&s==="doc"){const u=new Set(g);u.has(t.id)?u.delete(t.id):u.add(t.id),C(u),S("")}},l=()=>{if(g.size===0)return;const t=Array.from(g);T(`/${p}/app/multi-person-job`,{state:{preSelectedDocIds:t}}),C(new Set),k(!1)},I=t=>{if(i){if(i.credits.amount<=0){alert(A("app.error.insufficientBalance"));return}window.open(t.url,"_blank")}},N=o.useMemo(()=>r.filter(t=>g.has(t.id)).map(t=>t.name),[g,r]);return e.jsxs("div",{className:"relative w-full max-w-2xl mx-auto mb-6",children:[e.jsx("div",{className:"flex gap-2 mb-2 justify-end",children:a&&e.jsxs("button",{onClick:()=>{k(!c),C(new Set)},className:`text-xs px-3 py-1 rounded-full border transition-colors flex items-center gap-1 ${c?"bg-blue-100 text-blue-800 border-blue-300":"bg-white text-gray-500 border-gray-300"}`,children:[c?e.jsx(J,{}):e.jsx(W,{}),e.jsx("span",{children:"وضع التحديد المتعدد"})]})}),e.jsxs("form",{onSubmit:t=>t.preventDefault(),className:"relative",children:[e.jsx(K,{className:"absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:c?"ابحث لإضافة مستندات للقائمة...":"ابحث عن مستند أو موقع...",value:m,onChange:t=>S(t.target.value),onFocus:()=>b(!0),onBlur:()=>setTimeout(()=>b(!1),200),className:`w-full p-3 pl-12 pr-12 bg-white border rounded-full focus:outline-none focus:ring-2 ${c?"border-blue-300 focus:ring-blue-500":"border-gray-300 focus:ring-green-500"}`}),h&&e.jsx("button",{type:"button",onClick:n,title:"البحث الصوتي",className:`absolute left-3 top-1/2 -translate-y-1/2 p-2 rounded-full transition-colors ${M?"bg-red-500 text-white animate-pulse":"text-gray-600 hover:bg-gray-100"}`,children:e.jsx(X,{})})]}),c&&g.size>0&&e.jsxs("div",{className:"mt-3 bg-blue-50 border border-blue-200 rounded-lg p-3 animate-fadeIn",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("span",{className:"text-sm font-bold text-blue-800",children:["المستندات المحددة (",g.size,")"]}),e.jsxs("button",{onClick:l,className:"bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-blue-700 flex items-center gap-1",children:["ابدأ التعبئة ",e.jsx(Y,{})]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:N.map(t=>e.jsx("span",{className:"bg-white border border-blue-200 text-blue-700 text-xs px-2 py-1 rounded-full flex items-center gap-1",children:t},t))})]}),L&&j.length>0&&e.jsx("ul",{className:"absolute top-full left-0 right-0 mt-2 bg-white border border-gray-300 rounded-lg shadow-lg z-30 max-h-80 overflow-y-auto",children:j.map(({item:t,type:s})=>{let u=U;const V="description"in t?t.description:t.url||"",E=c&&s==="doc"&&g.has(t.id);s==="doc"?u=U:s==="site"?u=te:s==="staticDoc"&&(u=se);const R=e.jsxs("div",{className:`flex items-center gap-3 px-4 py-3 hover:bg-green-50 cursor-pointer ${E?"bg-blue-50":""}`,children:[e.jsx(u,{className:`h-5 w-5 flex-shrink-0 ${s==="site"?"text-indigo-500":"text-gray-500"}`}),e.jsxs("div",{className:"flex-grow overflow-hidden",children:[e.jsxs("p",{className:"font-semibold text-gray-800 truncate flex items-center gap-2",children:[t.name,E&&e.jsx(J,{className:"text-blue-500"}),s==="site"&&e.jsx(ee,{className:"text-xs text-gray-400"})]}),e.jsx("p",{className:"text-sm text-gray-500 truncate",children:V})]}),c&&s==="doc"&&e.jsx("div",{className:"text-xs bg-gray-100 px-2 py-1 rounded text-gray-600",children:E?"محدد":"اضغط للتحديد"})]});if(c&&s==="doc")return e.jsx("li",{onMouseDown:B=>{B.preventDefault(),d(t,s)},children:R},`${s}-${t.id}`);if(s==="site")return e.jsx("li",{onMouseDown:B=>{B.preventDefault(),I(t)},children:R},`${s}-${t.id}`);let z="",_={};return s==="doc"?(z=`/${p}/app/generate`,_={selectedDocId:t.id}):s==="staticDoc"&&(z=`/${p}/app/view-pdf/${t.id}`),e.jsx("li",{children:e.jsx(v,{to:z,state:_,children:R})},`${s}-${t.id}`)})})]})},fe=({isOpen:a,onClose:y,cafeName:f,numericId:i})=>{const{t:r}=O();if(!a)return null;const w=()=>{window.print()};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-sm relative",children:[e.jsx("div",{className:"p-6",children:e.jsxs("div",{id:"printable-id",className:"text-center p-4",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-800 mb-2",children:f}),i?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"mb-4 text-gray-600",children:r("dashboard.numericIdModal.yourIdIs")}),e.jsx("p",{className:"text-6xl font-bold text-green-600 tracking-widest bg-gray-100 p-4 rounded-lg",children:i}),e.jsx("p",{className:"mt-4 text-gray-500 text-sm",children:r("dashboard.numericIdModal.instruction")})]}):e.jsx("p",{className:"text-lg text-gray-500 my-8",children:r("dashboard.numericIdModal.idUnavailable")})]})}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 flex justify-between items-center",children:[e.jsxs("button",{onClick:w,disabled:!i,className:"flex items-center gap-2 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(ue,{}),e.jsx("span",{children:r("dashboard.numericIdModal.print")})]}),e.jsx("button",{onClick:y,className:"bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600",children:r("dashboard.numericIdModal.close")})]})]})})},ye=()=>{const{user:a}=H(),{sites:y,cafes:f,loading:i}=q(),{t:r}=O(),[w,A]=o.useState([]),[m,S]=o.useState(null),[T,p]=o.useState(!0),[M,D]=o.useState(!1),[x,$]=o.useState([]),[h,L]=o.useState(new Set),[b,c]=o.useState(!1),k=o.useMemo(()=>x.length?b||h.size===0?x:x.filter(n=>h.has(n.id)):[],[x,h,b]);o.useEffect(()=>{(async()=>{if(!(a!=null&&a.cafeId)||i){!i&&!(a!=null&&a.cafeId)&&p(!1);return}p(!0);let d=f.find(l=>l.id===a.cafeId)||null;if(!d)try{d=await ce(a.cafeId)}catch(l){console.error("Failed to fetch cafe details directly:",l)}if(S(d),a.countryCode)try{const l=await Q(a.countryCode);$(l)}catch(l){console.error("Failed to load country documents:",l)}try{const l=await de("favorites"),I=new Set(l.map(N=>N.id));L(I)}catch(l){console.warn("Failed to load favorites",l)}try{const I=(await xe.collection("jobs").where("cafeId","==",a.cafeId).orderBy("createdAt","desc").get()).docs.map(N=>({id:N.id,...N.data()}));A(I)}catch(l){console.error("Failed to fetch dashboard data from Firestore:",l)}finally{p(!1)}})()},[a,f,i]);const g=async(n,d)=>{d.preventDefault(),d.stopPropagation();const l=new Set(h);l.has(n)?(l.delete(n),await he("favorites",n)):(l.add(n),await ge("favorites",{id:n,timestamp:Date.now()})),L(l)};if(i||T)return e.jsx("div",{className:"flex justify-center items-center p-10",children:e.jsx(ae,{className:"animate-spin text-4xl text-green-600"})});if(!m)return e.jsxs("div",{className:"flex flex-col items-center justify-center p-10 text-center",children:[e.jsx("h2",{className:"text-xl font-bold text-red-600 mb-2",children:r("dashboard.error.fatalError")}),e.jsx("p",{className:"text-gray-700",children:r("dashboard.error.cafeDataNotFound")}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:r("dashboard.error.retryLogin")})]});const C=w.filter(n=>n.status==="Pending").length,F=(a==null?void 0:a.credits.currency)==="DZD"?a.credits.amount<50:a.credits.amount<5,j=F?{bg:"bg-red-100",text:"text-red-800",valueText:"text-red-900 font-mono",linkText:"text-red-700"}:{bg:"bg-green-100",text:"text-green-800",valueText:"text-green-900 font-mono",linkText:"text-green-700"};return e.jsxs("div",{className:"space-y-8",children:[a&&m&&e.jsx(fe,{isOpen:M,onClose:()=>D(!1),cafeName:m.name,numericId:m.numericId}),e.jsx(be,{enableMultiSelect:!0}),e.jsx(me,{placement:"DASHBOARD_TOP"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800 mb-2",children:r("dashboard.home.title")}),e.jsx("p",{className:"text-gray-500",children:r("dashboard.home.subtitle")})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs("div",{className:"bg-gray-200 p-6 rounded-lg shadow-sm",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2",children:r("dashboard.stats.pendingJobs")}),e.jsx("p",{className:"text-4xl font-bold text-gray-900",children:C}),e.jsxs(v,{to:"pending-jobs",className:"text-gray-700 hover:underline mt-4 inline-block font-semibold",children:[r("dashboard.links.viewAllJobs")," →"]})]}),e.jsxs("div",{className:"bg-gray-200 p-6 rounded-lg shadow-sm",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2",children:r("dashboard.stats.availableDocs")}),e.jsx("p",{className:"text-4xl font-bold text-gray-900",children:x.length}),e.jsxs(v,{to:"generate",className:"text-gray-700 hover:underline mt-4 inline-block font-semibold",children:[r("dashboard.links.createDoc")," →"]})]}),e.jsxs("div",{className:`${j.bg} p-6 rounded-lg shadow-sm`,children:[e.jsx("h2",{className:`text-lg font-semibold ${j.text} mb-2`,children:r("dashboard.stats.currentBalance")}),e.jsxs("p",{className:`text-3xl font-bold ${j.valueText}`,children:[a==null?void 0:a.credits.amount.toLocaleString("en-US",{minimumFractionDigits:a.credits.currency==="USD"?2:0}),e.jsxs("span",{className:"text-xl",children:[" ",(a==null?void 0:a.credits.currency)==="DZD"?"دج":"$"]})]}),e.jsxs(v,{to:"billing",className:`${j.linkText} hover:underline mt-4 inline-block font-semibold`,children:[r(F?"dashboard.links.topUpNow":"dashboard.links.manageBalance")," →"]})]}),e.jsxs("div",{className:"bg-gray-700 text-white p-6 rounded-lg shadow-sm flex flex-col justify-center items-center",children:[e.jsx("h2",{className:"text-lg font-semibold mb-2",children:r("dashboard.idCard.title")}),e.jsx("p",{className:"text-sm text-center text-gray-300 mb-3",children:r("dashboard.idCard.subtitle")}),e.jsxs("button",{onClick:()=>D(!0),className:"w-full bg-white text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center gap-2",children:[e.jsx(re,{}),e.jsx("span",{children:r("dashboard.idCard.button")})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:r("dashboard.sections.docsTitle")}),e.jsxs("button",{onClick:()=>c(!b),className:"flex items-center gap-2 text-sm font-semibold text-blue-600 hover:text-blue-800",children:[b?e.jsx(ne,{}):e.jsx(le,{}),e.jsx("span",{children:b?"إظهار المفضلة فقط":"إظهار كل المستندات"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[k.map(n=>e.jsxs(v,{to:"generate",state:{selectedDocId:n.id},className:"relative group block text-right p-4 border rounded-lg transition-all duration-200 bg-white hover:bg-green-50 hover:shadow-md hover:border-green-400",children:[e.jsx("div",{className:"absolute top-2 left-2 z-10 opacity-100",children:e.jsx("button",{onClick:d=>g(n.id,d),className:"text-gray-400 hover:text-yellow-500 focus:outline-none transition-colors",children:h.has(n.id)?e.jsx(oe,{className:"text-yellow-500"}):e.jsx(ie,{})})}),e.jsx("h3",{className:"font-bold text-lg text-gray-800 pr-2",children:n.name}),e.jsx("p",{className:"text-gray-600 text-sm mt-1 line-clamp-2",dangerouslySetInnerHTML:{__html:n.description}})]},n.id)),k.length===0&&e.jsxs("div",{className:"col-span-full text-center py-10 text-gray-500 bg-gray-50 rounded-lg border border-dashed",children:[e.jsx("p",{children:"لم تقم بإضافة أي مستندات للمفضلة بعد."}),e.jsx("button",{onClick:()=>c(!0),className:"text-blue-600 hover:underline mt-2",children:"عرض كل المستندات"})]})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:r("dashboard.sections.sitesTitle")}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:y.map(n=>{const d="block text-right p-4 border rounded-lg transition-all duration-200 bg-white hover:bg-green-50 hover:shadow-md hover:border-green-400",l=e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-green-600",fill:"none",viewBox:"0 0 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-lg text-gray-800",children:n.name}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:n.type==="static"?r("dashboard.sites.openLink"):r("dashboard.sites.fillFormFor",{url:n.url})})]})]});return n.type==="template"?e.jsx(v,{to:`fill-site/${n.id}`,className:d,children:l},n.id):e.jsx("a",{href:n.url,target:"_blank",rel:"noopener noreferrer",className:d,children:l},n.id)})})]})]})]})};export{ye as default};
