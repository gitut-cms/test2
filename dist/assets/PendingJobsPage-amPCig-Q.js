import{o as E,u as k,c as q,r as o,af as z,j as e,F as P,aj as F,ak as B,J as M,l as O,h as U,ag as _,m as Q,al as R}from"./index-DgmZNK3x.js";import{g as V}from"./doc-generator-BSuTvlLC.js";import{c as J}from"./fileUtils-Cb1IM2ig.js";import{F as W,f as y}from"./constants-DfStgaks.js";import"./geminiService-CD7J7Ty3.js";const Y=()=>{const{user:d}=E(),{documents:f,fullDocuments:u,sites:v}=k(),{t:l}=q(),[c,D]=o.useState([]),[b,I]=o.useState(null),[C,h]=o.useState(!0),[p,w]=o.useState(!1),[m,S]=o.useState("Pending");o.useEffect(()=>{if(!(d!=null&&d.cafeId))return;h(!0);const s=z.collection("jobs").where("cafeId","==",d.cafeId).orderBy("createdAt","desc").onSnapshot(t=>{const a=t.docs.map(n=>({id:n.id,...n.data()}));D(a),h(!1)},t=>{console.error("Error fetching jobs:",t),h(!1)});return()=>s()},[d==null?void 0:d.cafeId]);const x=o.useMemo(()=>m==="All"?c:c.filter(s=>s.status===m),[c,m]),r=o.useMemo(()=>c.find(s=>s.id===b)||null,[c,b]),$=s=>{const t=f.find(n=>n.id===s)||u.find(n=>n.id===s);if(t)return t.name;const a=v.find(n=>n.id===s);return a?a.name:l("pendingJobsPage.unknownDoc")},j=s=>s?s.fullName&&typeof s.fullName=="string"&&s.fullName.trim()!==""?s.fullName:s.firstName||s.lastName?`${s.firstName||""} ${s.lastName||""}`.trim():s.firstNameFr||s.lastNameFr?`${s.firstNameFr||""} ${s.lastNameFr||""}`.trim():l("pendingJobsPage.visitorFallback"):l("pendingJobsPage.visitorFallback"),L=(s,t)=>{if(t.documentIds&&t.documentIds.length>0){const g=[...f,...u].filter(i=>t.documentIds.includes(i.id));for(const i of g){if(i.fieldCustomizations&&i.fieldCustomizations[s]&&i.fieldCustomizations[s].customQuestion)return i.fieldCustomizations[s].customQuestion;if(i.questions&&i.questions[s])return i.questions[s]}}const a=W[s];if(a){const n=l(a.label);return(n===a.label||n.includes("."))&&y[s]||n}return y[s]?y[s]:s},N=async s=>{if(r)try{await R(r.id,{status:s})}catch(t){console.error("Failed to update status:",t),alert("فشل تحديث حالة الطلب")}},A=async()=>{if(!(!r||!r.documentIds||r.documentIds.length===0)){w(!0);try{const s=[...u,...f];for(const t of r.documentIds)if(s.some(n=>n.id===t))await V(s,t,r.visitorData||{},{action:"open",targetLang:"ar",templateType:"final"});else{const n=v.find(g=>g.id===t);n&&(alert(l("multiPersonJobPage.alerts.extensionFill",{siteName:n.name,personName:j(r.visitorData)})),window.open(n.url,"_blank"))}r.status==="Pending"&&await N("Completed"),alert(l("pendingJobsPage.alerts.confirmSuccess",{count:r.documentIds.length}))}catch(s){console.error("Print error:",s),alert(l("pendingJobsPage.alerts.completeFail"))}finally{w(!1)}}},T=s=>new Date(s).toLocaleString("ar-DZ",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"});return C?e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx(P,{className:"animate-spin text-4xl text-green-600"})}):e.jsxs("div",{className:"flex flex-col h-[calc(100vh-100px)]",children:[e.jsxs("header",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:l("pendingJobsPage.title")}),e.jsx("p",{className:"text-gray-500 text-sm",children:m==="Pending"?`لديك ${x.length} طلبات معلقة`:`عرض ${x.length} طلبات`})]}),e.jsx("div",{className:"flex gap-2",children:["All","Pending","Completed","Cancelled"].map(s=>e.jsx("button",{onClick:()=>S(s),className:`px-4 py-2 rounded-lg text-sm font-bold transition-colors ${m===s?"bg-blue-600 text-white":"bg-white text-gray-600 border hover:bg-gray-50"}`,children:s==="All"?"الكل":l(`pendingJobsPage.status.${s.toLowerCase()}`)||s},s))})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6 h-full overflow-hidden",children:[e.jsxs("aside",{className:"w-full lg:w-1/3 bg-white border rounded-lg shadow-sm overflow-hidden flex flex-col",children:[e.jsx("div",{className:"p-4 border-b bg-gray-50",children:e.jsx("h2",{className:"font-bold text-gray-700",children:l("pendingJobsPage.listTitle")})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-2",children:x.length===0?e.jsx("div",{className:"text-center py-10 text-gray-500",children:l("pendingJobsPage.noJobs")}):x.map(s=>{var t;return e.jsxs("button",{onClick:()=>I(s.id),className:`w-full text-right p-4 rounded-lg border transition-all hover:shadow-md flex justify-between items-center ${b===s.id?"bg-blue-50 border-blue-500 ring-1 ring-blue-500":"bg-white border-gray-200 hover:border-blue-300"}`,children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(F,{className:"text-gray-400"}),e.jsx("span",{className:"font-bold text-gray-800",children:j(s.visitorData)})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsx(B,{}),e.jsx("span",{children:T(s.createdAt)})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${s.status==="Pending"?"bg-yellow-100 text-yellow-800":s.status==="Completed"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:l(`pendingJobsPage.status.${s.status.toLowerCase()}`)}),((t=s.documentIds)==null?void 0:t.length)>0&&e.jsxs("span",{className:"text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded",children:[s.documentIds.length," مستند"]})]})]},s.id)})})]}),e.jsx("main",{className:"flex-1 bg-white border rounded-lg shadow-sm overflow-hidden flex flex-col",children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-6 border-b flex justify-between items-start bg-gray-50",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-1",children:j(r.visitorData)}),e.jsxs("p",{className:"text-gray-500 text-sm",children:["ID: ",r.id]})]}),e.jsx("div",{className:"flex gap-2",children:r.status==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>N("Completed"),className:"flex items-center gap-2 px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 font-semibold",title:"تحديد كمكتمل (دون طباعة)",children:[e.jsx(M,{})," ",e.jsx("span",{children:"مكتمل"})]}),e.jsxs("button",{onClick:()=>N("Cancelled"),className:"flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-semibold",title:"إلغاء الطلب",children:[e.jsx(O,{})," ",e.jsx("span",{children:"إلغاء"})]})]})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-8",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-lg mb-3 flex items-center gap-2",children:[e.jsx(U,{className:"text-blue-500"}),l("pendingJobsPage.requestedDocsTitle")]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:r.documentIds.map((s,t)=>e.jsx("div",{className:"p-4 border rounded-lg bg-blue-50 border-blue-100 text-blue-900 font-medium",children:$(s)},t))})]}),r.visitorData&&Object.keys(r.visitorData).length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-lg mb-3 flex items-center gap-2",children:[e.jsx(F,{className:"text-green-500"}),l("pendingJobsPage.customerInfoTitle")]}),e.jsx("div",{className:"bg-gray-50 rounded-lg border p-1",children:e.jsx("table",{className:"w-full text-sm",children:e.jsx("tbody",{children:Object.entries(r.visitorData).map(([s,t],a)=>{if(!t)return null;const n=L(s,r),g=s==="profilePicture"||typeof t=="string"&&t.startsWith("data:image");return e.jsxs("tr",{className:a%2===0?"bg-white":"bg-gray-50",children:[e.jsx("td",{className:"p-3 font-semibold text-gray-600 border-b w-1/3",children:n}),e.jsx("td",{className:"p-3 text-gray-800 border-b",children:g?e.jsx("img",{src:J(t),alt:n,className:"h-24 w-24 object-cover rounded-md border cursor-pointer hover:scale-105 transition-transform",onClick:()=>window.open(J(t),"_blank")}):e.jsx("span",{className:"whitespace-pre-wrap",children:String(t)})})]},s)})})})})]})]}),e.jsx("div",{className:"p-6 border-t bg-gray-50 flex justify-end",children:e.jsxs("button",{onClick:A,disabled:p,className:"flex items-center gap-3 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 shadow-lg transform transition hover:-translate-y-0.5 disabled:bg-gray-400 disabled:transform-none",children:[p?e.jsx(P,{className:"animate-spin"}):e.jsx(_,{}),e.jsx("span",{children:l(p?"pendingJobsPage.confirmButton.generating":"pendingJobsPage.confirmButton.default")})]})})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400 p-8",children:[e.jsx(Q,{className:"text-6xl mb-4 opacity-20"}),e.jsx("p",{className:"text-lg font-medium",children:l("pendingJobsPage.selectJobTitle")}),e.jsx("p",{className:"text-sm",children:l("pendingJobsPage.selectJobSubtitle")})]})})]})]})};export{Y as default};
