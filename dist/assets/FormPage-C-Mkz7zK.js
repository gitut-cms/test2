import{n as _,a as A,b as B,u as G,p as H,c as J,r,j as n,F as W}from"./index-hpjxKmld.js";import{F as q,f as X}from"./constants-DfStgaks.js";const C=g=>g?g.map(h=>typeof h=="string"?{value:h,label:h}:h):[],ce=()=>{const g=_();A();const{countryCode:h}=B(),{documents:E,sites:Y,cafes:v,loading:N}=G(),{cafeId:b,selectedDocIds:d}=g.state||{cafeId:null,selectedDocIds:[]},{usePresence:M}=H(),{isOnline:Z}=M(b),{t:j}=J(),[ee,R]=r.useState(),[S,V]=r.useState({}),[f,D]=r.useState(0),[se,te]=r.useState(""),[ae,ne]=r.useState(!1),[ie,le]=r.useState(!1),[I,z]=r.useState("filling"),[F,K]=r.useState([]),[T,P]=r.useState(!1),L=r.useRef(new Set);r.useEffect(()=>{b&&v.length>0&&R(v.find(e=>e.id===b))},[b,v]),r.useEffect(()=>{N||(async()=>{if(!d||d.length===0)return;const a=d.filter(i=>!F.find(s=>s.id===i)&&!L.current.has(i));if(a.length===0)return;P(!0),a.forEach(i=>L.current.add(i));const t=[];await Promise.all(a.map(async i=>{var c,l;const s=E.find(o=>o.id===i);if(s){const o=s.slug||s.id,x=s.countryCode||"global";let y=`https://datas.gitut.com/data/json/documents/${x!=="global"?x+"/":""}${o}.json`;try{const w=await fetch(y);if(w.ok){const U=await w.json();t.push({...U,id:s.id})}else(c=s.requiredFields)!=null&&c.length&&t.push(s)}catch{(l=s.requiredFields)!=null&&l.length&&t.push(s)}}})),t.length>0&&K(i=>[...i,...t]),P(!1)})()},[d,E,N]);const m=r.useMemo(()=>F.filter(e=>d==null?void 0:d.includes(e.id)),[F,d]),O=r.useMemo(()=>{const e=new Set;return m.forEach(a=>{a.fieldCustomizations&&Object.values(a.fieldCustomizations).forEach(t=>{t.type==="select"&&t.options&&C(t.options).forEach(i=>{i.mappedValues&&Object.keys(i.mappedValues).forEach(s=>e.add(s))})})}),e},[m]),p=r.useMemo(()=>{const e=[],a=new Set;return m.forEach(t=>{new Set([...t.requiredFields||[],...Object.keys(t.fieldCustomizations||{})]).forEach(s=>{var x,y;if(s==="profilePicture"||s==="DateToday"||a.has(s)||O.has(s))return;const c=(x=t.fieldCustomizations)==null?void 0:x[s],l=q[s];let o=(c==null?void 0:c.customQuestion)||((y=t.questions)==null?void 0:y[s])||(l?j(l.label):s);o===(l==null?void 0:l.label)&&(o=X[s]||o),e.push({id:s,label:o}),a.add(s)})}),e},[m,O,j]),u=r.useMemo(()=>{var c,l;const e=p[f];if(!e)return null;let a;for(const o of m)if((c=o.fieldCustomizations)!=null&&c[e.id]){a=o.fieldCustomizations[e.id];break}const t=q[e.id],i=(a==null?void 0:a.type)||(t==null?void 0:t.type)||"text",s=a!=null&&a.options?C(a.options):(l=t==null?void 0:t.options)==null?void 0:l.map(o=>({value:o.value,label:j(o.label)}));return{id:e.id,question:e.label,type:i,options:s,placeholder:(a==null?void 0:a.placeholder)||(t==null?void 0:t.placeholder)||e.id}},[f,p,m,j]),$=()=>{f===p.length-1?z("finished"):D(e=>e+1)},Q=()=>{f>0&&D(e=>e-1)},k=(e,a)=>{let t={...S,[e]:a};m.forEach(i=>{var c;const s=(c=i.fieldCustomizations)==null?void 0:c[e];if((s==null?void 0:s.type)==="select"&&s.options){const l=C(s.options).find(o=>o.value===a);l!=null&&l.mappedValues&&Object.assign(t,l.mappedValues)}}),V(t)};return N||T?n.jsx("div",{className:"text-center py-20",children:n.jsx(W,{className:"animate-spin text-4xl text-green-600"})}):n.jsx("div",{className:"max-w-3xl mx-auto",children:n.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 md:p-8",children:[n.jsx("div",{className:"mb-6 border-b pb-6 flex justify-between items-center",children:n.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"تعبئة النموذج"})}),I==="filling"&&u?n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"text-center",children:[n.jsxs("p",{className:"text-sm font-semibold text-gray-500",children:["الخطوة ",f+1," من ",p.length]}),n.jsx("h2",{className:"text-2xl font-bold text-gray-800 mt-1",children:u.question})]}),n.jsx("div",{className:"relative",children:u.type==="select"&&u.options?n.jsxs("select",{value:S[u.id]||"",onChange:e=>k(u.id,e.target.value),className:"w-full h-16 p-4 border-2 rounded-lg",children:[n.jsx("option",{value:"",children:"-- اختر --"}),u.options.map(e=>n.jsx("option",{value:e.value,children:e.label},e.value))]}):n.jsx("textarea",{value:S[u.id]||"",onChange:e=>k(u.id,e.target.value),className:"w-full h-28 p-4 border-2 rounded-lg"})}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("button",{onClick:Q,disabled:f===0,className:"bg-gray-200 px-6 py-3 rounded-lg",children:"السابق"}),n.jsx("button",{onClick:$,className:"bg-green-600 text-white px-6 py-3 rounded-lg",children:f===p.length-1?"مراجعة":"التالي"})]})]}):n.jsx("div",{className:"text-center py-10",children:"اكتمل النموذج. يرجى المراجعة والإرسال."})]})})};export{ce as default};
