import{n as V,a as O,u as M,o as G,c as K,r as x,j as a,F as R,i as q,E as U,H as _,I,am as Q,an as Z,f as B}from"./index-hpjxKmld.js";import{g as J}from"./doc-generator-Ct1URtxh.js";import{F as W,f as X}from"./constants-DfStgaks.js";import"./geminiService-DifXNJPz.js";import"./fileUtils-Cb1IM2ig.js";const C=d=>d?d.map(i=>typeof i=="string"?{value:i,label:i}:i):[],Y=(d,i)=>{if(!i||i.length===0)return"";const b=d.displayType||"table";if(b==="table"){let r='<table style="width:100%; border-collapse: collapse; margin: 10px 0; font-size: 0.9em;"><thead><tr>';return d.itemFields.forEach(c=>{r+=`<th style="border:1px solid #ddd; padding: 4px; background: #f9f9f9;">${c.label}</th>`}),r+="</tr></thead><tbody>",i.forEach(c=>{r+="<tr>",d.itemFields.forEach(j=>{r+=`<td style="border:1px solid #ddd; padding: 4px;">${c[j.id]||""}</td>`}),r+="</tr>"}),r+="</tbody></table>",r}const h=i.map(r=>d.itemFields.map(c=>r[c.id]).filter(c=>c!=null&&c!=="").join(" - ")).filter(r=>r!=="");if(h.length===0)return"";if(b==="comma")return h.join("، ");const y=b==="ol"?"ol":"ul";return`<${y}>${h.map(r=>`<li>${r}</li>`).join("")}</${y}>`},ee=({onResult:d,isSelect:i,options:b})=>{const[h,y]=x.useState(!1),r=x.useRef(null),c=()=>{var l;const j=window.SpeechRecognition||window.webkitSpeechRecognition;if(!j)return;if(h){(l=r.current)==null||l.stop();return}const g=new j;g.lang="ar-SA",g.onstart=()=>y(!0),g.onend=()=>y(!1),g.onresult=N=>{const u=N.results[0][0].transcript.trim();if(i&&b){const F=b.find(v=>v.label.includes(u)||v.value.includes(u));F&&d(F.value)}else d(u)},r.current=g,g.start()};return a.jsx("button",{type:"button",onClick:c,className:`absolute left-2 top-1/2 -translate-y-1/2 p-2 rounded-full z-10 ${h?"bg-red-500 text-white":"text-gray-400 hover:text-green-600"}`,children:h?a.jsx(Z,{size:14}):a.jsx(B,{size:14})})},ie=()=>{var L;const d=V(),i=O(),{fullDocuments:b,loading:h,siteSettings:y}=M(),{user:r,updateUserCredits:c}=G(),{t:j}=K(),g=(L=d.state)==null?void 0:L.selectedDocId,[l,N]=x.useState(null),[u,F]=x.useState({}),[v,$]=x.useState({}),[E,S]=x.useState(!1),[k,A]=x.useState(""),[te,se]=x.useState(!1);x.useEffect(()=>{h||(async()=>{if(!g)return;const e=b.find(n=>n.id===g);if(e&&(N(e),e.previewTemplateHtml&&A(e.previewTemplateHtml),e.complexFields&&Array.isArray(e.complexFields))){const n={};e.complexFields.forEach(s=>{n[s.id]=[{}]}),$(n)}})()},[b,g,h]);const T=x.useMemo(()=>{const t=new Set;return l!=null&&l.fieldCustomizations&&Object.values(l.fieldCustomizations).forEach(e=>{e.type==="select"&&e.options&&C(e.options).forEach(n=>{n.mappedValues&&Object.keys(n.mappedValues).forEach(s=>t.add(s))})}),t},[l]),D=(t,e)=>{var s;let n={...u,[t]:e};if((s=l==null?void 0:l.fieldCustomizations)!=null&&s[t]){const o=l.fieldCustomizations[t];if(o.type==="select"&&o.options){const f=C(o.options).find(m=>m.value===e);f!=null&&f.mappedValues&&(n={...n,...f.mappedValues})}}F(n)};x.useEffect(()=>{if(!l)return;const t={...u};l.fieldCustomizations&&Object.entries(l.fieldCustomizations).forEach(([s,o])=>{if(o.type==="select"&&o.options){const f=u[s];if(f){const m=C(o.options).find(w=>w.value===f);m!=null&&m.outputTemplate?t[s]=m.outputTemplate.replace("{subValue}",u[`${s}_sub`]||"").replace("{self}",m.label):m&&(t[s]=m.label)}}}),l.complexFields&&Array.isArray(l.complexFields)&&l.complexFields.forEach(s=>{const o=s.templatePlaceholder.replace(/[\[\]]/g,"");t[o]=Y(s,v[s.id]||[])});let e=l.previewTemplateHtml||k;if(!e)return;Object.keys(t).forEach(s=>{e=e.replace(new RegExp(`\\[${s}\\]`,"g"),String(t[s]||""))});const n=new Date().toLocaleDateString("ar-DZ");e=e.replace(/\[DateToday\]/g,n),A(e)},[u,v,l]);const z=x.useMemo(()=>{if(!l)return[];const t=new Set,e=[];return new Set([...l.requiredFields||[],...Object.keys(l.fieldCustomizations||{})]).forEach(s=>{s==="DateToday"||s==="profilePicture"||t.has(s)||T.has(s)||l.complexFields&&l.complexFields.some(o=>o.templatePlaceholder.includes(s))||(e.push(s),t.add(s))}),e},[l,T]),H=async()=>{if(!l||!r||!y)return;S(!0);const t=r.credits.currency==="USD"?y.pricing.dynamicDocument.usd:y.pricing.dynamicDocument.dzd;try{const e=await Q(r,t);if(!e.success){alert(e.message),S(!1);return}c(r.credits.amount-t);const n={...u};await J([l],l.id,n,{action:"print",targetLang:"ar",templateType:"final"})}catch(e){console.error(e),alert("حدث خطأ.")}finally{S(!1)}};return h||!l?a.jsx("div",{className:"flex justify-center items-center h-full",children:a.jsx(R,{className:"animate-spin text-4xl text-green-600"})}):a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsxs("div",{className:"flex justify-between items-center mb-4",children:[a.jsx("button",{onClick:()=>i("/app"),className:"text-gray-500 hover:text-gray-700",children:a.jsx(q,{})}),a.jsxs("button",{onClick:H,disabled:E,className:"bg-green-600 text-white font-bold py-2 px-6 rounded-lg",children:[E?a.jsx(R,{className:"animate-spin"}):a.jsx(U,{})," ",a.jsx("span",{children:"طباعة"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-full",children:[a.jsxs("div",{className:"lg:col-span-1 bg-white p-6 overflow-y-auto h-[80vh] border rounded-lg",children:[a.jsx("h2",{className:"text-lg font-bold mb-4",children:"تعبئة البيانات"}),a.jsxs("div",{className:"space-y-4",children:[z.map(t=>{var m,w,P;const e=(m=l.fieldCustomizations)==null?void 0:m[t],n=W[t];let s=(e==null?void 0:e.customQuestion)||((w=l.questions)==null?void 0:w[t])||(n?j(n.label):t);s===(n==null?void 0:n.label)&&(s=X[t]||s);const o=(e==null?void 0:e.type)||(n==null?void 0:n.type)||"text",f=e!=null&&e.options?C(e.options):(P=n==null?void 0:n.options)==null?void 0:P.map(p=>({value:p.value,label:j(p.label)}));return a.jsxs("div",{className:"relative",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s}),o==="select"&&f?a.jsxs("select",{value:u[t]||"",onChange:p=>D(t,p.target.value),className:"w-full p-2 border rounded-md",children:[a.jsx("option",{value:"",children:"-- اختر --"}),f.map(p=>a.jsx("option",{value:p.value,children:p.label},p.value))]}):a.jsx("input",{type:o,value:u[t]||"",onChange:p=>D(t,p.target.value),className:"w-full p-2 border rounded-md"}),a.jsx(ee,{onResult:p=>D(t,p),isSelect:o==="select",options:f})]},t)}),l.complexFields&&Array.isArray(l.complexFields)&&l.complexFields.map(t=>a.jsxs("div",{className:"p-4 bg-blue-50 border rounded-lg mt-4",children:[a.jsx("label",{className:"block font-bold mb-2",children:t.label}),(v[t.id]||[]).map((e,n)=>a.jsxs("div",{className:"bg-white p-2 border rounded mb-2 relative",children:[a.jsx("button",{onClick:()=>handleRemoveComplexItem(t.id,n),className:"absolute top-1 left-1 text-red-500",children:a.jsx(_,{size:10})}),t.itemFields.map(s=>a.jsxs("div",{className:"mb-2",children:[a.jsx("label",{className:"text-xs text-gray-500",children:s.label}),a.jsx("input",{type:s.type,value:e[s.id]||"",onChange:o=>handleComplexItemChange(t.id,n,s.id,o.target.value),className:"w-full p-1 border rounded text-sm"})]},s.id))]},n)),a.jsxs("button",{onClick:()=>handleAddComplexItem(t.id),className:"text-blue-600 text-sm font-bold flex items-center gap-1",children:[a.jsx(I,{})," إضافة"]})]},t.id))]})]}),a.jsx("div",{className:"lg:col-span-2 bg-gray-100 p-4 h-[80vh] border rounded-lg",children:a.jsx("iframe",{srcDoc:k,className:"w-full h-full border bg-white rounded"})})]})]})};export{ie as default};
