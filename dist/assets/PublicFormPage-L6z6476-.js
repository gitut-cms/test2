import{b as ue,u as pe,c as he,r as m,C as be,j as e,F as ge,L as fe,k as je,D as ye,E as Y,B as ve,G as Ne,H as we,e as Ce}from"./index-DgmZNK3x.js";import{F as Fe,f as Z}from"./constants-DfStgaks.js";import{g as Ee}from"./doc-generator-BSuTvlLC.js";import{A as E}from"./AdBanner-BHXyFlzY.js";import{I as ke}from"./ImageCapture-Crup5CAt.js";import{asBlob as Pe}from"https://esm.sh/html-docx-js-typescript@0.1.5";import Te from"https://esm.sh/file-saver@2.0.5";import{T as Se}from"./TemplateEditor-CMJkMKZv.js";import"./geminiService-CD7J7Ty3.js";import"./fileUtils-Cb1IM2ig.js";const k=h=>h?h.map(x=>typeof x=="string"?{value:x,label:x}:x):[],$e=(h,x)=>{if(!x||x.length===0)return"";const u=h.displayType||"table";if(u==="table"){let b='<table style="width:100%; border-collapse: collapse; margin: 20px 0; font-size: 12pt;"><thead><tr>';return h.itemFields.forEach(i=>{b+=`<th style="border:1px solid #000; padding: 8px; background: #f0f0f0; text-align: center;">${i.label}</th>`}),b+="</tr></thead><tbody>",x.forEach(i=>{b+="<tr>",h.itemFields.forEach(l=>{b+=`<td style="border:1px solid #000; padding: 8px; text-align: center;">${i[l.id]||""}</td>`}),b+="</tr>"}),b+="</tbody></table>",b}const j=x.map(b=>h.itemFields.map(i=>b[i.id]).filter(i=>i!=null&&i!=="").join(" - ")).filter(b=>b!=="");if(j.length===0)return"";if(u==="comma")return j.join("، ");const N=u==="ol"?"ol":"ul";return`<${N}>${j.map(b=>`<li>${b}</li>`).join("")}</${N}>`},Be=()=>{const{countryCode:h,docId:x}=ue(),{siteSettings:u,documents:j,fullDocuments:N,loading:b}=pe(),{t:i}=he(),[l,I]=m.useState(null),[ee,D]=m.useState(!0),[R,_]=m.useState(null),[P,O]=m.useState("form"),[g,z]=m.useState({}),[H,T]=m.useState({}),[te,se]=m.useState(null),[w,A]=m.useState((u==null?void 0:u.ads.pdfInterstitialTimer)??5),[re,q]=m.useState(!1),[V,B]=m.useState(!1),[ae,le]=m.useState(""),[C,y]=m.useState(null),L=m.useRef({}),ne=h?`/${h}`:"/",S=m.useMemo(()=>h?be.ar.some(t=>t.code===h):!0,[h]);m.useEffect(()=>{if(!x){_("لم يتم تحديد مستند."),D(!1);return}(async()=>{D(!0),_(null);try{const s=j.find(p=>p.id===x||p.slug===x)||N.find(p=>p.id===x||p.slug===x),a=(s==null?void 0:s.slug)||x,r=(s==null?void 0:s.countryCode)||h;let o=`https://datas.gitut.com/data/json/documents/${a}.json`;r&&r!=="global"&&(o=`https://datas.gitut.com/data/json/documents/${r}/${a}.json`);const d=await fetch(o);if(!d.ok)throw new Error("تعذر تحميل بيانات المستند");const c=await d.json();if(typeof c.fieldCustomizations=="string")try{c.fieldCustomizations=JSON.parse(c.fieldCustomizations)}catch{}if(typeof c.complexFields=="string")try{c.complexFields=JSON.parse(c.complexFields)}catch{}if(typeof c.requiredFields=="string")try{c.requiredFields=JSON.parse(c.requiredFields)}catch{}if(I(c),c.complexFields&&Array.isArray(c.complexFields)){const p={};c.complexFields.forEach(F=>{p[F.id]=[{}]}),T(p)}}catch(s){console.error("Failed to fetch document data:",s),_(s instanceof Error?s.message:"حدث خطأ غير متوقع.")}finally{D(!1)}})()},[x,j,N,h]),m.useEffect(()=>{var t;C&&L.current[C]&&((t=L.current[C])==null||t.scrollIntoView({behavior:"smooth",block:"center"}))},[C]);const M=m.useMemo(()=>{const t=new Set;return l!=null&&l.fieldCustomizations&&typeof l.fieldCustomizations=="object"&&Object.values(l.fieldCustomizations).forEach(s=>{s.type==="select"&&s.options&&k(s.options).forEach(a=>{a.mappedValues&&Object.keys(a.mappedValues).forEach(r=>t.add(r))})}),t},[l]),oe=m.useMemo(()=>{if(!l)return[];const t=new Set,s=[];return new Set([...Array.isArray(l.requiredFields)?l.requiredFields:[],...l.fieldCustomizations?Object.keys(l.fieldCustomizations):[]]).forEach(r=>{r==="DateToday"||t.has(r)||M.has(r)||Array.isArray(l.complexFields)&&l.complexFields.some(o=>o.templatePlaceholder.includes(r))||(s.push(r),t.add(r))}),s},[l,M]),ie=t=>{T(s=>({...s,[t]:[...s[t]||[],{}]}))},ce=(t,s)=>{T(a=>({...a,[t]:(a[t]||[]).filter((r,o)=>o!==s)}))},U=(t,s,a,r)=>{T(o=>{const d=[...o[t]||[]];return d[s]={...d[s],[a]:r},{...o,[t]:d}})},K=()=>{if(!l)return{};const t={...g};return l.fieldCustomizations&&Object.entries(l.fieldCustomizations).forEach(([s,a])=>{if(a.type==="select"&&a.options){const r=g[s];if(r){const d=k(a.options).find(c=>c.value===r);if(d&&d.outputTemplate){const c=`${s}_sub`,p=g[c]||"";t[s]=d.outputTemplate.replace("{subValue}",p).replace("{self}",d.label)}}}}),Array.isArray(l.complexFields)&&l.complexFields.forEach(s=>{const a=H[s.id]||[],r=s.templatePlaceholder.replace(/[\[\]]/g,"");t[r]=$e(s,a)}),t},W=()=>{if(!l)return"";const t=K();let s=l.finalTemplateHtml||"";const r=new Date().toLocaleDateString("ar-DZ",{day:"2-digit",month:"2-digit",year:"numeric"});return s=s.replace(/\[DateToday\]/g,r),Object.keys(t).forEach(o=>{const d=new RegExp(`\\[${o}\\]`,"g");s=s.replace(d,String(t[o]||""))}),s=s.replace(/\[[^\]]+\]/g,""),s},de=async t=>{if(!(!l||!t)){if(t==="word"){try{const s=W(),a=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>${l.name}</title></head><body>${s}</body></html>`,r=await Pe(a,{orientation:"portrait",margins:{top:720,right:720,bottom:720,left:720}});r&&Te.saveAs(r,`${l.slug||"document"}.docx`)}catch(s){console.error("Error generating DOCX:",s)}return}if(t==="pdf"){const s=K();await Ee([l],l.id,s,{action:"download",targetLang:"ar",templateType:"final"})}}};m.useEffect(()=>{if(P==="ad"&&w>0){const t=setTimeout(()=>A(s=>s-1),1e3);return()=>clearTimeout(t)}},[P,w]);const v=(t,s)=>{if(l&&l.fieldCustomizations&&l.fieldCustomizations[t]){const a=l.fieldCustomizations[t];if(a.type==="select"&&a.options){const o=k(a.options).find(d=>d.value===s);if(o&&o.mappedValues){z(d=>({...d,[t]:s,...o.mappedValues}));return}}}z(a=>({...a,[t]:s}))},me=t=>{t.preventDefault(),O("select_format")},G=t=>{se(t),B(!1),A((u==null?void 0:u.ads.pdfInterstitialTimer)??5),O("ad")},xe=()=>{le(W()),B(!0),A((u==null?void 0:u.ads.pdfInterstitialTimer)??5),O("ad")};return ee?e.jsx("div",{className:"flex justify-center items-center p-10",children:e.jsx(ge,{className:"animate-spin text-4xl text-green-600"})}):R||!l?e.jsxs("div",{className:"text-center py-20",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:R||"لم يتم العثور على المستند"}),e.jsx(fe,{to:ne,className:"bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors",children:"العودة للرئيسية"})]}):re?e.jsx(Se,{initialHtml:ae,docName:l.name,onClose:()=>q(!1)}):P==="select_format"?e.jsx("div",{className:"max-w-xl mx-auto text-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg border space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"اختر صيغة التحميل"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 pt-4",children:[e.jsxs("button",{onClick:()=>G("pdf"),className:"flex-1 flex flex-col items-center justify-center gap-2 bg-red-100 text-red-800 font-bold p-6 rounded-lg hover:bg-red-200 border border-red-200",children:[e.jsx(je,{size:40}),e.jsx("span",{children:"تحميل PDF"})]}),e.jsxs("button",{onClick:()=>G("word"),className:"flex-1 flex flex-col items-center justify-center gap-2 bg-blue-100 text-blue-800 font-bold p-6 rounded-lg hover:bg-blue-200 border border-blue-200",children:[e.jsx(ye,{size:40}),e.jsx("span",{children:"تحميل Word"})]})]})]})}):P==="ad"?e.jsxs("div",{className:"min-h-[80vh] flex flex-col xl:flex-row items-start justify-center p-4 gap-6 lg:gap-8",children:[e.jsxs("aside",{className:"flex flex-col w-full xl:w-80 gap-6 xl:sticky xl:top-24 order-1 xl:order-none",children:[e.jsx(E,{placement:"PUBLIC_FORM_RIGHT"}),S&&e.jsx("div",{className:"p-6 bg-green-50 border border-green-200 rounded-xl shadow-sm text-center",children:e.jsxs("div",{className:"text-green-800 font-amiri leading-loose",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 border-b border-green-200 pb-2",children:i("adPage.hadithTitle")}),e.jsxs("p",{className:"text-xl font-medium",children:['"',i("adPage.istighfarContent"),'"']})]})})]}),e.jsx("div",{className:"max-w-3xl w-full text-center flex-grow order-2 xl:order-none",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg border space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:V?"جاري فتح المحرر...":"تجهيز الرابط..."}),w>0?e.jsxs("div",{className:"py-8",children:[e.jsx("p",{className:"text-gray-600 mb-4",children:"يرجى الانتظار، الرابط سيكون جاهزاً خلال:"}),e.jsxs("div",{className:"inline-block relative",children:[e.jsxs("svg",{className:"w-32 h-32 transform -rotate-90",children:[e.jsx("circle",{cx:"64",cy:"64",r:"56",stroke:"currentColor",strokeWidth:"8",fill:"transparent",className:"text-gray-200"}),e.jsx("circle",{cx:"64",cy:"64",r:"56",stroke:"currentColor",strokeWidth:"8",fill:"transparent",strokeDasharray:351.86,strokeDashoffset:351.86-351.86*w/((u==null?void 0:u.ads.pdfInterstitialTimer)??5),className:"text-green-600 transition-all duration-1000 ease-linear"})]}),e.jsx("div",{className:"absolute top-0 left-0 w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"text-4xl font-bold text-green-600 font-mono",children:w})})]})]}):e.jsx("div",{className:"my-6 animate-fadeIn",children:e.jsx("div",{className:"flex flex-col sm:flex-row justify-center gap-4",children:V?e.jsxs("button",{onClick:()=>q(!0),className:"inline-flex items-center justify-center gap-2 bg-blue-600 text-white text-xl font-bold py-4 px-10 rounded-lg hover:bg-blue-700 shadow-lg transform hover:scale-105",children:[e.jsx("span",{children:"فتح المحرر المتقدم"}),e.jsx(Y,{})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>de(te),className:"inline-flex items-center justify-center gap-2 bg-green-600 text-white text-xl font-bold py-4 px-10 rounded-lg hover:bg-green-700 shadow-lg transform hover:scale-105",children:[e.jsx("span",{children:"تحميل الآن"}),e.jsx(ve,{})]}),e.jsxs("button",{onClick:xe,className:"inline-flex items-center justify-center gap-2 bg-blue-600 text-white text-xl font-bold py-4 px-10 rounded-lg hover:bg-blue-700 shadow-lg transform hover:scale-105",children:[e.jsx("span",{children:"تعديل يدوي"}),e.jsx(Y,{})]})]})})}),e.jsx("div",{className:"pt-6 border-t",children:e.jsx(E,{placement:"PDF_INTERSTITIAL"})})]})}),e.jsxs("aside",{className:"flex flex-col w-full xl:w-80 gap-6 xl:sticky xl:top-24 order-3 xl:order-none",children:[e.jsx(E,{placement:"PUBLIC_FORM_LEFT"}),S&&e.jsx("div",{className:"p-6 bg-blue-50 border border-blue-200 rounded-xl shadow-sm text-center",children:e.jsxs("div",{className:"text-blue-900 font-amiri leading-loose",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 border-b border-green-200 pb-2",children:i("adPage.prayerReminderTitle")}),e.jsx("p",{className:"text-lg mb-2",children:i("adPage.hadithIntro")}),e.jsxs("p",{className:"text-xl font-bold mb-4",children:['"',i("adPage.prayerHadithContent"),'"']}),e.jsx("p",{className:"text-xs text-blue-700",children:i("adPage.prayerHadithSource")})]})})]})]}):e.jsxs("div",{className:"flex flex-col xl:flex-row items-start justify-center p-4 gap-6 lg:gap-8 min-h-[80vh]",children:[e.jsxs("aside",{className:"flex flex-col w-full xl:w-80 gap-6 xl:sticky xl:top-24 order-1 xl:order-none",children:[e.jsx(E,{placement:"PUBLIC_FORM_RIGHT"}),S&&e.jsx("div",{className:"p-6 bg-green-50 border border-green-200 rounded-xl shadow-sm text-center",children:e.jsxs("div",{className:"text-green-800 font-amiri leading-loose",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 border-b border-green-200 pb-2",children:i("adPage.hadithTitle")}),e.jsxs("p",{className:"text-xl font-medium",children:['"',i("adPage.istighfarContent"),'"']})]})})]}),e.jsx("main",{className:"flex-grow max-w-3xl w-full order-2 xl:order-none",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 md:p-8",children:[e.jsxs("div",{className:"mb-6 border-b pb-4 text-center",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:["ملء بيانات: ",l.name]}),e.jsx("p",{className:"text-gray-600",children:"املأ الحقول أدناه لإنشاء المستند الخاص بك."})]}),e.jsxs("form",{onSubmit:me,className:"space-y-4",children:[oe.map(t=>{var J,Q,X;const s=t,a=Fe[s],r=(J=l.fieldCustomizations)==null?void 0:J[t];let o=(r==null?void 0:r.customQuestion)||((Q=l.questions)==null?void 0:Q[t])||(a?i(a.label):t);o===t&&Z[t]&&(o=Z[t]);const d=(r==null?void 0:r.type)||(a==null?void 0:a.type)||"text";let c=r!=null&&r.options?k(r.options):(X=a==null?void 0:a.options)==null?void 0:X.map(n=>({value:n.value,label:i(n.label)}));const p=(r==null?void 0:r.placeholder)||(a?i(a.placeholder):""),F=c==null?void 0:c.find(n=>n.value===g[t]),f=F==null?void 0:F.subField,$=C===t;return e.jsxs("div",{className:"space-y-3",ref:n=>L.current[t]=n,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:t,className:`block text-sm font-medium mb-1 transition-colors ${$?"text-green-600 font-bold":"text-gray-700"}`,children:o}),d==="file"||s==="profilePicture"?e.jsx(ke,{value:g[t]||"",onChange:n=>v(t,n)}):d==="select"&&c?e.jsxs("select",{id:t,name:t,value:g[t]||"",onChange:n=>v(n.target.name,n.target.value),onFocus:()=>y(t),onBlur:()=>y(null),className:`block w-full px-3 py-2 bg-white border-2 rounded-md transition-all outline-none ${$?"border-green-500 ring-2 ring-green-200 shadow-md":"border-gray-300"}`,required:!0,children:[e.jsx("option",{value:"",children:"-- اختر --"}),c.map(n=>e.jsx("option",{value:n.value,children:n.label},n.value))]}):d==="textarea"?e.jsx("textarea",{id:t,name:t,value:g[t]||"",onChange:n=>v(n.target.name,n.target.value),onFocus:()=>y(t),onBlur:()=>y(null),placeholder:p,className:`w-full p-2 border-2 rounded-md transition-all outline-none ${$?"border-green-500 ring-2 ring-green-200 shadow-md":"border-gray-300"}`,rows:3,required:!0}):e.jsx("input",{type:d,id:t,name:t,value:g[t]||"",onChange:n=>v(n.target.name,n.target.value),onFocus:()=>y(t),onBlur:()=>y(null),placeholder:p,className:`w-full p-2 border-2 rounded-md transition-all outline-none ${$?"border-green-500 ring-2 ring-green-200 shadow-md":"border-gray-300"}`,required:!0})]}),f&&e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200 animate-fadeIn ml-4 border-r-4 border-r-blue-400",children:[e.jsx("label",{htmlFor:`${t}_sub`,className:"block text-sm font-bold text-blue-800 mb-1",children:f.customQuestion||f.placeholder||"يرجى التحديد:"}),f.type==="select"&&f.options?e.jsxs("select",{id:`${t}_sub`,name:`${t}_sub`,value:g[`${t}_sub`]||"",onChange:n=>v(n.target.name,n.target.value),className:"block w-full px-3 py-2 bg-white border border-blue-300 rounded-md shadow-sm",required:!0,children:[e.jsx("option",{value:"",children:"-- اختر --"}),k(f.options).map(n=>e.jsx("option",{value:n.value,children:n.label},n.value))]}):e.jsx("input",{type:f.type||"text",id:`${t}_sub`,name:`${t}_sub`,value:g[`${t}_sub`]||"",onChange:n=>v(n.target.name,n.target.value),placeholder:f.placeholder||f.customQuestion||"",className:"block w-full px-3 py-2 bg-white border border-blue-300 rounded-md",required:!0})]})]},t)}),Array.isArray(l.complexFields)&&l.complexFields.map(t=>e.jsxs("div",{className:"border-2 border-blue-100 p-4 rounded-lg bg-blue-50 mt-6",children:[e.jsx("label",{className:"block font-bold text-gray-800 mb-3 border-b border-blue-200 pb-2",children:t.label}),e.jsx("div",{className:"space-y-3",children:(H[t.id]||[]).map((s,a)=>e.jsxs("div",{className:"bg-white p-3 rounded shadow-sm border relative",children:[e.jsx("button",{type:"button",onClick:()=>ce(t.id,a),className:"absolute top-2 left-2 text-red-400 hover:text-red-600",children:e.jsx(Ne,{size:12})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 pr-4",children:t.itemFields.map(r=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:r.label}),r.type==="select"&&r.options?e.jsxs("select",{value:s[r.id]||"",onChange:o=>U(t.id,a,r.id,o.target.value),className:"w-full p-1 border rounded text-sm",children:[e.jsx("option",{value:"",children:"-- اختر --"}),r.options.map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))]}):e.jsx("input",{type:r.type||"text",value:s[r.id]||"",onChange:o=>U(t.id,a,r.id,o.target.value),placeholder:r.label||"",className:"w-full p-1 border rounded text-sm"})]},r.id))})]},a))}),e.jsxs("button",{type:"button",onClick:()=>ie(t.id),className:"mt-3 text-sm flex items-center gap-1 text-blue-600 font-semibold hover:text-blue-800",children:[e.jsx(we,{})," ",t.addItemButtonLabel||"إضافة عنصر جديد"]})]},t.id)),e.jsx("div",{className:"pt-4",children:e.jsxs("button",{type:"submit",className:"w-full flex items-center justify-center gap-3 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors text-lg",children:[e.jsx(Ce,{}),e.jsx("span",{children:"إنشاء المستند"})]})})]})]})}),e.jsxs("aside",{className:"flex flex-col w-full xl:w-80 gap-6 xl:sticky xl:top-24 order-3 xl:order-none",children:[e.jsx(E,{placement:"PUBLIC_FORM_LEFT"}),S&&e.jsx("div",{className:"p-6 bg-blue-50 border border-blue-200 rounded-xl shadow-sm text-center",children:e.jsxs("div",{className:"text-blue-900 font-amiri leading-loose",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 border-b border-green-200 pb-2",children:i("adPage.prayerReminderTitle")}),e.jsx("p",{className:"text-lg mb-2",children:i("adPage.hadithIntro")}),e.jsxs("p",{className:"text-xl font-bold mb-4",children:['"',i("adPage.prayerHadithContent"),'"']}),e.jsx("p",{className:"text-xs text-blue-700",children:i("adPage.prayerHadithSource")})]})})]})]})};export{Be as default};
