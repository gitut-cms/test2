import{b as be,u as ge,c as fe,r as m,C as je,j as e,F as ye,L as ve,k as Ne,D as we,E as q,G as I,B as Ce,H as Fe,I as ke,e as Ee}from"./index-hpjxKmld.js";import{F as Pe,f as ee}from"./constants-DfStgaks.js";import{g as te}from"./doc-generator-Ct1URtxh.js";import{A as k}from"./AdBanner-Asof6Iy0.js";import{I as Te}from"./ImageCapture-CWevzux-.js";import{asBlob as Se}from"https://esm.sh/html-docx-js-typescript@0.1.5";import De from"https://esm.sh/file-saver@2.0.5";import{T as $e}from"./TemplateEditor-DGpl3dbm.js";import"./geminiService-DifXNJPz.js";import"./fileUtils-Cb1IM2ig.js";const E=h=>h?h.map(x=>typeof x=="string"?{value:x,label:x}:x):[],_e=(h,x)=>{if(!x||x.length===0)return"";const u=h.displayType||"table";if(u==="table"){let b='<table style="width:100%; border-collapse: collapse; margin: 20px 0; font-size: 12pt;"><thead><tr>';return h.itemFields.forEach(i=>{b+=`<th style="border:1px solid #000; padding: 8px; background: #f0f0f0; text-align: center;">${i.label}</th>`}),b+="</tr></thead><tbody>",x.forEach(i=>{b+="<tr>",h.itemFields.forEach(a=>{b+=`<td style="border:1px solid #000; padding: 8px; text-align: center;">${i[a.id]||""}</td>`}),b+="</tr>"}),b+="</tbody></table>",b}const j=x.map(b=>h.itemFields.map(i=>b[i.id]).filter(i=>i!=null&&i!=="").join(" - ")).filter(b=>b!=="");if(j.length===0)return"";if(u==="comma")return j.join("، ");const N=u==="ol"?"ol":"ul";return`<${N}>${j.map(b=>`<li>${b}</li>`).join("")}</${N}>`},Ue=()=>{const{countryCode:h,docId:x}=be(),{siteSettings:u,documents:j,fullDocuments:N,loading:b}=ge(),{t:i}=fe(),[a,re]=m.useState(null),[se,$]=m.useState(!0),[V,_]=m.useState(null),[P,A]=m.useState("form"),[g,B]=m.useState({}),[M,T]=m.useState({}),[O,ae]=m.useState(null),[w,L]=m.useState((u==null?void 0:u.ads.pdfInterstitialTimer)??5),[le,U]=m.useState(!1),[K,W]=m.useState(!1),[ne,oe]=m.useState(""),[C,y]=m.useState(null),R=m.useRef({}),ie=h?`/${h}`:"/",S=m.useMemo(()=>h?je.ar.some(t=>t.code===h):!0,[h]);m.useEffect(()=>{if(!x){_("لم يتم تحديد مستند."),$(!1);return}(async()=>{$(!0),_(null);try{const r=j.find(p=>p.id===x||p.slug===x)||N.find(p=>p.id===x||p.slug===x),l=(r==null?void 0:r.slug)||x,s=(r==null?void 0:r.countryCode)||h;let n=`https://datas.gitut.com/data/json/documents/${l}.json`;s&&s!=="global"&&(n=`https://datas.gitut.com/data/json/documents/${s}/${l}.json`);const c=await fetch(n);if(!c.ok)throw new Error("تعذر تحميل بيانات المستند");const d=await c.json();if(typeof d.fieldCustomizations=="string")try{d.fieldCustomizations=JSON.parse(d.fieldCustomizations)}catch{}if(typeof d.complexFields=="string")try{d.complexFields=JSON.parse(d.complexFields)}catch{}if(typeof d.requiredFields=="string")try{d.requiredFields=JSON.parse(d.requiredFields)}catch{}if(re(d),d.complexFields&&Array.isArray(d.complexFields)){const p={};d.complexFields.forEach(F=>{p[F.id]=[{}]}),T(p)}}catch(r){console.error("Failed to fetch document data:",r),_(r instanceof Error?r.message:"حدث خطأ غير متوقع.")}finally{$(!1)}})()},[x,j,N,h]),m.useEffect(()=>{var t;C&&R.current[C]&&((t=R.current[C])==null||t.scrollIntoView({behavior:"smooth",block:"center"}))},[C]);const G=m.useMemo(()=>{const t=new Set;return a!=null&&a.fieldCustomizations&&typeof a.fieldCustomizations=="object"&&Object.values(a.fieldCustomizations).forEach(r=>{r.type==="select"&&r.options&&E(r.options).forEach(l=>{l.mappedValues&&Object.keys(l.mappedValues).forEach(s=>t.add(s))})}),t},[a]),ce=m.useMemo(()=>{if(!a)return[];const t=new Set,r=[];return new Set([...Array.isArray(a.requiredFields)?a.requiredFields:[],...a.fieldCustomizations?Object.keys(a.fieldCustomizations):[]]).forEach(s=>{s==="DateToday"||t.has(s)||G.has(s)||Array.isArray(a.complexFields)&&a.complexFields.some(n=>n.templatePlaceholder.includes(s))||(r.push(s),t.add(s))}),r},[a,G]),de=t=>{T(r=>({...r,[t]:[...r[t]||[],{}]}))},me=(t,r)=>{T(l=>({...l,[t]:(l[t]||[]).filter((s,n)=>n!==r)}))},J=(t,r,l,s)=>{T(n=>{const c=[...n[t]||[]];return c[r]={...c[r],[l]:s},{...n,[t]:c}})},z=()=>{if(!a)return{};const t={...g};return a.fieldCustomizations&&Object.entries(a.fieldCustomizations).forEach(([r,l])=>{if(l.type==="select"&&l.options){const s=g[r];if(s){const c=E(l.options).find(d=>d.value===s);if(c&&c.outputTemplate){const d=`${r}_sub`,p=g[d]||"";t[r]=c.outputTemplate.replace("{subValue}",p).replace("{self}",c.label)}}}}),Array.isArray(a.complexFields)&&a.complexFields.forEach(r=>{const l=M[r.id]||[],s=r.templatePlaceholder.replace(/[\[\]]/g,"");t[s]=_e(r,l)}),t},Q=()=>{if(!a)return"";const t=z();let r=a.finalTemplateHtml||"";const s=new Date().toLocaleDateString("ar-DZ",{day:"2-digit",month:"2-digit",year:"numeric"});return r=r.replace(/\[DateToday\]/g,s),Object.keys(t).forEach(n=>{const c=new RegExp(`\\[${n}\\]`,"g");r=r.replace(c,String(t[n]||""))}),r=r.replace(/\[[^\]]+\]/g,""),r},xe=async t=>{if(!a||!t)return;if(t==="word"){try{const s=Q(),n=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>${a.name}</title></head><body>${s}</body></html>`,c=await Se(n,{orientation:"portrait",margins:{top:720,right:720,bottom:720,left:720}});c&&De.saveAs(c,`${a.slug||"document"}.docx`)}catch(s){console.error("Error generating DOCX:",s)}return}const r=z(),l=t==="print"?"print":"download";await te([a],a.id,r,{action:l,targetLang:"ar",templateType:"final"})},ue=async()=>{if(!a)return;const t=z();await te([a],a.id,t,{action:"print",targetLang:"ar",templateType:"final"})};m.useEffect(()=>{if(P==="ad"&&w>0){const t=setTimeout(()=>L(r=>r-1),1e3);return()=>clearTimeout(t)}},[P,w]);const v=(t,r)=>{if(a&&a.fieldCustomizations&&a.fieldCustomizations[t]){const l=a.fieldCustomizations[t];if(l.type==="select"&&l.options){const n=E(l.options).find(c=>c.value===r);if(n&&n.mappedValues){B(c=>({...c,[t]:r,...n.mappedValues}));return}}}B(l=>({...l,[t]:r}))},pe=t=>{t.preventDefault(),A("select_format")},H=t=>{ae(t),W(!1),L((u==null?void 0:u.ads.pdfInterstitialTimer)??5),A("ad")},he=()=>{oe(Q()),W(!0),L((u==null?void 0:u.ads.pdfInterstitialTimer)??5),A("ad")};return se?e.jsx("div",{className:"flex justify-center items-center p-10",children:e.jsx(ye,{className:"animate-spin text-4xl text-green-600"})}):V||!a?e.jsxs("div",{className:"text-center py-20",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:V||"لم يتم العثور على المستند"}),e.jsx(ve,{to:ie,className:"bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors",children:"العودة للرئيسية"})]}):le?e.jsx($e,{initialHtml:ne,docName:a.name,onClose:()=>U(!1)}):P==="select_format"?e.jsx("div",{className:"max-w-2xl mx-auto text-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg border space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"اختر صيغة التحميل أو الطباعة"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 pt-4",children:[e.jsxs("button",{onClick:()=>H("pdf"),className:"flex-1 flex flex-col items-center justify-center gap-2 bg-red-50 text-red-800 font-bold p-6 rounded-lg hover:bg-red-100 border border-red-200 transition-colors",children:[e.jsx(Ne,{size:40}),e.jsx("span",{children:"تحميل PDF"})]}),e.jsxs("button",{onClick:()=>H("word"),className:"flex-1 flex flex-col items-center justify-center gap-2 bg-blue-50 text-blue-800 font-bold p-6 rounded-lg hover:bg-blue-100 border border-blue-200 transition-colors",children:[e.jsx(we,{size:40}),e.jsx("span",{children:"تحميل Word"})]}),e.jsxs("button",{onClick:()=>H("print"),className:"flex-1 flex flex-col items-center justify-center gap-2 bg-indigo-50 text-indigo-800 font-bold p-6 rounded-lg hover:bg-indigo-100 border border-indigo-200 transition-colors",children:[e.jsx(q,{size:40}),e.jsx("span",{children:"طباعة مباشرة"})]})]})]})}):P==="ad"?e.jsxs("div",{className:"min-h-[80vh] flex flex-col xl:flex-row items-start justify-center p-4 gap-6 lg:gap-8",children:[e.jsxs("aside",{className:"flex flex-col w-full xl:w-80 gap-6 xl:sticky xl:top-24 order-1 xl:order-none",children:[e.jsx(k,{placement:"PUBLIC_FORM_RIGHT"}),S&&e.jsx("div",{className:"p-6 bg-green-50 border border-green-200 rounded-xl shadow-sm text-center",children:e.jsxs("div",{className:"text-green-800 font-amiri leading-loose",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 border-b border-green-200 pb-2",children:i("adPage.hadithTitle")}),e.jsxs("p",{className:"text-xl font-medium",children:['"',i("adPage.istighfarContent"),'"']})]})})]}),e.jsx("div",{className:"max-w-3xl w-full text-center flex-grow order-2 xl:order-none",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg border space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:K?"جاري فتح المحرر...":"تجهيز الرابط..."}),w>0?e.jsxs("div",{className:"py-8",children:[e.jsx("p",{className:"text-gray-600 mb-4",children:"يرجى الانتظار، الرابط سيكون جاهزاً خلال:"}),e.jsxs("div",{className:"inline-block relative",children:[e.jsxs("svg",{className:"w-32 h-32 transform -rotate-90",children:[e.jsx("circle",{cx:"64",cy:"64",r:"56",stroke:"currentColor",strokeWidth:"8",fill:"transparent",className:"text-gray-200"}),e.jsx("circle",{cx:"64",cy:"64",r:"56",stroke:"currentColor",strokeWidth:"8",fill:"transparent",strokeDasharray:351.86,strokeDashoffset:351.86-351.86*w/((u==null?void 0:u.ads.pdfInterstitialTimer)??5),className:"text-green-600 transition-all duration-1000 ease-linear"})]}),e.jsx("div",{className:"absolute top-0 left-0 w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"text-4xl font-bold text-green-600 font-mono",children:w})})]})]}):e.jsx("div",{className:"my-6 animate-fadeIn",children:e.jsx("div",{className:"flex flex-col sm:flex-row justify-center gap-4",children:K?e.jsxs("button",{onClick:()=>U(!0),className:"inline-flex items-center justify-center gap-2 bg-blue-600 text-white text-xl font-bold py-4 px-10 rounded-lg hover:bg-blue-700 shadow-lg transform hover:scale-105",children:[e.jsx("span",{children:"فتح المحرر المتقدم"}),e.jsx(I,{})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>xe(O),className:"inline-flex items-center justify-center gap-2 bg-green-600 text-white text-xl font-bold py-4 px-8 rounded-lg hover:bg-green-700 shadow-lg transform hover:scale-105 flex-1",children:[e.jsx("span",{children:O==="print"?"طباعة الآن":"تحميل الآن"}),O==="print"?e.jsx(q,{}):e.jsx(Ce,{})]}),e.jsxs("button",{onClick:ue,className:"inline-flex items-center justify-center gap-2 bg-indigo-600 text-white text-xl font-bold py-4 px-8 rounded-lg hover:bg-indigo-700 shadow-lg transform hover:scale-105 flex-1",children:[e.jsx("span",{children:"طباعة"}),e.jsx(q,{})]}),e.jsxs("button",{onClick:he,className:"inline-flex items-center justify-center gap-2 bg-blue-600 text-white text-xl font-bold py-4 px-8 rounded-lg hover:bg-blue-700 shadow-lg transform hover:scale-105 flex-1",children:[e.jsx("span",{children:"تعديل يدوي"}),e.jsx(I,{})]})]})})}),e.jsx("div",{className:"pt-6 border-t",children:e.jsx(k,{placement:"PDF_INTERSTITIAL"})})]})}),e.jsxs("aside",{className:"flex flex-col w-full xl:w-80 gap-6 xl:sticky xl:top-24 order-3 xl:order-none",children:[e.jsx(k,{placement:"PUBLIC_FORM_LEFT"}),S&&e.jsx("div",{className:"p-6 bg-blue-50 border border-blue-200 rounded-xl shadow-sm text-center",children:e.jsxs("div",{className:"text-blue-900 font-amiri leading-loose",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 border-b border-green-200 pb-2",children:i("adPage.prayerReminderTitle")}),e.jsx("p",{className:"text-lg mb-2",children:i("adPage.hadithIntro")}),e.jsxs("p",{className:"text-xl font-bold mb-4",children:['"',i("adPage.prayerHadithContent"),'"']}),e.jsx("p",{className:"text-xs text-blue-700",children:i("adPage.prayerHadithSource")})]})})]})]}):e.jsxs("div",{className:"flex flex-col xl:flex-row items-start justify-center p-4 gap-6 lg:gap-8 min-h-[80vh]",children:[e.jsxs("aside",{className:"flex flex-col w-full xl:w-80 gap-6 xl:sticky xl:top-24 order-1 xl:order-none",children:[e.jsx(k,{placement:"PUBLIC_FORM_RIGHT"}),S&&e.jsx("div",{className:"p-6 bg-green-50 border border-green-200 rounded-xl shadow-sm text-center",children:e.jsxs("div",{className:"text-green-800 font-amiri leading-loose",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 border-b border-green-200 pb-2",children:i("adPage.hadithTitle")}),e.jsxs("p",{className:"text-xl font-medium",children:['"',i("adPage.istighfarContent"),'"']})]})})]}),e.jsx("main",{className:"flex-grow max-w-3xl w-full order-2 xl:order-none",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 md:p-8",children:[e.jsxs("div",{className:"mb-6 border-b pb-4 text-center",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:["ملء بيانات: ",a.name]}),e.jsx("p",{className:"text-gray-600",children:"املأ الحقول أدناه لإنشاء المستند الخاص بك."})]}),e.jsxs("form",{onSubmit:pe,className:"space-y-4",children:[ce.map(t=>{var X,Y,Z;const r=t,l=Pe[r],s=(X=a.fieldCustomizations)==null?void 0:X[t];let n=(s==null?void 0:s.customQuestion)||((Y=a.questions)==null?void 0:Y[t])||(l?i(l.label):t);n===t&&ee[t]&&(n=ee[t]);const c=(s==null?void 0:s.type)||(l==null?void 0:l.type)||"text";let d=s!=null&&s.options?E(s.options):(Z=l==null?void 0:l.options)==null?void 0:Z.map(o=>({value:o.value,label:i(o.label)}));const p=(s==null?void 0:s.placeholder)||(l?i(l.placeholder):""),F=d==null?void 0:d.find(o=>o.value===g[t]),f=F==null?void 0:F.subField,D=C===t;return e.jsxs("div",{className:"space-y-3",ref:o=>R.current[t]=o,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:t,className:`block text-sm font-medium mb-1 transition-colors ${D?"text-green-600 font-bold":"text-gray-700"}`,children:n}),c==="file"||r==="profilePicture"?e.jsx(Te,{value:g[t]||"",onChange:o=>v(t,o)}):c==="select"&&d?e.jsxs("select",{id:t,name:t,value:g[t]||"",onChange:o=>v(o.target.name,o.target.value),onFocus:()=>y(t),onBlur:()=>y(null),className:`block w-full px-3 py-2 bg-white border-2 rounded-md transition-all outline-none ${D?"border-green-500 ring-2 ring-green-200 shadow-md":"border-gray-300"}`,required:!0,children:[e.jsx("option",{value:"",children:"-- اختر --"}),d.map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))]}):c==="textarea"?e.jsx("textarea",{id:t,name:t,value:g[t]||"",onChange:o=>v(o.target.name,o.target.value),onFocus:()=>y(t),onBlur:()=>y(null),placeholder:p,className:`w-full p-2 border-2 rounded-md transition-all outline-none ${D?"border-green-500 ring-2 ring-green-200 shadow-md":"border-gray-300"}`,rows:3,required:!0}):e.jsx("input",{type:c,id:t,name:t,value:g[t]||"",onChange:o=>v(o.target.name,o.target.value),onFocus:()=>y(t),onBlur:()=>y(null),placeholder:p,className:`w-full p-2 border-2 rounded-md transition-all outline-none ${D?"border-green-500 ring-2 ring-green-200 shadow-md":"border-gray-300"}`,required:!0})]}),f&&e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200 animate-fadeIn ml-4 border-r-4 border-r-blue-400",children:[e.jsx("label",{htmlFor:`${t}_sub`,className:"block text-sm font-bold text-blue-800 mb-1",children:f.customQuestion||f.placeholder||"يرجى التحديد:"}),f.type==="select"&&f.options?e.jsxs("select",{id:`${t}_sub`,name:`${t}_sub`,value:g[`${t}_sub`]||"",onChange:o=>v(o.target.name,o.target.value),className:"block w-full px-3 py-2 bg-white border border-blue-300 rounded-md shadow-sm",required:!0,children:[e.jsx("option",{value:"",children:"-- اختر --"}),E(f.options).map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))]}):e.jsx("input",{type:f.type||"text",id:`${t}_sub`,name:`${t}_sub`,value:g[`${t}_sub`]||"",onChange:o=>v(o.target.name,o.target.value),placeholder:f.placeholder||f.customQuestion||"",className:"block w-full px-3 py-2 bg-white border border-blue-300 rounded-md",required:!0})]})]},t)}),Array.isArray(a.complexFields)&&a.complexFields.map(t=>e.jsxs("div",{className:"border-2 border-blue-100 p-4 rounded-lg bg-blue-50 mt-6",children:[e.jsx("label",{className:"block font-bold text-gray-800 mb-3 border-b border-blue-200 pb-2",children:t.label}),e.jsx("div",{className:"space-y-3",children:(M[t.id]||[]).map((r,l)=>e.jsxs("div",{className:"bg-white p-3 rounded shadow-sm border relative",children:[e.jsx("button",{type:"button",onClick:()=>me(t.id,l),className:"absolute top-2 left-2 text-red-400 hover:text-red-600",children:e.jsx(Fe,{size:12})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 pr-4",children:t.itemFields.map(s=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:s.label}),s.type==="select"&&s.options?e.jsxs("select",{value:r[s.id]||"",onChange:n=>J(t.id,l,s.id,n.target.value),className:"w-full p-1 border rounded text-sm",children:[e.jsx("option",{value:"",children:"-- اختر --"}),s.options.map(n=>e.jsx("option",{value:n.value,children:n.label},n.value))]}):e.jsx("input",{type:s.type||"text",value:r[s.id]||"",onChange:n=>J(t.id,l,s.id,n.target.value),placeholder:s.label||"",className:"w-full p-1 border rounded text-sm"})]},s.id))})]},l))}),e.jsxs("button",{type:"button",onClick:()=>de(t.id),className:"mt-3 text-sm flex items-center gap-1 text-blue-600 font-semibold hover:text-blue-800",children:[e.jsx(ke,{})," ",t.addItemButtonLabel||"إضافة عنصر جديد"]})]},t.id)),e.jsx("div",{className:"pt-4",children:e.jsxs("button",{type:"submit",className:"w-full flex items-center justify-center gap-3 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors text-lg",children:[e.jsx(Ee,{}),e.jsx("span",{children:"إنشاء المستند"})]})})]})]})}),e.jsxs("aside",{className:"flex flex-col w-full xl:w-80 gap-6 xl:sticky xl:top-24 order-3 xl:order-none",children:[e.jsx(k,{placement:"PUBLIC_FORM_LEFT"}),S&&e.jsx("div",{className:"p-6 bg-blue-50 border border-blue-200 rounded-xl shadow-sm text-center",children:e.jsxs("div",{className:"text-blue-900 font-amiri leading-loose",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 border-b border-green-200 pb-2",children:i("adPage.prayerReminderTitle")}),e.jsx("p",{className:"text-lg mb-2",children:i("adPage.hadithIntro")}),e.jsxs("p",{className:"text-xl font-bold mb-4",children:['"',i("adPage.prayerHadithContent"),'"']}),e.jsx("p",{className:"text-xs text-blue-700",children:i("adPage.prayerHadithSource")})]})})]})]})};export{Ue as default};
