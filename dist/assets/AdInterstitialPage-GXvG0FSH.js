import{b as z,a as M,u as X,c as G,r as n,j as e,F as A,L as J,e as Y,B as q,k as K,D as Q}from"./index-hpjxKmld.js";import{A as C}from"./AdBanner-Asof6Iy0.js";import{c as E}from"./fileUtils-Cb1IM2ig.js";import{g as V}from"./doc-generator-Ct1URtxh.js";import{asBlob as Z}from"https://esm.sh/html-docx-js-typescript@0.1.5";import ee from"https://esm.sh/file-saver@2.0.5";import"./constants-DfStgaks.js";import"./geminiService-DifXNJPz.js";const ce=()=>{const{countryCode:p,docId:i}=z(),O=M(),{staticDocuments:g,documents:h,fullDocuments:w,siteSettings:N,loading:u}=X(),{t:o}=G(),[b,R]=n.useState(null),[f,D]=n.useState(!0);n.useEffect(()=>{(async()=>{if(!i)return;if(g.some(l=>l.id===i||l.slug===i)){D(!1);return}D(!0);try{const l=h.find(d=>d.id===i||d.slug===i)||w.find(d=>d.id===i||d.slug===i),c=(l==null?void 0:l.slug)||i,r=(l==null?void 0:l.countryCode)||p;let m=`https://datas.gitut.com/data/json/documents/${c}.json`;r&&r!=="global"&&(m=`https://datas.gitut.com/data/json/documents/${r}/${c}.json`);const S=await fetch(m);if(S.ok){const d=await S.json();R(d)}else console.warn(`Failed to fetch document JSON from ${m}: ${S.status}`)}catch(l){console.error("Error fetching document details:",l)}finally{D(!1)}})()},[i,g,h,w,p]);const t=n.useMemo(()=>{const s=decodeURIComponent(i||"");if(b)return{...b,serviceType:"doc"};const a=g.find(r=>r.id===s||r.slug===s);if(a)return{...a,serviceType:"static-doc"};const l=w.find(r=>r.id===s||r.slug===s);if(l)return{...l,serviceType:"doc"};const c=h.find(r=>r.id===s||r.slug===s);return c?{...c,serviceType:"doc"}:null},[g,h,w,i,b]),j=(N==null?void 0:N.ads.pdfInterstitialTimer)??5,[x,v]=n.useState(j),[T,H]=n.useState(!1),F=n.useRef(null),[B,P]=n.useState(!1),[y,I]=n.useState({active:!1,format:null}),[k,U]=n.useState(!1),$=n.useMemo(()=>t?t.serviceType==="static-doc"&&t.fileUrl?E(t.fileUrl):t.serviceType==="doc"&&"previewTemplateUrl"in t&&t.previewTemplateUrl?E(t.previewTemplateUrl):"#":"#",[t]);n.useEffect(()=>{!u&&!f&&t&&v(j)},[u,f,t,j]),n.useEffect(()=>{const s=a=>{F.current&&!F.current.contains(a.target)&&P(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const W=async s=>{if(!(k||!t||t.serviceType!=="doc"||!s)){U(!0);try{const a=b||t,l=[a];if(s==="pdf")await V(l,t.id,{},{action:"download",targetLang:"ar",templateType:"preview"});else if(s==="word"){let c="previewTemplateHtml"in a?a.previewTemplateHtml:"";if(!c&&"previewTemplateUrl"in a&&a.previewTemplateUrl){const r=await fetch(E(a.previewTemplateUrl));r.ok&&(c=await r.text())}if(!c)throw new Error("Could not load Word template content.");try{const r=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${t.name}</title></head><body>${c}</body></html>`,m=await Z(r,{orientation:"portrait",margins:{top:720,right:720,bottom:720,left:720}});if(m)ee.saveAs(m,`${t.slug||"document"}.docx`);else throw new Error("Failed to generate DOCX blob.")}catch(r){console.error("Error generating DOCX:",r),alert("فشل إنشاء ملف Word. يرجى المحاولة مرة أخرى.")}}}catch(a){console.error("Failed to download document:",a),alert("فشل في تحميل المستند.")}finally{U(!1),I({active:!1,format:null})}}};n.useEffect(()=>{if(!(u||f||!t)){if(y.active)if(x>0){const s=setTimeout(()=>v(a=>a-1),1e3);return()=>clearTimeout(s)}else W(y.format);else if(!T)if(x>0){const s=setTimeout(()=>v(a=>a-1),1e3);return()=>clearTimeout(s)}else H(!0)}},[x,u,f,t,T,y]);const L=s=>{P(!1),I({active:!0,format:s}),v(j)},_=()=>{if(!t)return;const s=!t.countryCode||t.countryCode==="global",a=s?"/go-to-site/internal-form":`/${p}/go-to-site/internal-form`,l=s?`/public-form/${t.slug||t.id}`:`/${p}/public-form/${t.slug||t.id}`;O(a,{state:{targetUrl:l,siteName:`تعبئة نموذج: ${t.name}`}})};if(u||f)return e.jsxs("div",{className:"flex flex-col items-center justify-center p-10 text-center",children:[e.jsx(A,{className:"animate-spin text-4xl text-green-600 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"جاري تحميل المستند..."})]});if(!t)return e.jsxs("div",{className:"text-center py-20",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"لم يتم العثور على المستند"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"عذراً، لم نتمكن من العثور على الصفحة التي تبحث عنها."}),e.jsx(J,{to:"/",className:"bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors",children:"العودة إلى الصفحة الرئيسية"})]});if(T){const s=()=>t.serviceType==="doc"&&"previewTemplateHtml"in t&&t.previewTemplateHtml?e.jsx("iframe",{srcDoc:t.previewTemplateHtml,title:t.name,className:"w-full h-full border-0"}):$!=="#"?e.jsx("iframe",{src:$,title:t.name,className:"w-full h-full border-0"}):e.jsx("div",{className:"flex items-center justify-center h-full p-8 text-center",children:e.jsx("p",{className:"text-gray-600 text-lg",children:o("serviceDetailPage.noPreview")})});return e.jsxs(e.Fragment,{children:[y.active&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 z-[100] flex justify-center items-center p-4",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg border space-y-4 max-w-3xl mx-auto text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:o("adPage.preparing")}),e.jsx("p",{className:"text-gray-600",children:o("adPage.autoDisplay")}),e.jsx("div",{className:"text-5xl font-bold text-green-600 font-mono tracking-widest my-4 p-4 bg-gray-100 rounded-lg",children:k?e.jsx(A,{className:"animate-spin"}):x}),e.jsxs("div",{className:"pt-6 border-t",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:o("adPage.adLabel")}),e.jsx(C,{placement:"PDF_INTERSTITIAL"})]})]})}),e.jsxs("div",{className:"flex h-[85vh] gap-4",children:[e.jsxs("aside",{className:"w-64 flex-shrink-0 bg-white rounded-lg shadow-lg border p-4 flex flex-col",children:[e.jsxs("div",{className:"flex-grow space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-center border-b pb-3",children:o("adPage.optionsTitle")}),t.serviceType==="doc"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:_,className:"w-full flex items-center justify-center gap-2 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors",children:[e.jsx(Y,{}),e.jsx("span",{children:o("adPage.fillDownload")})]}),e.jsxs("div",{ref:F,className:"relative",children:[e.jsxs("button",{onClick:()=>P(a=>!a),className:"w-full flex items-center justify-center gap-2 bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors",children:[e.jsx(q,{}),e.jsx("span",{children:o("adPage.downloadBlank")})]}),B&&e.jsx("div",{className:"absolute bottom-full right-0 mb-2 w-full bg-white rounded-lg shadow-xl border z-10",children:e.jsxs("ul",{className:"py-1",children:[e.jsx("li",{children:e.jsxs("button",{onClick:()=>L("pdf"),className:"w-full text-right flex items-center gap-3 px-4 py-2 hover:bg-gray-100",children:[e.jsx(K,{className:"text-red-500"}),e.jsx("span",{children:o("adPage.downloadPdf")})]})}),e.jsx("li",{children:e.jsxs("button",{onClick:()=>L("word"),className:"w-full text-right flex items-center gap-3 px-4 py-2 hover:bg-gray-100",children:[e.jsx(Q,{className:"text-blue-500"}),e.jsx("span",{children:o("adPage.downloadWord")})]})})]})})]})]})]}),e.jsx("div",{className:"mt-6 pt-6 border-t",children:e.jsx(C,{placement:"PROFILE_SIDEBAR"})})]}),e.jsx("main",{className:"flex-1 bg-white p-2 rounded-lg shadow-lg border h-full",children:s()})]})]})}return e.jsx("div",{className:"max-w-3xl mx-auto text-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg border space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:o("adPage.preparing")}),e.jsx("p",{className:"text-gray-600",children:o("adPage.autoDisplay")}),e.jsx("div",{className:"text-5xl font-bold text-green-600 font-mono tracking-widest my-4 p-4 bg-gray-100 rounded-lg",children:x}),e.jsxs("div",{className:"pt-6 border-t",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:o("adPage.adLabel")}),e.jsx(C,{placement:"PDF_INTERSTITIAL"})]})]})})};export{ce as default};
