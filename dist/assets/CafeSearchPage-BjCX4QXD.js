import{c as A,j as e,L as w,x as B,n as K,a as W,b as G,u as H,r as c,C as J,F as O,m as Q,p as X}from"./index-hpjxKmld.js";import{c as Y}from"./fileUtils-Cb1IM2ig.js";const Z=({cafe:a,linkTo:f,linkState:x,isOnline:m})=>{const{t:l}=A(),y="https://images.unsplash.com/photo-1554118811-1e0d58224f24?auto=format&fit=crop&w=800&q=80",j=a.address.commune&&a.address.wilaya?`${a.address.commune}, ${a.address.wilaya}`:`${a.address.city||""}, ${a.address.state||""}`.replace(/^,|,$/g,"").trim(),o=`/${a.countryCode}/profile/${a.numericId}`;return e.jsxs("article",{className:"bg-white rounded-lg shadow-md overflow-hidden transition-transform hover:scale-105 duration-300 flex flex-col",children:[e.jsx("img",{src:Y(a.imageUrl)||y,alt:a.name,className:"w-full h-48 object-cover",onError:v=>{v.currentTarget.src=y}}),e.jsxs("div",{className:"p-4 flex flex-col flex-grow",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-1",children:a.name}),m!==void 0&&e.jsxs("div",{className:"flex items-center gap-2 mb-2 bg-gray-50 p-1 rounded-md w-fit pr-3",children:[e.jsx("span",{className:`w-3 h-3 rounded-full border border-white shadow-sm transition-colors duration-500 ${m===null?"bg-yellow-400 animate-pulse":m?"bg-green-500":"bg-gray-400"}`}),e.jsx("span",{className:"text-xs font-semibold text-gray-700",children:l(m===null?"cafeCard.checkingStatus":m?"cafeCard.online":"cafeCard.offline")})]}),e.jsxs("p",{className:"text-gray-600 mb-1 text-sm",children:[e.jsx("span",{className:"font-semibold",children:l("cafeCard.owner")})," ",a.owner]}),e.jsxs("p",{className:"text-gray-600 mb-2 text-sm",children:[e.jsx("span",{className:"font-semibold",children:l("cafeCard.address")})," ",j]}),a.distance!==void 0&&e.jsx("div",{className:"mb-4",children:e.jsxs("span",{className:"inline-block bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-1 rounded-full",children:["~ ",a.distance.toFixed(1)," ",l("cafeCard.distanceUnit")]})}),e.jsx("p",{className:"text-gray-700 mb-4 flex-grow line-clamp-2",children:a.description}),e.jsxs("div",{className:"mt-auto flex gap-2",children:[f?e.jsx(w,{to:f,state:x,className:"block text-center flex-grow font-semibold py-2 px-4 rounded-lg transition-colors bg-green-600 text-white hover:bg-green-700",children:l("cafeCard.chooseThisCafe")}):e.jsx(w,{to:o,className:"block text-center flex-grow font-semibold py-2 px-4 rounded-lg transition-colors bg-gray-200 text-gray-800 hover:bg-gray-300",children:l("cafeCard.viewDetails")}),e.jsx(w,{to:o,state:{openChat:!0},className:"flex-shrink-0 flex items-center justify-center bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors",title:l("cafeCard.startChat"),children:e.jsx(B,{})})]})]})]})},i=a=>a?a.replace(/[أإآ]/g,"ا").replace(/ة/g,"ه").toLowerCase():"",ee=({cafe:a,linkTo:f,linkState:x})=>{const{usePresence:m}=X(),{isOnline:l}=m(a.id);return e.jsx(Z,{cafe:a,linkTo:f,linkState:x,isOnline:l})},ae=()=>{const a=K(),f=W(),{countryCode:x}=G(),{documents:m,sites:l,communes:y,cafes:j}=H(),{documentIds:o}=a.state||{documentIds:[]},[v,$]=c.useState(!1),[I,k]=c.useState([]),[T,E]=c.useState(!1),z=c.useMemo(()=>{const s=m.filter(n=>o.includes(n.id)).map(n=>({...n,serviceType:"doc"})),r=l.filter(n=>o.includes(n.id)).map(n=>({...n,serviceType:"site"}));return[...s,...r]},[o,m,l]),[C,p]=c.useState([]),[S,b]=c.useState(!1),[u,F]=c.useState(""),[D,_]=c.useState([]),[P,N]=c.useState(!1);c.useEffect(()=>{x?(k(j),p(j),b(!0)):o.length>0&&$(!0)},[x,j,o]);const M=async s=>{$(!1),E(!0),b(!1),p([]);try{const r=await fetch(`https://datas.gitut.com/data/json/${s}-cafes-public.json`);if(!r.ok)throw new Error("Failed to load cafes for selected country.");const n=await r.json();k(n),p(n),b(!0)}catch(r){console.error(r),alert("حدث خطأ أثناء تحميل قائمة المقاهي لهذا البلد."),f("/")}finally{E(!1)}},h=c.useMemo(()=>o&&o.length>0?I:[],[o,I]);c.useEffect(()=>{if(!u.trim()){_([]);return}const s=[],r=[],n=new Set,d=i(u);if(/^\d+$/.test(u)){const t=parseInt(u,10),g=h.find(q=>q.numericId===t);g&&s.push({type:"cafe",data:g})}h.forEach(t=>{!s.some(g=>g.data.id===t.id)&&(i(t.name).includes(d)||i(t.owner).includes(d))&&s.push({type:"cafe",data:t})}),y.forEach(t=>{const g=`${t.wilaya_name}, ${t.daira_name}, ${t.name}`;n.has(g)||(i(t.name).includes(d)||i(t.daira_name).includes(d)||i(t.wilaya_name).includes(d))&&(r.push({type:"commune",data:t}),n.add(g))}),_([...s,...r].slice(0,15))},[u,h,y]);const R=s=>{if(s.preventDefault(),N(!1),!u.trim()){p(h),b(!0);return}const r=i(u),d=/^\d+$/.test(u.trim())?parseInt(u.trim(),10):null,L=h.filter(t=>d!==null&&t.numericId===d||i(t.name).includes(r)||i(t.owner).includes(r)||t.address.wilaya&&i(t.address.wilaya).includes(r)||t.address.daira&&i(t.address.daira).includes(r)||t.address.commune&&i(t.address.commune).includes(r));p(L),b(!0)},U=s=>{F(""),N(!1),b(!0);const r=s.type==="cafe"?s.data.countryCode:x||"dz";if(s.type==="cafe")f(`/${r}/form`,{state:{cafeId:s.data.id,selectedDocIds:o}});else if(s.type==="commune"){const n=h.filter(d=>d.address.commune===s.data.name&&d.address.daira===s.data.daira_name&&d.address.wilaya===s.data.wilaya_name);p(n)}},V=s=>{switch(s.type){case"cafe":return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold",children:s.data.name}),e.jsxs("span",{className:"text-xs text-gray-500",children:[s.data.address.commune," - البحث بالاسم/الرقم"]})]});case"commune":return`${s.data.wilaya_name}, ${s.data.daira_name}, ${s.data.name}`}};return o.length===0?e.jsxs("div",{className:"text-center py-20",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"خطأ: لم يتم تحديد أي خدمة."}),e.jsx("p",{className:"text-gray-600 mb-6",children:"يرجى العودة والبحث عن مستند أو موقع أولاً."}),e.jsx(w,{to:`/${x||""}`,className:"bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700",children:"العودة إلى صفحة البحث"})]}):v?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-[100] flex justify-center items-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 w-full max-w-sm",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-center",children:"في أي بلد تبحث عن مقهى؟"}),e.jsx("ul",{className:"space-y-2 max-h-72 overflow-y-auto",children:J.ar.map(s=>e.jsx("li",{children:e.jsxs("button",{onClick:()=>M(s.code),className:"w-full text-right flex items-center gap-3 px-4 py-3 bg-gray-50 rounded-lg hover:bg-gray-100",children:[e.jsx("span",{className:"text-2xl",children:s.flag}),e.jsx("span",{className:"font-semibold",children:s.name})]})},s.code))})]})}):T?e.jsx("div",{className:"flex justify-center items-center p-20",children:e.jsx(O,{className:"animate-spin text-4xl text-green-600"})}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 md:p-8 text-center",children:[e.jsx(w,{to:`/${x||""}`,className:"text-green-600 hover:underline mb-4 inline-block",children:"← العودة لاختيار خدمة أخرى"}),e.jsx("h1",{className:"text-xl font-semibold text-gray-700",children:"الخطوة 2: ابحث عن مقهى لخدمة"}),e.jsx("p",{className:"text-3xl font-bold text-gray-900 mt-1",children:z.map(s=>s.name).join("، ")})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 md:p-8",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4 text-center",children:"ابحث عن مقهى"}),e.jsxs("form",{onSubmit:R,className:"relative max-w-2xl mx-auto flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-grow",children:[e.jsx(Q,{className:"absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"}),e.jsx("input",{type:"text",value:u,onChange:s=>F(s.target.value),onFocus:()=>N(!0),onBlur:()=>setTimeout(()=>N(!1),200),placeholder:"ابحث بالاسم، الرقم التعريفي، أو المنطقة (ولاية، دائرة، بلدية)...",className:"w-full p-4 pr-12 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg","aria-label":"بحث عن مقهى"}),P&&D.length>0&&e.jsx("ul",{className:"absolute top-full left-0 right-0 mt-2 bg-white border border-gray-300 rounded-lg shadow-lg z-20 max-h-80 overflow-y-auto",children:D.map((s,r)=>e.jsx("li",{className:"px-4 py-3 cursor-pointer hover:bg-green-50 border-b last:border-b-0",onMouseDown:()=>U(s),children:V(s)},`${s.type}-${s.data.id}-${r}`))})]}),e.jsx("button",{type:"submit",className:"flex-shrink-0 bg-gray-800 text-white p-4 rounded-lg hover:bg-black transition-colors","aria-label":"بحث",children:e.jsx(Q,{className:"h-6 w-6"})})]})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:S?`النتائج (${C.length})`:`مقاهي الإنترنت التي تقدم هذه الخدمة (${h.length})`}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:(S?C:h).map(s=>e.jsx(ee,{cafe:s,linkTo:`/${s.countryCode}/form`,linkState:{cafeId:s.id,selectedDocIds:o}},s.id))}),S&&C.length===0&&e.jsx("div",{className:"text-center py-10 bg-white rounded-lg shadow",children:e.jsx("p",{className:"text-gray-600 text-lg",children:"لم يتم العثور على مقاهٍ تطابق بحثك."})})]})]})};export{ae as default};
