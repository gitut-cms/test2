import{u as ae,r as h,j as s,B as le,F as V,bs as W,g as oe,C as U,bH as ne,bp as X,bA as ie,bm as I}from"./index-hpjxKmld.js";import{d as $,e as H,f as D,c as j}from"./staticHtmlGenerator-D8IoKVrH.js";import{F as ce}from"./FileSaver.min-Bnm0McdU.js";const be=({forcePublishAll:re})=>{const{services:O,siteSettings:R,pages:g,blogPosts:m,ads:Y}=ae(),[T,z]=h.useState(!1),[L,u]=h.useState(""),[k,J]=h.useState(!1),[de,Z]=h.useState(""),[_,B]=h.useState(!1),[q,v]=h.useState(""),[K,N]=h.useState(!1),A=h.useRef(null);h.useEffect(()=>{const e=t=>{A.current&&!A.current.contains(t.target)&&N(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);const Q=async()=>{var e,t;try{const[l,i]=await Promise.all([fetch("https://datas.gitut.com/data/json/site-settings-public.json?t="+Date.now()),fetch("https://datas.gitut.com/data/json/site-seo.json?t="+Date.now())]);if(!l.ok)throw new Error("Failed to fetch public settings");const c=await l.json(),S=i.ok?await i.json():{},a={...I,...R,...c,seo:{...I.seo,...S},ads:{...I.ads,...c.ads||{},items:((e=c.ads)==null?void 0:e.items)||[]}},o=((t=c.ads)==null?void 0:t.items)||[];return{settings:a,ads:o}}catch(l){return console.warn("Could not fetch public settings, falling back to context.",l),{settings:R,ads:Y}}},C=async e=>{z(!0),u("بدء إنشاء صفحات الخدمات...");try{const{settings:t,ads:l}=await Q(),i=[],c=O.filter(a=>a.serviceType!=="site");if(!e||e==="global"){u("Generating Global Services...");const a=c.filter(o=>o.slug&&(!o.countryCode||o.countryCode==="global"));if(a.length>0){const o=$(a,"global",t,g,m,l);i.push({path:"dist/services/index.html",content:j(o)});for(const n of a){const r=H(n,c,t,g,m,l,"global"),p=(n.serviceType==="static-doc","doc");i.push({path:`dist/${p}/${n.slug}/index.html`,content:j(r)});const w=D(n,c,t,g,m,l,"global");i.push({path:`dist/${p}/${n.slug}/amp/index.html`,content:j(w)})}}}const S=e&&e!=="global"?[e]:U.en.map(a=>a.code);for(const a of S){const o=c.filter(n=>n.slug&&n.countryCode===a);if(o.length>0){u(`Generating Services for ${a.toUpperCase()}...`);const n=$(o,a,t,g,m,l);i.push({path:`dist/${a}/services/index.html`,content:j(n)});for(const r of o){const p=H(r,c,t,g,m,l,a),w=(r.serviceType==="static-doc","doc");i.push({path:`dist/${a}/${w}/${r.slug}/index.html`,content:j(p)});const E=D(r,c,t,g,m,l,a);i.push({path:`dist/${a}/${w}/${r.slug}/amp/index.html`,content:j(E)})}}}i.length===0?u("لا توجد خدمات قابلة للنشر."):(u(`رفع ${i.length} ملفًا إلى GitHub (بما في ذلك نسخ AMP)...`),await X({files:i,commitMessage:"feat: Regenerate static service pages (Regular + AMP)"}),u(`تم نشر ${i.length} صفحة بنجاح!`))}catch(t){console.error(t);const l=t instanceof Error?t.message:String(t);u(`فشل: ${l}`)}finally{z(!1),setTimeout(()=>u(""),8e3)}},F=async e=>{var t,l,i,c,S,a;J(!0),Z("");try{const o=new ne,{settings:n,ads:r}=await Q(),p=O.filter(d=>d.serviceType!=="site");if(!e||e==="global"){const d=p.filter(f=>f.slug&&(!f.countryCode||f.countryCode==="global"));if(d.length>0){const f=$(d,"global",n,g,m,r);(t=o.folder("services"))==null||t.file("index.html",f);for(const b of d){const M=H(b,p,n,g,m,r,"global"),y=(b.serviceType==="static-doc","doc"),x=(l=o.folder(y))==null?void 0:l.folder(b.slug);x==null||x.file("index.html",M);const G=D(b,p,n,g,m,r,"global");(i=x==null?void 0:x.folder("amp"))==null||i.file("index.html",G)}}}const w=e&&e!=="global"?[e]:U.en.map(d=>d.code);for(const d of w){const f=p.filter(b=>b.slug&&b.countryCode===d);if(f.length>0){const b=o.folder(d);if(b){const M=$(f,d,n,g,m,r);(c=b.folder("services"))==null||c.file("index.html",M);for(const y of f){const x=H(y,p,n,g,m,r,d),G=(y.serviceType==="static-doc","doc"),P=(S=b.folder(G))==null?void 0:S.folder(y.slug);P==null||P.file("index.html",x);const te=D(y,p,n,g,m,r,d);(a=P==null?void 0:P.folder("amp"))==null||a.file("index.html",te)}}}}const E=await o.generateAsync({type:"blob"}),se=e?`gitut-service-pages-${e}.zip`:"gitut-service-pages-with-amp.zip";ce.saveAs(E,se)}catch(o){console.error(o),Z("فشل في إنشاء ملف ZIP.")}finally{J(!1)}},ee=async()=>{B(!0),v("Generating template files...");try{const e=await ie("templates-paginated","global",!0);if(e.length===0)v("No templates to publish.");else{const t=e.map(l=>({path:`data/json/templates/${l.fileName}`,content:JSON.stringify(l.data)}));v(`Uploading ${t.length} template files...`),await X({files:t,commitMessage:"feat: Update paginated templates",repoConfig:{owner:"gitut-cms",repo:"files"}}),v(`Successfully published ${t.length} template files.`)}}catch(e){console.error("Template publishing failed:",e),v(`فشل: ${e.message}`)}finally{B(!1),setTimeout(()=>v(""),8e3)}};return s.jsxs("section",{className:"bg-white p-6 rounded-lg shadow-md border",children:[s.jsx("h2",{className:"text-xl font-bold mb-4",children:"إدارة صفحات الخدمات والقوالب"}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex gap-2 p-3 bg-gray-50 rounded-md items-center",children:[s.jsx("span",{className:"font-semibold text-gray-700 flex-1",children:"صفحات الخدمات (Regular + AMP)"}),s.jsx("p",{className:"text-xs text-red-500 mx-2 font-bold",children:"ملاحظة: المواقع (Sites) لن يتم نشرها كصفحات ثابتة."}),s.jsx("button",{onClick:()=>F(),disabled:T||k,title:"تنزيل ZIP",className:"bg-gray-600 text-white font-bold p-3 rounded-lg hover:bg-gray-700 disabled:bg-gray-400",children:s.jsx(le,{})}),s.jsxs("div",{className:"relative",ref:A,children:[s.jsxs("div",{className:"flex",children:[s.jsxs("button",{onClick:()=>C("global"),disabled:T||k,className:"bg-green-600 text-white font-bold p-3 rounded-r-lg hover:bg-green-700 disabled:bg-gray-400 flex items-center gap-2",children:[T?s.jsx(V,{className:"animate-spin"}):s.jsx(W,{}),s.jsx("span",{children:"Global Only"})]}),s.jsx("button",{onClick:()=>N(!K),disabled:T||k,className:"bg-green-700 text-white font-bold p-3 rounded-l-lg hover:bg-green-800 disabled:bg-gray-500 border-r border-green-500",children:s.jsx(oe,{})})]}),K&&s.jsxs("div",{className:"absolute left-0 mt-1 w-48 bg-white rounded-md shadow-lg border z-10 max-h-60 overflow-y-auto",children:[s.jsx("button",{onClick:()=>{N(!1),C(void 0)},className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold border-b",children:"All (الكل منفصل)"}),s.jsx("button",{onClick:()=>{N(!1),C("global")},className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 border-b",children:"Global Only"}),U.en.map(e=>s.jsxs("button",{onClick:()=>{N(!1),C(e.code)},className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",children:[s.jsx("span",{children:e.flag})," ",e.name," Only"]},e.code))]})]})]}),L&&s.jsx("p",{className:"text-blue-600 text-sm mt-1 text-center",children:L}),s.jsxs("div",{className:"flex gap-2 p-3 bg-gray-50 rounded-md items-center",children:[s.jsx("span",{className:"font-semibold text-gray-700 flex-1",children:"قوالب المستندات (JSON)"}),s.jsxs("button",{onClick:ee,disabled:_,className:"bg-blue-600 text-white font-bold p-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 flex items-center gap-2",children:[_?s.jsx(V,{className:"animate-spin"}):s.jsx(W,{}),s.jsx("span",{children:"نشر القوالب"})]})]}),q&&s.jsx("p",{className:"text-blue-600 text-sm mt-1 text-center",children:q})]})]})};export{be as default};
