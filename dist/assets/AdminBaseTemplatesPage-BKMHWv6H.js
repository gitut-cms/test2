import{u as J,r as a,j as e,H as O,F as R,E as ee,G as te,P as B,g as Q,aO as U,aY as W,bQ as D,bR as se,k as le,b1 as ae,b4 as ne}from"./index-DgmZNK3x.js";import{R as L}from"./index-ChkOn_r6.js";import{d as Y}from"./geminiService-CD7J7Ty3.js";const re=h=>h.toLowerCase().trim().replace(/\s+/g,"-").replace(/[^a-z0-9\u0600-\u06FF-]/g,"");if(L.Quill){const h=L.Quill.import("attributors/style/size");h.whitelist=["8px","9px","10px","11px","12px","14px","16px","18px","20px","22px","24px","28px","36px","48px","72px"],L.Quill.register("attributors/style/size",h,!0)}const ie=({isOpen:h,onClose:k,onSave:F,initialData:m,codes:b})=>{const[u,T]=a.useState(""),[o,w]=a.useState(""),[d,p]=a.useState(""),[S,N]=a.useState(""),[r,f]=a.useState(!1),[H,v]=a.useState(null),E=a.useRef(null),P=a.useRef(null),M=a.useRef(null);a.useEffect(()=>{m?(T(m.name),w(m.previewTemplateHtml),p(m.finalTemplateHtml),N(m.textPlaceholderExample||"")):(T(""),w("<!-- كود معاينة القالب -->"),p("<!-- كود القالب النهائي -->"),N(""))},[m]),a.useEffect(()=>{const t=s=>{E.current&&!E.current.contains(s.target)&&v(null)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]);const I=(t,s)=>{var y;const i=(y=t.target.files)==null?void 0:y[0];if(!i)return;const n=new FileReader;n.onload=j=>{var g;const x=(g=j.target)==null?void 0:g.result;s==="preview"?w(x):p(x)},n.readAsText(i)},C=(t,s)=>{if(!s)return;const n=(t==="preview"?P:M).current;if(n){const y=n.selectionStart,j=n.selectionEnd,x=n.value,g=x.substring(0,y)+s+x.substring(j);t==="preview"?w(g):p(g),setTimeout(()=>{n&&(n.selectionStart=n.selectionEnd=y+s.length,n.focus())},0)}},A=t=>{const s=window.open("","_blank");s&&(s.document.write(t),s.document.close()),v(null)},$=async t=>{v(null);try{const s=document.createElement("div");s.style.width="794px",s.style.padding="20px",s.style.position="absolute",s.style.left="-9999px",s.style.backgroundColor="#fff",s.dir="rtl",s.innerHTML=t,document.body.appendChild(s);const i=await html2canvas(s,{scale:2}),n=i.toDataURL("image/png"),{jsPDF:y}=jspdf,j=new y({orientation:"portrait",unit:"pt",format:"a4"}),x=j.internal.pageSize.getWidth(),g=j.internal.pageSize.getHeight(),z=i.width,K=i.height,q=z/K,V=x/g;let G,X;q>V?(G=x,X=x/q):(X=g,G=g*q),j.addImage(n,"PNG",0,0,G,X);const Z=j.output("bloburl");window.open(Z,"_blank"),document.body.removeChild(s)}catch(s){console.error("Error generating PDF preview:",s),alert("حدث خطأ أثناء إنشاء معاينة PDF.")}},l=(t,s)=>H!==t?null:e.jsxs("div",{className:"absolute left-0 top-full mt-1 w-40 bg-white rounded-md shadow-lg border z-50 overflow-hidden animate-fadeIn",children:[e.jsxs("button",{type:"button",onClick:()=>A(s),className:"w-full text-right px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-sm text-gray-700",children:[e.jsx(se,{className:"text-orange-500"})," معاينة HTML"]}),e.jsxs("button",{type:"button",onClick:()=>$(s),className:"w-full text-right px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-sm text-gray-700",children:[e.jsx(le,{className:"text-red-500"})," معاينة PDF"]})]}),c=async t=>{t.preventDefault(),f(!0);const s=n=>n.replace(/\s{2,}/g," ").replace(/\n/g,"").trim(),i={name:u,previewTemplateHtml:s(o),finalTemplateHtml:s(d),textPlaceholderExample:S};try{m?await D.update(m.id,i):await D.create(i),F(),k()}catch(n){console.error(n),alert("فشل حفظ القالب الأساسي.")}finally{f(!1)}};return h?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4",children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-4xl",onClick:()=>v(null),children:e.jsxs("form",{onSubmit:c,onClick:t=>t.stopPropagation(),children:[e.jsx("div",{className:"p-6 border-b",children:e.jsxs("h2",{className:"text-2xl font-bold",children:[m?"تعديل":"إضافة"," قالب أساسي"]})}),e.jsx("div",{className:"p-6 space-y-4 max-h-[70vh] overflow-y-auto",children:r&&!m?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(R,{className:"animate-spin text-3xl text-gray-400"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"base-template-name",className:"block text-sm font-medium text-gray-700 mb-1",children:"اسم القالب الأساسي"}),e.jsx("input",{type:"text",id:"base-template-name",value:u,onChange:t=>T(t.target.value),required:!0,className:"w-full p-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"base-template-example",className:"block text-sm font-medium text-gray-700 mb-1",children:"مثال النص المتغير (للمساعدة بالذكاء الاصطناعي)"}),e.jsx("textarea",{id:"base-template-example",value:S,onChange:t=>N(t.target.value),className:"w-full h-24 p-2 border rounded-md",placeholder:"اكتب هنا مثالاً للنص الذي سيتم استبدال [TEXT] به. سيستخدم الذكاء الاصطناعي هذا المثال كقاعدة."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2 relative",ref:E,children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"font-semibold",children:"قالب المعاينة"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>v(H==="preview"?null:"preview"),className:"text-xs flex items-center gap-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded-md border",children:[e.jsx(B,{})," معاينة ",e.jsx(Q,{})]}),l("preview",o)]})]}),e.jsx("textarea",{ref:P,value:o,onChange:t=>w(t.target.value),className:"w-full h-64 p-2 border rounded-md font-mono text-sm",dir:"ltr"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("label",{className:"text-sm bg-gray-200 text-gray-800 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 cursor-pointer",children:[e.jsx(U,{className:"inline-block"})," رفع ملف HTML ",e.jsx("input",{type:"file",accept:".html",onChange:t=>I(t,"preview"),className:"hidden"})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("select",{onChange:t=>{C("preview",t.target.value),t.target.value=""},className:"text-sm bg-gray-100 text-gray-800 font-semibold py-1 px-2 rounded-lg hover:bg-gray-200 cursor-pointer border border-gray-300",children:[e.jsx("option",{value:"",children:"إدراج رمز..."}),b.map(t=>e.jsxs("option",{value:t.key,children:[t.description," (",t.key,")"]},t.id))]}),e.jsx("button",{type:"button",onClick:()=>C("preview","[TITLE]"),className:"text-sm bg-yellow-100 text-yellow-800 font-semibold py-1 px-3 rounded-lg hover:bg-yellow-200",children:"إدراج [TITLE]"}),e.jsx("button",{type:"button",onClick:()=>C("preview","[TEXT]"),className:"text-sm bg-blue-100 text-blue-800 font-semibold py-1 px-3 rounded-lg hover:bg-blue-200",children:"إدراج [TEXT]"})]})]})]}),e.jsxs("div",{className:"space-y-2 relative",ref:E,children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"font-semibold",children:"القالب النهائي"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>v(H==="final"?null:"final"),className:"text-xs flex items-center gap-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded-md border",children:[e.jsx(B,{})," معاينة ",e.jsx(Q,{})]}),l("final",d)]})]}),e.jsx("textarea",{ref:M,value:d,onChange:t=>p(t.target.value),className:"w-full h-64 p-2 border rounded-md font-mono text-sm",dir:"ltr"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("label",{className:"text-sm bg-gray-200 text-gray-800 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 cursor-pointer",children:[e.jsx(U,{className:"inline-block"})," رفع ملف HTML ",e.jsx("input",{type:"file",accept:".html",onChange:t=>I(t,"final"),className:"hidden"})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("select",{onChange:t=>{C("final",t.target.value),t.target.value=""},className:"text-sm bg-gray-100 text-gray-800 font-semibold py-1 px-2 rounded-lg hover:bg-gray-200 cursor-pointer border border-gray-300",children:[e.jsx("option",{value:"",children:"إدراج رمز..."}),b.map(t=>e.jsxs("option",{value:t.key,children:[t.description," (",t.key,")"]},t.id))]}),e.jsx("button",{type:"button",onClick:()=>C("final","[TITLE]"),className:"text-sm bg-yellow-100 text-yellow-800 font-semibold py-1 px-3 rounded-lg hover:bg-yellow-200",children:"إدراج [TITLE]"}),e.jsx("button",{type:"button",onClick:()=>C("final","[TEXT]"),className:"text-sm bg-blue-100 text-blue-800 font-semibold py-1 px-3 rounded-lg hover:bg-blue-200",children:"إدراج [TEXT]"})]})]})]})]})]})}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:k,className:"bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300",children:"إلغاء"}),e.jsx("button",{type:"submit",disabled:r&&!m,className:"bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700",children:r?"جاري الحفظ...":"حفظ"})]})]})})}):null},_={toolbar:[[{header:[1,2,3,4,5,6,!1]}],[{font:[]}],["bold","italic","underline","strike","blockquote"],[{list:"ordered"},{list:"bullet"},{indent:"-1"},{indent:"+1"}],[{direction:"rtl"},{align:[]}],[{color:[]},{background:[]}],["link","image","video"],["clean"]]},oe=({isOpen:h,onClose:k,onSave:F,fullDocuments:m})=>{const{baseTemplates:b}=J(),[u,T]=a.useState(""),[o,w]=a.useState(""),[d,p]=a.useState("dz"),[S,N]=a.useState(""),[r,f]=a.useState(""),[H,v]=a.useState(!1),[E,P]=a.useState(!1),[M,I]=a.useState(!1),C=async()=>{if(!o||!d){alert("يرجى إدخال اسم المستند ورمز البلد أولاً.");return}P(!0),N("");try{const l=b.find(s=>s.id===u);let c="";l!=null&&l.textPlaceholderExample?c=`أنت مساعد ذكاء اصطناعي متخصص في الوثائق الرسمية. مهمتك هي إعادة صياغة مثال نصي عام لإنشاء وصف موجز ومفيد لمستند جديد. يجب أن يشرح الوصف الغرض من المستند وكيفية استخدامه، بتنسيق HTML بسيط (فقرات <p> وقوائم <ul>).

اسم المستند الجديد: "${o}"
رمز البلد: "${d}"
المثال العام لإعادة صياغته: "${l.textPlaceholderExample}"

أعد صياغة المثال ليصبح وصفًا للمستند الجديد.`:c=`اكتب وصفًا موجزًا ومفيدًا لمستند رسمي أو إداري يسمى "${o}" في بلد رمزه "${d}". اشرح الغرض من هذا المستند، وكيف يمكن للمواطنين الحصول عليه أو استخدامه. يجب أن يكون الوصف بتنسيق HTML بسيط (فقرات <p> وقوائم <ul>).`;const t=await Y({model:"gemini-2.5-flash",contents:c});N(t.text||"")}catch(l){console.error("AI description generation failed:",l),alert("فشل إنشاء الوصف.")}finally{P(!1)}},A=async()=>{if(!o){alert("يرجى إدخال اسم المستند أولاً.");return}const l=b.find(c=>c.id===u);I(!0),f("");try{let c="";l!=null&&l.textPlaceholderExample?c=`You are an assistant for official documents in Arabic. Your task is to adapt a generic text example to fit a specific document title. The output must be simple HTML.
    Document Title: "${o}"
    Country Code: "${d}"
    Generic Text Example to Adapt: "${l.textPlaceholderExample}"
    
    Rewrite the generic text example to be specific and appropriate for the given document title and country. For example, if the title is "Request to change address", the text should be a formal request for an address change. Return only the generated HTML content, without any explanations.`:c=`اكتب محتوى نصي (بتنسيق HTML بسيط مثل الفقرات <p> والقوائم <ul>) لمستند رسمي أو إداري يسمى "${o}" في بلد رمزه "${d}". النص يجب أن يكون مناسبًا ليحل محل علامة [TEXT] النائبة في قالب.`;const t=await Y({model:"gemini-2.5-flash",contents:c});f(t.text||"")}catch(c){console.error("AI text generation failed:",c),alert("فشل إنشاء النص.")}finally{I(!1)}},$=async l=>{l.preventDefault();const c=b.find(i=>i.id===u);if(!c||!o.trim()||!r.trim()){alert("يرجى ملء جميع الحقول.");return}v(!0);let t=re(o);if(m.find(i=>i.slug===t)){if(!window.confirm("يوجد مستند آخر بنفس الاسم (أو ينتج عنه نفس الرابط). هل تريد المتابعة وإنشاء نسخة جديدة برابط فريد؟")){v(!1);return}const n=Date.now().toString().slice(-6);t=`${t}-${n}`}try{const i=z=>z.replace(/\s{2,}/g," ").replace(/\n/g,"").trim(),n=c.previewTemplateHtml.replace(/\[TEXT\]/g,r).replace(/\[TITLE\]/g,o),y=c.finalTemplateHtml.replace(/\[TEXT\]/g,r).replace(/\[TITLE\]/g,o),j=ae(y),x=t,g={name:o,groupId:x,slug:t,description:S,countryCode:d||void 0,requiredFields:j,previewTemplateHtml:i(n),finalTemplateHtml:i(y),tags:c.name};await ne.create({...g,id:x}),F(),k()}catch(i){console.error("Failed to create document from base template:",i),alert("فشل إنشاء المستند.")}finally{v(!1)}};return h?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4",children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl",children:e.jsxs("form",{onSubmit:$,children:[e.jsx("div",{className:"p-6 border-b",children:e.jsx("h2",{className:"text-2xl font-bold",children:"إنشاء قالب جديد من قالب أساسي"})}),e.jsxs("div",{className:"p-6 space-y-4 max-h-[70vh] overflow-y-auto",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"اختر القالب الأساسي"}),e.jsxs("select",{value:u,onChange:l=>T(l.target.value),required:!0,className:"w-full p-2 border rounded-md bg-white",children:[e.jsx("option",{value:"",disabled:!0,children:"-- اختر --"}),b.map(l=>e.jsx("option",{value:l.id,children:l.name},l.id))]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"اسم القالب الجديد"}),e.jsx("input",{type:"text",value:o,onChange:l=>w(l.target.value),required:!0,className:"w-full p-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"كود البلد (مثال: dz)"}),e.jsx("input",{type:"text",value:d,onChange:l=>p(l.target.value.toLowerCase()),className:"w-full p-2 border rounded-md"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"وصف القالب"}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(L,{theme:"snow",value:S,onChange:N,modules:_})}),e.jsx("button",{type:"button",onClick:C,disabled:E,className:"p-2 bg-purple-100 text-purple-700 rounded-md hover:bg-purple-200",title:"إنشاء وصف بالذكاء الاصطناعي",children:E?e.jsx(R,{className:"animate-spin"}):e.jsx(W,{})})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"النص الذي سيتم استبدال [TEXT] به"}),e.jsxs("button",{type:"button",onClick:A,disabled:M,className:"flex items-center gap-1 text-xs bg-purple-100 text-purple-700 font-semibold py-1 px-2 rounded-md hover:bg-purple-200",children:[M?e.jsx(R,{className:"animate-spin"}):e.jsx(W,{}),e.jsx("span",{children:"إنشاء بالذكاء الاصطناعي"})]})]}),e.jsx(L,{theme:"snow",value:r,onChange:f,modules:_})]})]}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:k,className:"bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300",children:"إلغاء"}),e.jsx("button",{type:"submit",disabled:H,className:"bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700",children:H?"جاري الإنشاء...":"إنشاء القالب"})]})]})})}):null},xe=()=>{const{baseTemplates:h,loading:k,codes:F,fullDocuments:m}=J(),[b,u]=a.useState(!1),[T,o]=a.useState(!1),[w,d]=a.useState(null),p=async()=>{},S=async r=>{u(!0),d({...r,name:"جاري التحميل..."});try{const f=await D.get(r.id);d(f||r)}catch(f){console.error("Failed to fetch fresh template:",f),d(r),alert("Could not fetch the latest template data. Displaying cached version.")}},N=async r=>{window.confirm("هل أنت متأكد من حذف هذا القالب الأساسي؟")&&(await D.delete(r),p())};return e.jsxs("div",{children:[b&&e.jsx(ie,{isOpen:b,onClose:()=>{u(!1),d(null)},onSave:p,initialData:w,codes:F}),T&&e.jsx(oe,{isOpen:T,onClose:()=>o(!1),onSave:p,fullDocuments:m}),e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"إدارة القوالب الأساسية"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>o(!0),className:"bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700",children:[e.jsx(O,{className:"inline-block"})," إنشاء قالب"]}),e.jsxs("button",{onClick:()=>{d({id:"",name:"جاري التحميل...",previewTemplateHtml:"",finalTemplateHtml:""}),u(!0)},className:"bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700",children:[e.jsx(O,{className:"inline-block"})," إضافة قالب أساسي"]})]})]}),e.jsx("div",{className:"bg-white p-2 rounded-lg border shadow-sm",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-right",children:[e.jsx("thead",{className:"bg-gray-50 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"اسم القالب الأساسي"}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"إجراءات"})]})}),e.jsx("tbody",{children:k?e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"text-center p-6",children:e.jsx(R,{className:"animate-spin text-2xl mx-auto"})})}):h.map(r=>e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"p-3 font-semibold",children:r.name}),e.jsxs("td",{className:"p-3 space-x-4 space-x-reverse",children:[e.jsxs("button",{onClick:()=>S(r),className:"text-blue-600 hover:underline text-sm font-semibold",children:[e.jsx(ee,{className:"inline-block"})," تعديل"]}),e.jsxs("button",{onClick:()=>N(r.id),className:"text-red-600 hover:underline text-sm font-semibold",children:[e.jsx(te,{className:"inline-block"})," حذف"]})]})]},r.id))})]})})})]})};export{xe as default};
