import{r,j as e,w as T,az as U,i as f,aA as b,aB as J,aC as B,aD as L}from"./index-DrB1YgVl.js";const k=window.SpeechRecognition||window.webkitSpeechRecognition,y=!!k,G=({formFields:j,onFieldUpdate:w})=>{const[o,l]=r.useState("idle"),[m,x]=r.useState(""),[a,S]=r.useState(!1),[v,p]=r.useState(null),[h,E]=r.useState("ar-SA"),[g,N]=r.useState("voice"),[d,R]=r.useState(""),n=r.useRef(null),u=r.useRef(""),I=r.useRef(o);r.useEffect(()=>{I.current=o},[o]);const A=r.useRef(w);A.current=w;const C=async t=>{if(t.trim()){S(!0),p(null);try{const s=`You are an AI assistant processing a user's speech or text transcript to fill a web form.
**IMPORTANT RULES:**
1.  When the user says or writes the Arabic word "اروباز", you MUST interpret and write it as the "@" symbol.
2.  If you identify an email address, you MUST format it using only English letters, numbers, and standard symbols (like '@', '.', '-'). Do NOT use Arabic characters for the email address. For example, if the user says "بريدي الإلكتروني هو مستخدم اروباز مثال دوت كوم", the value for the email field should be "mustakhdim@mithal.com" or a similar valid email format, not "مستخدم@مثال.كوم".

**TASK:**
Based on the user's transcript and the list of available form fields, identify the target field(s) and the corresponding value(s).
- User Transcript: "${t}"
- Available Fields: ${JSON.stringify(j)}

The user might mention multiple fields in one sentence. Your response must be a JSON array of objects, where each object contains a "fieldId" and a "value". For example: [{ "fieldId": "fullName", "value": "John Doe" }, { "fieldId": "email", "value": "john.doe@example.com" }]. If no fields are mentioned, return an empty array.`,i=await L(t,j,{type:"ARRAY",items:{type:"OBJECT",properties:{fieldId:{type:"STRING"},value:{type:"STRING"}}}},s);Array.isArray(i)&&i.length>0?A.current(i):console.log("AI did not find any fields to update from transcript:",t)}catch(s){console.error("Error processing transcript with AI:",s);const c=s instanceof Error?s.message:"An unknown error occurred.";p(`فشل فهم النص: ${c}`)}finally{S(!1)}}};r.useEffect(()=>{if(!y)return;const t=new k;return n.current=t,t.continuous=!0,t.interimResults=!0,t.onresult=s=>{let c="";for(let i=s.resultIndex;i<s.results.length;++i)s.results[i].isFinal?u.current+=s.results[i][0].transcript+" ":c+=s.results[i][0].transcript;x(u.current+c)},t.onerror=s=>{console.error("Speech recognition error:",s.error),p(`خطأ في الميكروفون: ${s.error}`),l("idle")},t.onend=()=>{I.current==="recording"&&l("paused")},()=>{t.abort()}},[y]);const P=()=>{n.current&&(u.current="",x(""),n.current.lang=h,n.current.start(),l("recording"))},M=()=>{n.current&&(l("paused"),n.current.stop())},$=()=>{n.current&&(n.current.lang=h,n.current.start(),l("recording"))},F=async()=>{n.current&&(l("idle"),n.current.stop(),m.trim()&&await C(m),x(""),u.current="")},D=async()=>{d.trim()&&(await C(d),R(""))},O=()=>{switch(o){case"recording":return e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{type:"button",onClick:M,className:"flex-1 flex items-center justify-center gap-2 p-2 bg-yellow-500 text-white font-semibold rounded-md hover:bg-yellow-600",children:[e.jsx(B,{})," ",e.jsx("span",{children:"إيقاف مؤقت"})]}),e.jsxs("button",{type:"button",onClick:F,disabled:a,className:"flex-1 flex items-center justify-center gap-2 p-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 disabled:bg-gray-400",children:[a?e.jsx(f,{className:"animate-spin"}):e.jsx(b,{}),e.jsx("span",{children:"إنهاء ومعالجة"})]})]});case"paused":return e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{type:"button",onClick:$,className:"flex-1 flex items-center justify-center gap-2 p-2 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600",children:[e.jsx(J,{})," ",e.jsx("span",{children:"استئناف"})]}),e.jsxs("button",{type:"button",onClick:F,disabled:a,className:"flex-1 flex items-center justify-center gap-2 p-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 disabled:bg-gray-400",children:[a?e.jsx(f,{className:"animate-spin"}):e.jsx(b,{}),e.jsx("span",{children:"إنهاء ومعالجة"})]})]});case"idle":default:return e.jsxs("button",{type:"button",onClick:P,disabled:a,className:"w-full flex items-center justify-center gap-3 p-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 disabled:bg-gray-400",children:[e.jsx(T,{}),e.jsx("span",{children:"بدء الإملاء لملء النموذج"})]})}};return e.jsxs("div",{className:"space-y-3 p-3 bg-gray-100 rounded-md border my-4",children:[e.jsxs("div",{className:"flex border border-gray-300 rounded-md overflow-hidden",children:[e.jsxs("button",{onClick:()=>N("voice"),className:`flex-1 p-2 text-center font-semibold flex items-center justify-center gap-2 ${g==="voice"?"bg-green-600 text-white":"bg-gray-200 text-gray-700"}`,children:[e.jsx(T,{}),e.jsx("span",{children:"صوت"})]}),e.jsxs("button",{onClick:()=>N("text"),className:`flex-1 p-2 text-center font-semibold flex items-center justify-center gap-2 ${g==="text"?"bg-green-600 text-white":"bg-gray-200 text-gray-700"}`,children:[e.jsx(U,{}),e.jsx("span",{children:"نص"})]})]}),g==="voice"?e.jsx(e.Fragment,{children:y?e.jsxs(e.Fragment,{children:[o!=="idle"&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"النص المباشر:"}),e.jsx("div",{className:"mt-1 p-2 bg-white border rounded-md min-h-[60px] text-gray-800 text-right",children:m||e.jsx("span",{className:"text-gray-400",children:"..."})})]}),e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("div",{className:"flex-grow",children:O()}),e.jsxs("select",{value:h,onChange:t=>E(t.target.value),disabled:o!=="idle"||a,className:"bg-white border border-gray-300 rounded-md px-2 py-1 text-sm disabled:bg-gray-200","aria-label":"اختر لغة الإدخال الصوتي",children:[e.jsx("option",{value:"ar-SA",children:"العربية"}),e.jsx("option",{value:"en-US",children:"English"}),e.jsx("option",{value:"fr-FR",children:"Français"})]})]})]}):e.jsx("div",{className:"p-3 bg-yellow-100 text-yellow-800 text-center rounded-md",children:"الإدخال الصوتي غير مدعوم في هذا المتصفح."})}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("textarea",{value:d,onChange:t=>R(t.target.value),placeholder:"أو اكتب طلبك هنا... مثال: الاسم هو جون دو، البريد الإلكتروني user اروباز example.com",className:"w-full p-2 border border-gray-300 rounded-md",rows:3,disabled:a}),e.jsxs("button",{type:"button",onClick:D,disabled:a||!d.trim(),className:"w-full flex items-center justify-center gap-3 p-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 disabled:bg-gray-400",children:[a?e.jsx(f,{className:"animate-spin"}):e.jsx(b,{}),e.jsx("span",{children:"معالجة النص"})]})]}),v&&e.jsx("p",{className:"text-red-600 text-sm mt-2",children:v})]})};export{G as S};
