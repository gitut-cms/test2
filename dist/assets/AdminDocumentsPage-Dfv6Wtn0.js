import{u as et,r as d,c as Tt,a as St,j as e,F as _,aY as ce,bs as tt,H as Ne,bL as Ot,C as st,bM as It,l as kt,$ as Ft,bd as Ht,bN as Et,_ as Dt,P as Ee,a6 as At,z as Mt,A as zt,b0 as Ut,bO as Lt,b4 as ee,bm as De,bp as he,b1 as Ae,bP as $t,G as Me,bu as Jt,bo as Rt}from"./index-DgmZNK3x.js";import{R as we}from"./index-ChkOn_r6.js";import{d as Le}from"./geminiService-CD7J7Ty3.js";import{e as ze,d as Ue,c as te}from"./staticHtmlGenerator-DCfPfK21.js";if(we.Quill){const x=we.Quill.import("attributors/style/size");x.whitelist=["8px","9px","10px","11px","12px","14px","16px","18px","20px","22px","24px","28px","36px","48px","72px"],we.Quill.register("attributors/style/size",x,!0)}const Ce=x=>x.toLowerCase().trim().replace(/\s+/g,"-").replace(/[^a-z0-9\u0600-\u06FF-]/g,""),Pt=x=>{let E=`<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
`;return x.forEach(M=>{E+=`  <url><loc>${M}</loc></url>
`}),E+="</urlset>",E},V=x=>{if(!x)return x;const M=x.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim().split(" ").length;let S="12pt",O="1.5";M>300?(S="11pt",O="1.1"):M>200?(S="12pt",O="1.3"):(S="14pt",O="1.6");const I=`
        .content, body { font-size: ${S} !important; line-height: ${O} !important; }
        ${M>300?"ul, ol { margin-top: 5px; margin-bottom: 5px; } li { margin-bottom: 2px; }":""}
    `;return x.includes("</style>")?x.replace("</style>",`${I}</style>`):x.includes("</head>")?x.replace("</head>",`<style>${I}</style></head>`):`<style>${I}</style>`+x},Gt=({isOpen:x,fieldId:E,onClose:M,onSave:S})=>{const[O,I]=d.useState("text"),[D,A]=d.useState(""),[$,T]=d.useState(""),[k,q]=d.useState("simple"),[y,Q]=d.useState([]),[z,J]=d.useState(""),[C,H]=d.useState([]),[v,B]=d.useState(""),[R,U]=d.useState("");d.useEffect(()=>{x&&(I("text"),Q([]),J(""),H([]),A(""),T(""),q("simple"),B(""),U(""))},[x,E]);const Y=()=>{z.trim()&&(Q([...y,z.trim()]),J(""))},Te=l=>{Q(y.filter((r,o)=>o!==l))},se=()=>{H([...C,{label:"",value:""}])},ie=(l,r,o)=>{const b=[...C];b[l]={...b[l],[r]:o},r==="label"&&!b[l].value&&(b[l].value=Ce(o)),H(b)},F=l=>{const r=[...C];r[l].subField?(delete r[l].subField,delete r[l].outputTemplate):(r[l].subField={type:"text",customQuestion:""},r[l].outputTemplate=`${r[l].label} {subValue}`),H(r)},pe=(l,r,o)=>{const b=[...C];b[l].subField&&(b[l].subField={...b[l].subField,[r]:o}),H(b)},oe=l=>{const r=[...C];r[l].mappedValues={...r[l].mappedValues,"":""},H(r)},W=(l,r,o,b)=>{const K=[...C],L={...K[l].mappedValues};r!==o&&delete L[r],L[o]=b,K[l].mappedValues=L,H(K)},X=(l,r)=>{const o=[...C],b={...o[l].mappedValues};delete b[r],o[l].mappedValues=b,H(o)},le=l=>{H(C.filter((r,o)=>o!==l))},me=()=>{const l={type:O};if(D.trim()&&(l.customQuestion=D),$.trim()&&(l.placeholder=$),O==="select")if(k==="simple")l.options=y;else if(k==="builder"){const r=C.filter(o=>o.label.trim()!=="");l.options=r}else try{const r=JSON.parse(v);if(!Array.isArray(r))throw new Error("JSON must be an array.");l.options=r}catch(r){U(r.message);return}S(l)};return x?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-[100] flex justify-center items-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl animate-fadeIn max-h-[90vh] overflow-y-auto",onClick:l=>l.stopPropagation(),children:[e.jsx("div",{className:"p-4 border-b bg-gray-50 rounded-t-lg",children:e.jsxs("h3",{className:"text-lg font-bold text-gray-800",children:["إعداد الحقل: ",e.jsx("span",{className:"text-blue-600 font-mono",dir:"ltr",children:E})]})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"نوع الحقل"}),e.jsxs("select",{value:O,onChange:l=>I(l.target.value),className:"w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none",children:[e.jsx("option",{value:"text",children:"نص عادي (Text)"}),e.jsx("option",{value:"select",children:"قائمة اختيار (Select)"}),e.jsx("option",{value:"date",children:"تاريخ (Date)"}),e.jsx("option",{value:"number",children:"رقم (Number)"})]})]}),O==="select"&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-md border shadow-inner",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 border-b pb-2",children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700",children:"خيارات القائمة"}),e.jsxs("div",{className:"flex gap-1 text-xs",children:[e.jsx("button",{type:"button",onClick:()=>q("simple"),className:`px-3 py-1 rounded-full transition-colors ${k==="simple"?"bg-blue-600 text-white shadow":"bg-white text-gray-600 border"}`,children:"بسيط (نصوص)"}),e.jsxs("button",{type:"button",onClick:()=>q("builder"),className:`px-3 py-1 rounded-full transition-colors flex items-center gap-1 ${k==="builder"?"bg-purple-600 text-white shadow":"bg-white text-gray-600 border"}`,children:[e.jsx($t,{})," منشئ شرطي"]}),e.jsx("button",{type:"button",onClick:()=>q("json"),className:`px-3 py-1 rounded-full transition-colors ${k==="json"?"bg-gray-800 text-white shadow":"bg-white text-gray-600 border"}`,children:"كود JSON"})]})]}),k==="simple"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx("input",{type:"text",value:z,onChange:l=>J(l.target.value),className:"flex-grow p-2 border rounded-md text-sm",placeholder:"أضف خيار...",onKeyDown:l=>l.key==="Enter"&&Y()}),e.jsx("button",{onClick:Y,className:"bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700",children:e.jsx(Ne,{})})]}),e.jsxs("ul",{className:"space-y-1 max-h-48 overflow-y-auto",children:[y.map((l,r)=>e.jsxs("li",{className:"flex justify-between items-center bg-white p-2 rounded text-sm border shadow-sm",children:[e.jsx("span",{children:l}),e.jsx("button",{onClick:()=>Te(r),className:"text-red-500 hover:text-red-700",children:e.jsx(Me,{size:12})})]},r)),y.length===0&&e.jsx("p",{className:"text-xs text-gray-400 text-center py-2",children:"لا توجد خيارات مضافة."})]})]}),k==="builder"&&e.jsxs("div",{className:"space-y-3 max-h-[50vh] overflow-y-auto pr-1",children:[C.map((l,r)=>e.jsxs("div",{className:"bg-white border rounded-lg p-3 shadow-sm relative group",children:[e.jsx("button",{onClick:()=>le(r),className:"absolute top-2 left-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(Me,{})}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"اسم الخيار (يظهر للزبون)"}),e.jsx("input",{className:"w-full p-1 border rounded text-sm bg-gray-50 focus:bg-white focus:ring-1 focus:ring-purple-500",value:l.label,onChange:o=>ie(r,"label",o.target.value),placeholder:"مثال: متزوج"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"القيمة (Value)"}),e.jsx("input",{className:"w-full p-1 border rounded text-sm font-mono text-gray-600",value:l.value,onChange:o=>ie(r,"value",o.target.value),placeholder:"auto-generated"})]})]}),e.jsxs("div",{className:"mt-2 pt-2 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] font-bold text-blue-700",children:"قيم متغيرة (Mapped Values)"}),e.jsxs("button",{type:"button",onClick:()=>oe(r),className:"text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded hover:bg-blue-200",children:[e.jsx(Ne,{className:"inline"})," إضافة"]})]}),l.mappedValues&&Object.entries(l.mappedValues).map(([o,b],K)=>e.jsxs("div",{className:"flex gap-1 mb-1 items-center",children:[e.jsx("input",{className:"w-1/3 p-1 text-xs border rounded bg-gray-50 font-mono",placeholder:"المفتاح (Key)",value:o,onChange:L=>W(r,o,L.target.value,b)}),e.jsx("span",{className:"text-gray-400",children:"="}),e.jsx("input",{className:"flex-grow p-1 text-xs border rounded",placeholder:"القيمة (Value)",value:b,onChange:L=>W(r,o,o,L.target.value)}),e.jsx("button",{type:"button",onClick:()=>X(r,o),className:"text-red-400 hover:text-red-600 px-1",children:e.jsx(Me,{size:10})})]},K)),(!l.mappedValues||Object.keys(l.mappedValues).length===0)&&e.jsx("p",{className:"text-[10px] text-gray-400 italic",children:"لا توجد قيم مرتبطة."})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2 mt-2 pt-2 border-t",children:[e.jsx("input",{type:"checkbox",id:`toggle-sub-${r}`,checked:!!l.subField,onChange:()=>F(r),className:"rounded text-purple-600 focus:ring-purple-500"}),e.jsx("label",{htmlFor:`toggle-sub-${r}`,className:"text-xs font-semibold text-gray-700 cursor-pointer select-none",children:"تفعيل سؤال فرعي لهذا الخيار؟ (مثال: عدد الأولاد)"})]}),l.subField&&e.jsxs("div",{className:"bg-purple-50 p-3 rounded border border-purple-100 mt-2 animate-fadeIn",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-2",children:[e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"text-[10px] text-purple-800 font-bold block",children:"نوع السؤال الفرعي"}),e.jsxs("select",{className:"w-full p-1 border rounded text-xs bg-white",value:l.subField.type,onChange:o=>pe(r,"type",o.target.value),children:[e.jsx("option",{value:"text",children:"نص"}),e.jsx("option",{value:"number",children:"رقم"}),e.jsx("option",{value:"date",children:"تاريخ"}),e.jsx("option",{value:"select",children:"قائمة فرعية"})]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"text-[10px] text-purple-800 font-bold block",children:"نص السؤال الفرعي"}),e.jsx("input",{className:"w-full p-1 border rounded text-xs",value:l.subField.customQuestion||"",onChange:o=>pe(r,"customQuestion",o.target.value),placeholder:"مثال: كم عدد الأولاد؟"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] text-purple-800 font-bold block mb-1",children:"صيغة الإخراج النهائية (Template)"}),e.jsx("div",{className:"flex gap-2",children:e.jsx("input",{className:"flex-grow p-1 border rounded text-xs",value:l.outputTemplate||"",onChange:o=>ie(r,"outputTemplate",o.target.value),placeholder:"مثال: متزوج وله {subValue} أولاد"})}),e.jsxs("p",{className:"text-[10px] text-gray-500 mt-1",children:["استخدم ",e.jsx("code",{children:"{subValue}"})," لدمج إجابة الزائر في الجملة. استخدم ",e.jsx("code",{children:"{self}"})," لاسم الخيار."]})]})]})]},r)),e.jsxs("button",{onClick:se,className:"w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-purple-500 hover:text-purple-600 hover:bg-purple-50 transition-colors flex items-center justify-center gap-2 font-semibold",children:[e.jsx(Ne,{})," إضافة خيار جديد"]})]}),k==="json"&&e.jsxs(e.Fragment,{children:[e.jsx("textarea",{value:v,onChange:l=>B(l.target.value),className:"w-full h-48 p-2 border rounded-md text-xs font-mono bg-gray-900 text-green-400",placeholder:`[
  { "value": "male", "label": "رجل", "mappedValues": { "opponent_role": "المحامي" } },
  { "value": "female", "label": "امرأة", "mappedValues": { "opponent_role": "المحامية" } }
]`,dir:"ltr"}),R&&e.jsx("p",{className:"text-red-600 text-xs mt-1 font-bold",children:R})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"سؤال مخصص (يظهر للزبون)"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("input",{type:"text",value:D,onChange:l=>A(l.target.value),className:"flex-grow p-2 border rounded-md",placeholder:"مثال: ما هو الاسم الكامل؟"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"نص توضيحي (Placeholder)"}),e.jsx("input",{type:"text",value:$,onChange:l=>T(l.target.value),className:"w-full p-2 border rounded-md",placeholder:"مثال: اكتب الاسم هنا..."})]})]}),e.jsxs("div",{className:"p-4 border-t bg-gray-50 flex justify-end gap-2 rounded-b-lg",children:[e.jsx("button",{onClick:M,className:"px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 text-gray-800 font-semibold transition-colors",children:"إلغاء"}),e.jsx("button",{onClick:me,className:"px-4 py-2 bg-green-600 rounded-md hover:bg-green-700 text-white font-bold transition-colors",children:"حفظ وإدراج"})]})]})}):null},_t=({isOpen:x,onClose:E,onGenerate:M})=>{const[S,O]=d.useState(""),[I,D]=d.useState("dz"),[A,$]=d.useState(!1),[T,k]=d.useState(""),q=async()=>{if(!S.trim())return;$(!0),k("");const y=`
Create a single JSON object representing a document template for the context: "${S}".
Target Country: "${I}".
Language: The content must be in the official language of ${I}.
**IMPORTANT:** Always include "[DateToday]" in the "requiredFields" array and use it in the HTML template for the date. Do NOT include it in "fieldCustomizations" as it is auto-filled.

Structure must match this TypeScript interface:
interface Document {
  id: string; // Unique, English, kebab-case (e.g., "request-form-dz")
  groupId: string; // Same as id
  name: string; // In target language
  description: string; // HTML format (<p>...</p>), detailed, in target language.
  countryCode: string; // "${I}"
  requiredFields: string[]; // Array of field keys (e.g., "fullName", "address", "DateToday", "gender")
  fieldCustomizations: {
    [key: string]: {
      type: "text" | "date" | "number" | "textarea" | "select";
      customQuestion: string; // The label/question in target language
      placeholder?: string; // Optional placeholder
      options?: Array<{ // Use this specific structure for select options
         label: string; 
         value: string;
         subField?: { // If this option needs more info
             type: "text" | "number" | "date";
             customQuestion: string;
         };
         outputTemplate?: string; // Template for final doc if subField is used
         mappedValues?: Record<string, string>; // Maps a selected option to other field values (e.g., titles)
      }>; 
    }
  };
  finalTemplateHtml: string; // The full HTML string
  previewTemplateHtml: string; // A simplified HTML string
}

CRITICAL HTML RULES:
1. The HTML must strictly follow this structure. DO NOT CHANGE THE CSS classes or layout, only the font:
<!DOCTYPE html><html lang="[LANG_CODE]" dir="[DIR]"><head><meta charset="utf-8"><link href="[FONT_URL]" rel="stylesheet"><style>@page{size:A4;margin:0}body{margin:0;padding:0;font-family:'[FONT_NAME]',serif}.page{width:210mm;height:297mm;padding:25mm;margin:0 auto;display:flex;flex-direction:column;box-sizing:border-box;background:white;overflow:hidden}.header{display:flex;justify-content:space-between;margin-bottom:20px;font-size:14pt}.title{text-align:center;font-size:22pt;font-weight:700;text-decoration:underline;margin:30px 0 50px 0}.content{flex-grow:1;font-size:18pt;line-height:2;text-align:justify}.footer{margin-top:40px;display:flex;justify-content:space-between;font-size:16pt}.signature-box{min-width:200px;text-align:center}</style></head><body><div class="page"> ... CONTENT WITH [placeholders] ... </div></body></html>

2. FONT SELECTION:
   - If Arabic (dz, sa, eg, etc): Use 'Scheherazade New', URL: 'https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap', dir="rtl"
   - If Japanese: Use 'Noto Serif JP', URL: 'https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap', dir="ltr"
   - If Latin (en, fr, etc): Use 'Merriweather', URL: 'https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap', dir="ltr"

3. DYNAMIC TYPOGRAPHY & SCALING (CRITICAL):
   - You MUST analyze the length of the generated content text.
   - **MODIFY the CSS inside the <style> tag based on content length:**
     - If content is LONG (> 300 words): Use \`.content { font-size: 11pt; line-height: 1.1; }\`
     - If content is MEDIUM (200-300 words): Use \`.content { font-size: 12pt; line-height: 1.3; }\`
     - If content is SHORT (< 200 words): Use \`.content { font-size: 14pt; line-height: 1.6; }\`
   - **GOAL:** Ensure the text fits perfectly on ONE A4 page without overflowing and without leaving too much empty space. The footer/signature MUST be visible at the bottom.
   - **LINE LIMIT (STRICT):** The total number of lines in the generated document body MUST NOT exceed 20 lines to ensure it fits perfectly on a single A4 page.

4. SPECIAL GENDER FIELDS (CRITICAL - MANDATORY):
   - **MANDATORY**: Distinguish between the Recipient and the Applicant.
   - Applicant/Sender (The person filing the doc): ALL words referring to the applicant that change with gender (e.g., 'I the undersigned', 'Born', 'Resident', 'Signer', 'Declarant') MUST be replaced with placeholders linked to the 'gender' field's mappedValues.
`;try{let z=(await Le({model:"gemini-2.5-flash",contents:y})).text||"";z=z.replace(/```json/g,"").replace(/```/g,"").trim();const J=JSON.parse(z);J.finalTemplateHtml&&(J.finalTemplateHtml=V(J.finalTemplateHtml)),M(J),E()}catch(Q){console.error("AI Generation Error:",Q),k("Failed to generate document. Please try again.")}finally{$(!1)}};return x?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-[100] flex justify-center items-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md animate-fadeIn",onClick:y=>y.stopPropagation(),children:[e.jsx("div",{className:"p-4 border-b rounded-t-lg bg-purple-50",children:e.jsxs("h3",{className:"text-lg font-bold text-purple-800 flex items-center gap-2",children:[e.jsx(Lt,{})," توليد مستند بالذكاء الاصطناعي"]})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"موضوع المستند / الاسم"}),e.jsx("input",{type:"text",value:S,onChange:y=>O(y.target.value),placeholder:"مثال: طلب عطلة أمومة، تصريح شرفي...",className:"w-full p-2 border rounded-md focus:ring-2 focus:ring-purple-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"البلد (Country Code)"}),e.jsx("input",{type:"text",value:I,onChange:y=>D(y.target.value),placeholder:"dz, fr, sa...",className:"w-full p-2 border rounded-md focus:ring-2 focus:ring-purple-500 outline-none"})]}),T&&e.jsx("p",{className:"text-red-500 text-sm",children:T})]}),e.jsxs("div",{className:"p-4 border-t bg-gray-50 flex justify-end gap-2 rounded-b-lg",children:[e.jsx("button",{onClick:E,className:"px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 text-gray-800 font-semibold transition-colors",children:"إلغاء"}),e.jsxs("button",{onClick:q,disabled:A||!S,className:"px-4 py-2 bg-purple-600 rounded-md hover:bg-purple-700 text-white font-bold transition-colors disabled:bg-gray-400 flex items-center gap-2",children:[A?e.jsx(_,{className:"animate-spin"}):e.jsx(ce,{}),e.jsx("span",{children:"توليد"})]})]})]})}):null},Yt=()=>{const{fullDocuments:x,loadingFullDocuments:E,codes:M,staticDocuments:S,sites:O,siteSettings:I,pages:D,blogPosts:A,ads:$}=et(),[T,k]=d.useState([]);Tt();const{refetchAdminData:q}=et();St();const[y,Q]=d.useState(()=>localStorage.getItem("admin_documents_country_filter")||"all"),[z,J]=d.useState(!1),[C,H]=d.useState({isOpen:!1,mode:"create",doc:null}),[v,B]=d.useState({}),[R,U]=d.useState(!1),[Y,Te]=d.useState(""),[se,ie]=d.useState({preview:"",final:""}),[F,pe]=d.useState({isOpen:!1,doc:null}),[oe,W]=d.useState(""),[X,le]=d.useState(""),[me,l]=d.useState(""),r=d.useRef(null),[o,b]=d.useState({isOpen:!1,fieldId:""}),[K,L]=d.useState(!1),[$e,Je]=d.useState(!1),[Se,Re]=d.useState({preview:"upload",final:"upload"}),[Oe,Pe]=d.useState({preview:"",final:""}),[Ge,_e]=d.useState(!1),[fe,Ve]=d.useState(null),[lt,Ie]=d.useState(!1),[ke,Fe]=d.useState(""),[Z,ue]=d.useState(null),[qe,Qe]=d.useState(!1),[He,be]=d.useState("skip"),[ne,ye]=d.useState(new Set),nt=t=>{const s=t.target.value;Q(s),localStorage.setItem("admin_documents_country_filter",s)};d.useEffect(()=>{const s=[...x].sort((n,a)=>n.name.localeCompare(a.name)).filter(n=>{const a=n.description?n.description.replace(/<[^>]*>?/gm,""):"",c=a.split(/\s+/).filter(j=>j!=="").length,m=!a||c<100,g=n.name.toLowerCase().includes(Y.toLowerCase())||n.description.toLowerCase().includes(Y.toLowerCase())||n.id.toLowerCase().includes(Y.toLowerCase()),p=y==="all"||(y==="global"?!n.countryCode||n.countryCode==="global":n.countryCode===y);return g&&p&&(!z||m)});k(s)},[x,Y,y,z]);const ge=async()=>{await q()},at=async t=>{if(window.confirm("هل أنت متأكد من أنك تريد حذف هذا المستند؟ لا يمكن التراجع عن هذا الإجراء."))try{await ee.delete(t),await ge(),alert("تم حذف المستند بنجاح.")}catch(s){console.error("Failed to delete document:",s),alert("فشل حذف المستند.")}},rt=()=>{B({id:"",name:"",groupId:"",description:"",countryCode:y!=="all"&&y!=="global"?y:"dz",requiredFields:[],complexFields:[],previewTemplateUrl:"",finalTemplateUrl:"",previewTemplateHtml:"",finalTemplateHtml:"",tags:"",slug:""}),Re({preview:"upload",final:"upload"}),Pe({preview:"",final:""}),ie({preview:"",final:""}),H({isOpen:!0,mode:"create",doc:null})},it=async t=>{B({...t});const s={preview:"upload",final:"upload"},n={preview:t.previewTemplateHtml||"",final:t.finalTemplateHtml||""};t.previewTemplateHtml&&(s.preview="code"),t.finalTemplateHtml&&(s.final="code"),Pe(n),Re(s),ie({preview:"",final:""}),H({isOpen:!0,mode:"edit",doc:t})},Be=()=>{H({isOpen:!1,mode:"create",doc:null})},de=t=>{const{name:s,value:n}=t.target;B(a=>({...a,[s]:n}))},Ye=async(t,s)=>{var p,f;const n=Rt(s),a=((p=Jt.find(j=>j.code===n))==null?void 0:p.name)||"Arabic",c=((f=st.en.find(j=>j.code===s))==null?void 0:f.name)||s,m=`
        Act as a professional technical writer and SEO specialist.
        Write a comprehensive and high-quality description for a document named "${t}".
        
        Context:
        - This document is used in: ${c}.
        - The audience is general citizens or employees.
        
        IMPORTANT RULES:
        1. Language: The content MUST be written in ${a} language.
        2. Length: The description MUST be comprehensive, high-quality, and contain MORE THAN 400 words. Be detailed, explain the purpose, the legal context (if any), and the benefits of using this template.
        3. Structure: 
            - Start IMMEDIATELY with a paragraph (<p>) defining the document. **Do NOT start with a Heading (<h1>, <h2>, etc.).**
            - Use <h3> tags for subsequent sections.
            - Use <ul> or <ol> lists where appropriate.
        4. Format: Return HTML content only.
        `;return(await Le({model:"gemini-2.5-flash",contents:m})).text||""},ot=async()=>{var t;if(!((t=v.name)!=null&&t.trim())){alert("يرجى إدخال اسم المستند أولاً.");return}_e(!0);try{const s=await Ye(v.name,v.countryCode||"dz");B(n=>({...n,description:s}))}catch(s){console.error("AI Error:",s),alert("فشل توليد الوصف. يرجى المحاولة مرة أخرى.")}finally{_e(!1)}},We=async t=>{Ve(t.id);try{const s=await Ye(t.name,t.countryCode||"dz");await ee.update(t.id,{description:s});const n={...t,description:s},a={...n,serviceType:"doc"},c=[...x.map(h=>h.id===t.id?n:h).map(h=>({...h,serviceType:"doc"})),...S.map(h=>({...h,serviceType:"static-doc"})),...O.map(h=>({...h,serviceType:"site"}))],m=I||De,g=$||[],p=t.countryCode||"global",f=p==="global",j=ze(a,c,m,D,A,g,p),P=f?`dist/doc/${t.slug||t.id}/index.html`:`dist/${p}/doc/${t.slug||t.id}/index.html`,i=c.filter(h=>h.slug&&(f?!h.countryCode||h.countryCode==="global":h.countryCode===p)),u=Ue(i,p,m,D,A,g),w=f?"dist/services/index.html":`dist/${p}/services/index.html`;await he({files:[{path:P,content:te(j)},{path:w,content:te(u)}],commitMessage:`fix: Update static page for ${t.name} with AI description`}),k(h=>h.map(G=>G.id===t.id?{...G,description:s}:G)),ge(),alert("تم توليد الوصف وتحديث صفحة المستند بنجاح!")}catch(s){console.error("Quick AI Error:",s),alert("فشل توليد الوصف التلقائي أو عملية النشر.")}finally{Ve(null)}},Xe=t=>{const{finalTemplateHtml:s,...n}=t;le(s||""),W(JSON.stringify(n,null,2)),l(""),pe({isOpen:!0,doc:t})},Ke=()=>{pe({isOpen:!1,doc:null}),W(""),le(""),l(""),b({isOpen:!1,fieldId:""})},dt=async()=>{if(F.doc){Je(!0),l("");try{const t=JSON.parse(oe),s=t.name||F.doc.name,n=t.countryCode||F.doc.countryCode||"dz",a=F.doc.id,c=`
Create a single JSON object representing a professional document template for the context: "${s}".
Target Country: "${n}".
Language: The content must be in the official language of ${n}.

**STRICT OUTPUT FORMAT RULES:**
1. THE OUTPUT MUST BE A SINGLE JSON OBJECT.
2. Structure must match this TypeScript interface:
interface Document {
  id: string; // MUST BE "${a}"
  groupId: string; // Same as id
  name: string; // In target language
  description: string; // HTML format (<p>...</p>), detailed, in target language.
  countryCode: string; // "${n}"
  requiredFields: string[]; // Array of field keys (e.g., "fullName", "address", "gender", "DateToday", "citizen_title")
  fieldCustomizations: {
    [key: string]: {
      type: "text" | "date" | "number" | "textarea" | "select";
      customQuestion: string; 
      placeholder?: string;
      options?: Array<{ label: string, value: string, mappedValues?: Record<string, string> }>;
    }
  };
  finalTemplateHtml: string; // FULL STANDALONE HTML DOCUMENT
  previewTemplateHtml: string; // SIMPLIFIED PREVIEW
}

3. **HTML TEMPLATE REQUIREMENTS (CRITICAL):**
   - The "finalTemplateHtml" MUST be a full standalone document starting with <!DOCTYPE html>.
   - Use the following CSS structure for layout:
     <style>
       @page { size: A4; margin: 0; }
       body { margin: 0; padding: 0; font-family: 'Scheherazade New', serif; }
       .page { width: 210mm; height: 297mm; padding: 25mm; margin: 0 auto; display: flex; flex-direction: column; box-sizing: border-box; background: white; overflow: hidden; }
       .header { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 14pt; }
       .title { text-align: center; font-size: 24pt; font-weight: 700; text-decoration: underline; margin: 30px 0 50px 0; }
       .content { flex-grow: 1; font-size: 18pt; line-height: 2.0; text-align: justify; }
       .footer { margin-top: 40px; display: flex; justify-content: flex-end; font-size: 16pt; }
       .signature-box { min-width: 250px; text-align: center; }
     </style>
   - Include the Google Fonts link in <head>: <link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
   - **PLACEHOLDERS:** Use bracket syntax e.g., [fullName], [address]. NEVER use double braces {{...}}.
   - Always include "[DateToday]" for the date.

4. **GENDER MAPPING (MANDATORY):**
   - Include a "gender" field in requiredFields and fieldCustomizations.
   - For "gender", provide options "male" and "female" with "mappedValues" for titles that change with gender:
     - citizen_title: (السيد / السيدة)
     - born_title: (المولود / المولودة)
     - resident_title: (الساكن / الساكنة)
     - signer_title: (أصرح بشرفي / أصرح بشرفي)
     - declarant_title: (المصرح / المصرحة)
     - holder_title: (حامل / حاملة)
   - USE these mapped placeholders (e.g., [citizen_title]) in the HTML content to ensure professional grammar.

5. **CONTENT LIMIT:** The document body content must be concise and strictly NOT exceed 20 lines to fit on one A4 page.
`;let g=(await Le({model:"gemini-3-flash-preview",contents:c})).text||"";g=g.replace(/```json/g,"").replace(/```/g,"").trim();const p=JSON.parse(g);p.id=a,p.finalTemplateHtml&&(p.finalTemplateHtml=V(p.finalTemplateHtml));const{finalTemplateHtml:f,...j}=p;le(f||""),W(JSON.stringify(j,null,2)),alert("تمت إعادة توليد المحتوى بنجاح. يمكنك المعاينة ثم الحفظ.")}catch(t){console.error("AI Regeneration Error in Split View:",t),l(t.message||"Failed to regenerate with AI"),alert(`فشل إعادة التوليد: ${t.message}`)}finally{Je(!1)}}},Ze=t=>{if(!F.doc||T.length===0)return;const s=T.findIndex(c=>{var m;return c.id===((m=F.doc)==null?void 0:m.id)});if(s===-1)return;let n;t==="next"?n=(s+1)%T.length:n=(s-1+T.length)%T.length;const a=T[n];Xe(a)},ct=()=>{let t=v.finalTemplateHtml;if(!t&&Se.final==="code"&&(t=Oe.final),t||(t=se.final),!t){alert("لا يوجد محتوى HTML للمعاينة. يرجى إدخال الكود أو رفع ملف.");return}const s=window.open("","_blank");s&&(s.document.write(t),s.document.close())},pt=async()=>{if(F.doc){U(!0),l("");try{let t;try{t=JSON.parse(oe)}catch{throw new Error("Invalid JSON format in the left panel.")}const s={...t,finalTemplateHtml:X};if(s.finalTemplateHtml){const p=Ae(s.finalTemplateHtml);s.requiredFields=p,s.finalTemplateHtml=V(s.finalTemplateHtml)}if(s.id!==F.doc.id){if(!window.confirm("You changed the Document ID in the JSON. This will create a NEW document instead of updating. Continue?")){U(!1);return}await ee.create(s)}else await ee.update(F.doc.id,s);const n=`${s.slug||s.id}.json`;let a=`data/json/documents/${n}`;s.countryCode&&s.countryCode!=="global"&&(a=`data/json/documents/${s.countryCode}/${n}`);const m=(s.finalTemplateHtml||"").replace(/\[.*?\]/g,"........"),g={...s,previewTemplateHtml:te(m),finalTemplateHtml:te(s.finalTemplateHtml||"")};await he({files:[{path:a,content:JSON.stringify(g,null,2)}],commitMessage:`fix: Update JSON for ${s.name} via Split Editor`,repoConfig:{owner:"gitut-cms",repo:"files"}}),await ge(),alert("تم حفظ التغييرات وتحديث ملف الجايسون على GitHub بنجاح!"),Ke()}catch(t){console.error("Failed to save customizations:",t),l(t.message||"Failed to save."),alert(`فشل الحفظ: ${t.message}`)}finally{U(!1)}}},mt=t=>{const s=t.target.value;if(!s)return;const n=s.replace(/^\[|\]$/g,"");let a;r.current&&(a={start:r.current.selectionStart,end:r.current.selectionEnd}),b({isOpen:!0,fieldId:n,insertPoints:a}),t.target.value=""},ut=t=>{try{const s=JSON.parse(oe);if(s.fieldCustomizations=s.fieldCustomizations||{},s.fieldCustomizations[o.fieldId]=t,s.requiredFields=s.requiredFields||[],s.requiredFields.includes(o.fieldId)||s.requiredFields.push(o.fieldId),W(JSON.stringify(s,null,2)),o.insertPoints&&r.current){const n=`[${o.fieldId}]`,{start:a,end:c}=o.insertPoints,m=X.substring(0,a)+n+X.substring(c);le(m),setTimeout(()=>{const g=r.current;g&&(g.focus(),g.setSelectionRange(a+n.length,a+n.length))},0)}}catch(s){console.error("Error updating JSON from field config:",s),alert("خطأ في تحديث JSON. يرجى التأكد من صحة تنسيق JSON في اللوحة اليسرى.")}b({isOpen:!1,fieldId:""})},gt=()=>{if(!X)return;const t=X.replace(/\[.*?\]/g,".........."),s=window.open("","_blank");s&&(s.document.write(t),s.document.close())},xt=()=>{Fe(JSON.stringify([{id:"optional-id",name:"اسم المستند",groupId:"group-id",description:"<p>وصف المستند</p>",countryCode:"dz",requiredFields:["fieldName1","fieldName2"],fieldCustomizations:{fieldName1:{type:"text",customQuestion:"Question?"},fieldName2:{type:"select",options:["A","B"]}},finalTemplateHtml:"<!-- HTML content with [fieldName1] -->"}],null,2)),l(""),ue(null),be("skip"),Ie(!0)},je=()=>{Ie(!1),ue(null)},ht=t=>{if(!t)return;const s=window.open("","_blank");s&&(s.document.write(t),s.document.close())},ft=()=>{l(""),Qe(!0);try{const t=JSON.parse(ke),n=(Array.isArray(t)?t:[t]).map((a,c)=>{if(!a.name)return{status:"Error",id:`unknown-${c}`,name:"Unknown",slug:"",country:"",files:[],data:a,error:"Missing name"};let m=a.slug||Ce(a.name),g=a.id||a.groupId||m;const p=a.countryCode||"global",f=x.find(u=>u.id===g||u.slug===m);let j="New";f&&(He==="overwrite"?(j="Update",g=f.id,m=f.slug||m):j="Skip");const P=`data/json/documents/${p!=="global"?p+"/":""}${m}.json`,i=`dist/${p!=="global"?p+"/":""}doc/${m}/index.html`;return a.finalTemplateHtml&&(a.finalTemplateHtml=V(a.finalTemplateHtml)),a.previewTemplateHtml&&(a.previewTemplateHtml=V(a.previewTemplateHtml)),{status:j,id:g,name:a.name,slug:m,country:p,files:[P,i],data:{...a,id:g,slug:m,countryCode:p}}});ue(n)}catch(t){l(t.message||"Invalid JSON")}finally{Qe(!1)}},bt=async()=>{var n;if(!Z)return;const t=Z.filter(a=>a.status==="Update"&&a.data.description);let s=!1;t.length>0&&(s=window.confirm(`لقد تم العثور على ${t.length} مستند موجود مسبقاً يحتوي على وصف جديد في ملف JSON. هل تريد تحديث الأوصاف لهذه المستندات؟`)),U(!0);try{const a=[];let c=0;for(const i of Z){if(i.status==="Error")continue;if(i.status==="Skip"){c++;continue}let u={...i.data};if(i.status==="Update"){const w=x.find(h=>h.id===u.id);w&&(!s||!u.description)&&(u.description=w.description)}u.finalTemplateHtml&&(u.requiredFields=Ae(u.finalTemplateHtml),u.finalTemplateHtml=te(u.finalTemplateHtml)),u.previewTemplateHtml&&(u.previewTemplateHtml=te(u.previewTemplateHtml)),i.status==="New"?await ee.create(u):i.status==="Update"&&await ee.update(u.id,u),a.push({...u,serviceType:"doc"})}if(a.length===0){alert(`تم الانتهاء. تم تخطي ${c} مستند.`),U(!1),je();return}const m=[],g=[],p=I||De,f=$||[],j=[...x.map(i=>({...i,serviceType:"doc"})),...S.map(i=>({...i,serviceType:"static-doc"})),...O.map(i=>({...i,serviceType:"site"}))];a.forEach(i=>{const u=j.findIndex(w=>w.id===i.id);u>-1?j[u]=i:j.push(i)});const P=new Set;for(const i of Z){if(i.status==="Error"||i.status==="Skip")continue;P.add(i.country);const u=i.files[0],w=JSON.stringify({...i.data,description:((n=a.find(re=>re.id===i.id))==null?void 0:n.description)||i.data.description,previewTemplateHtml:(i.data.finalTemplateHtml||"").replace(/\[.*?\]/g,"........")},null,2);m.push({path:u,content:w});const G={...a.find(re=>re.id===i.id)||i.data,serviceType:"doc"},ae=ze(G,j,p,D,A,f,i.country),xe=i.files[1];g.push({path:xe,content:te(ae)})}for(const i of P){const u=i==="global",w=j.filter(h=>h.slug&&(u?!h.countryCode||h.countryCode==="global":h.countryCode===i));if(w.length>0){const h=Ue(w,i,p,D,A,f),G=u?"dist/services/index.html":`dist/${i}/services/index.html`;g.push({path:G,content:te(h)});const ae=new Set;ae.add(`https://gitut.com/${u?"":i+"/"}services/`),w.forEach(ve=>{const N=ve.serviceType==="site"?"site":"doc",Ct=`https://gitut.com/${u?"":i+"/"}${N}/${ve.slug}/`;ae.add(Ct)});const xe=Pt(ae),re=u?"dist/sitemap/services.xml":`dist/sitemap/${i}/services.xml`;g.push({path:re,content:xe})}}m.length>0&&await he({files:m,commitMessage:"feat: Batch update docs",repoConfig:{owner:"gitut-cms",repo:"files"}}),g.length>0&&await he({files:g,commitMessage:"feat: Publish static pages"}),await ge(),alert(`تم بنجاح! تم معالجة ${a.length} مستند.`),je()}catch(a){console.error("Bulk Import Failed:",a),l(`فشل التنفيذ: ${a.message}`)}finally{U(!1)}},yt=t=>{t.target.checked?ye(new Set(T.map(s=>s.id))):ye(new Set)},jt=t=>{const s=new Set(ne);s.has(t)?s.delete(t):s.add(t),ye(s)},vt=()=>{const t=T.filter(n=>ne.has(n.id)),s=t.map(n=>({id:n.id,name:n.name,description:n.description,countryCode:n.countryCode}));navigator.clipboard.writeText(JSON.stringify(s,null,2)),alert(`تم نسخ JSON لـ ${t.length} مستند.`)},Nt=async t=>{var s,n,a;t.preventDefault(),U(!0);try{const c={...v},m=N=>N.replace(/\s{2,}/g," ").replace(/\n/g,"").trim();let g="";Se.preview==="code"?g=Oe.preview:se.preview&&(g=se.preview),g&&(c.previewTemplateHtml=V(m(g)),c.previewTemplateUrl="");let p="";Se.final==="code"?p=Oe.final:se.final&&(p=se.final),p&&(c.finalTemplateHtml=V(m(p)),c.finalTemplateUrl=""),c.finalTemplateHtml&&(c.requiredFields=Ae(c.finalTemplateHtml)),c.slug=(s=v.slug)!=null&&s.trim()?Ce(v.slug):Ce(v.name||"");let f;if(C.mode==="create"){const N=((n=v.id)==null?void 0:n.trim())||((a=v.groupId)==null?void 0:a.trim())||c.slug;c.id=N,c.groupId||(c.groupId=N),f=await ee.create(c)}else if(C.doc)await ee.update(C.doc.id,c),f={...C.doc,...c};else throw new Error("Invalid modal state");const j={...f,serviceType:"doc"},P=[...x.map(N=>N.id===f.id?f:N).map(N=>({...N,serviceType:"doc"})),...S.map(N=>({...N,serviceType:"static-doc"})),...O.map(N=>({...N,serviceType:"site"}))],i=I||De,u=$||[],w=f.countryCode||"global",h=w==="global",G=ze(j,P,i,D,A,u,w),ae=h?`dist/doc/${f.slug||f.id}/index.html`:`dist/${w}/doc/${f.slug||f.id}/index.html`,xe=P.filter(N=>N.slug&&(h?!N.countryCode||N.countryCode==="global":N.countryCode===w)),re=Ue(xe,w,i,D,A,u),ve=h?"dist/services/index.html":`dist/${w}/services/index.html`;await he({files:[{path:ae,content:m(G)},{path:ve,content:m(re)}],commitMessage:`fix: Update static page for ${f.name} via Manual Edit`}),await ge(),alert("تم حفظ المستند ونشر الصفحة بنجاح!"),Be()}catch(c){console.error("Failed to save document:",c),alert("فشل حفظ المستند.")}finally{U(!1)}},wt=t=>{t.finalTemplateHtml&&(t.finalTemplateHtml=V(t.finalTemplateHtml)),t.previewTemplateHtml&&(t.previewTemplateHtml=V(t.previewTemplateHtml)),Fe(JSON.stringify(t,null,2)),Ie(!0),be("skip"),ue(null)};return E?e.jsx("div",{className:"flex justify-center items-center p-10",children:e.jsx(_,{className:"animate-spin text-4xl text-green-600"})}):e.jsxs("div",{children:[K&&e.jsx(_t,{isOpen:K,onClose:()=>L(!1),onGenerate:wt}),e.jsxs("div",{className:"flex flex-col gap-4 mb-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between sm:items-center gap-4",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"إدارة المستندات"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>L(!0),className:"bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 shadow-sm transition-colors flex items-center",children:[e.jsx(ce,{className:"inline-block ml-2 rtl:ml-0 rtl:mr-2"}),"توليد مستند بالذكاء الاصطناعي"]}),e.jsxs("button",{onClick:xt,className:"bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-sm transition-colors flex items-center",children:[e.jsx(tt,{className:"inline-block ml-2 rtl:ml-0 rtl:mr-2"}),"إضافة/تحديث (JSON)"]}),e.jsxs("button",{onClick:rt,className:"bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 shadow-sm transition-colors flex items-center",children:[e.jsx(Ne,{className:"inline-block ml-2 rtl:ml-0 rtl:mr-2"}),"إضافة مستند يدويًا"]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-center bg-gray-50 p-4 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsx(Ot,{className:"text-gray-500"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700 whitespace-nowrap",children:"تصفية حسب البلد:"}),e.jsxs("select",{value:y,onChange:nt,className:"bg-white border border-gray-300 rounded-md py-2 px-3 text-sm focus:ring-green-500 focus:border-green-500 w-full sm:w-48",children:[e.jsx("option",{value:"all",children:"كل الدول (All)"}),e.jsx("option",{value:"global",children:"عالمي (Global)"}),st.en.map(t=>e.jsxs("option",{value:t.code,children:[t.name," (",t.code.toUpperCase(),")"]},t.code))]})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto bg-white px-3 py-2 rounded-md border",children:[e.jsx("input",{type:"checkbox",id:"short-desc-filter",checked:z,onChange:t=>J(t.target.checked),className:"h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500"}),e.jsx("label",{htmlFor:"short-desc-filter",className:"text-sm font-semibold text-gray-700 cursor-pointer select-none",children:"المستندات التي تحتوي وصف قصير فقط"})]}),e.jsx("div",{className:"w-full relative",children:e.jsx("input",{type:"text",placeholder:"ابحث بالاسم، المعرف، أو الوصف...",value:Y,onChange:t=>Te(t.target.value),className:"w-full p-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"})})]})]}),ne.size>0&&e.jsxs("div",{className:"sticky top-0 z-10 bg-blue-50 border border-blue-200 p-3 mb-4 rounded-lg flex justify-between items-center shadow-sm animate-fadeIn",children:[e.jsxs("span",{className:"font-bold text-blue-800",children:["تم تحديد ",ne.size," مستند"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:vt,className:"flex items-center gap-2 bg-white border border-blue-300 text-blue-700 px-3 py-1 rounded hover:bg-blue-100",children:[e.jsx(It,{})," نسخ JSON"]}),e.jsx("button",{onClick:()=>ye(new Set),className:"text-gray-500 hover:text-gray-700 px-2",children:"إلغاء التحديد"})]})]}),e.jsx("div",{className:"bg-white p-2 rounded-lg border shadow-sm",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-right",children:[e.jsx("thead",{className:"bg-gray-50 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 w-10",children:e.jsx("input",{type:"checkbox",onChange:yt,checked:T.length>0&&ne.size===T.length,className:"w-4 h-4 rounded text-green-600 focus:ring-green-500"})}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"اسم المستند"}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"البلد"}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"ID / Group ID"}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"الوصف"}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"إجراءات"})]})}),e.jsx("tbody",{children:T.map(t=>{const s=t.description?t.description.replace(/<[^>]*>?/gm,""):"",n=s.split(/\s+/).filter(m=>m!=="").length,a=!s||s.trim().length===0,c=n<100;return e.jsxs("tr",{className:`border-b hover:bg-gray-50 ${ne.has(t.id)?"bg-blue-50":""}`,children:[e.jsx("td",{className:"p-3",children:e.jsx("input",{type:"checkbox",checked:ne.has(t.id),onChange:()=>jt(t.id),className:"w-4 h-4 rounded text-green-600 focus:ring-green-500"})}),e.jsx("td",{className:"p-3 text-gray-800 font-semibold",children:t.name}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-bold ${t.countryCode==="dz"?"bg-green-100 text-green-800":t.countryCode==="global"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:t.countryCode?t.countryCode.toUpperCase():"ALL"})}),e.jsxs("td",{className:"p-3 text-gray-500 font-mono text-xs",children:[t.id,e.jsx("br",{}),t.groupId!==t.id&&`(${t.groupId})`]}),e.jsx("td",{className:"p-3 text-gray-600 text-sm",children:e.jsx("div",{className:"flex flex-col gap-2",children:a?e.jsxs("button",{onClick:()=>We(t),disabled:fe===t.id,className:"text-purple-600 hover:text-purple-800 flex self-start items-center gap-1 bg-purple-50 px-2 py-1 rounded-md text-xs font-bold border border-purple-200",title:"توليد وصف تلقائي بالذكاء الاصطناعي",children:[fe===t.id?e.jsx(_,{className:"animate-spin"}):e.jsx(ce,{}),e.jsx("span",{children:"توليد وصف"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"prose prose-sm max-w-none line-clamp-2",dangerouslySetInnerHTML:{__html:t.description}}),e.jsxs("button",{onClick:()=>We(t),disabled:fe===t.id,className:"text-purple-600 hover:text-purple-800 flex self-start items-center gap-1 bg-white px-2 py-1 rounded-md text-[10px] font-bold border border-purple-100 hover:bg-purple-50 transition-colors",title:"إعادة توليد الوصف بالذكاء الاصطناعي (أكثر من 400 كلمة)",children:[fe===t.id?e.jsx(_,{className:"animate-spin"}):e.jsx(ce,{}),e.jsx("span",{children:c?"توليد وصف طويل":"إعادة توليد وصف"})]})]})})}),e.jsxs("td",{className:"p-3 space-x-4 space-x-reverse whitespace-nowrap",children:[t.slug&&e.jsx("a",{href:`/${t.countryCode||"dz"}/doc/${t.slug}/`,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline text-sm font-semibold",children:"معاينة"}),e.jsx("button",{onClick:()=>it(t),className:"text-green-600 hover:underline text-sm font-semibold",children:"تعديل"}),e.jsx("button",{onClick:()=>Xe(t),className:"text-purple-600 hover:underline text-sm font-semibold",children:"تخصيص (Split)"}),e.jsx("button",{onClick:()=>at(t.id),className:"text-red-600 hover:underline text-sm font-semibold",children:"حذف"})]})]},t.id)})})]})})}),lt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-5xl h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"p-6 border-b flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"إضافة / تحديث مستندات (مع المعاينة والنشر)"}),e.jsx("button",{onClick:je,className:"text-gray-500 hover:text-gray-800",children:e.jsx(kt,{size:20})})]}),e.jsx("div",{className:"p-6 flex-grow overflow-y-auto",children:Z?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-bold",children:"تقرير المحاكاة (Simulation Report)"}),e.jsxs("span",{className:"text-sm text-gray-500",children:[Z.length," عنصر"]})]}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full text-right text-sm",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 border-b",children:"الحالة"}),e.jsx("th",{className:"p-3 border-b",children:"المعرف (ID)"}),e.jsx("th",{className:"p-3 border-b",children:"الاسم"}),e.jsx("th",{className:"p-3 border-b",children:"الملفات المتأثرة"}),e.jsx("th",{className:"p-3 border-b",children:"إجراءات"})]})}),e.jsx("tbody",{children:Z.map((t,s)=>e.jsxs("tr",{className:`border-b ${t.status==="New"?"bg-green-50":t.status==="Update"?"bg-yellow-50":t.status==="Skip"?"bg-gray-100 text-gray-500":t.status==="Error"?"bg-red-50":""}`,children:[e.jsxs("td",{className:"p-3 font-bold",children:[t.status==="New"&&e.jsxs("span",{className:"text-green-600 flex items-center gap-1",children:[e.jsx(Ft,{})," جديد"]}),t.status==="Update"&&e.jsxs("span",{className:"text-yellow-600 flex items-center gap-1",children:[e.jsx(Ht,{})," تحديث"]}),t.status==="Skip"&&e.jsxs("span",{className:"text-gray-500 flex items-center gap-1",children:[e.jsx(Et,{})," تم التخطي"]}),t.status==="Error"&&e.jsxs("span",{className:"text-red-600 flex items-center gap-1",children:[e.jsx(Dt,{})," خطأ"]})]}),e.jsx("td",{className:"p-3 font-mono",children:t.id}),e.jsx("td",{className:"p-3",children:t.name}),e.jsx("td",{className:"p-3 text-xs text-gray-600 dir-ltr text-left",children:t.status!=="Skip"&&t.files.map(n=>e.jsx("div",{children:n},n))}),e.jsx("td",{className:"p-3",children:t.data.finalTemplateHtml&&e.jsxs("button",{onClick:()=>ht(t.data.finalTemplateHtml),className:"text-blue-600 hover:text-blue-800 flex items-center gap-1 text-xs font-bold bg-blue-50 px-2 py-1 rounded border border-blue-200",children:[e.jsx(Ee,{})," معاينة"]})})]},s))})]})})]}):e.jsxs("div",{className:"space-y-4 h-full flex flex-col",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-md text-sm text-blue-800",children:[e.jsx("p",{className:"font-bold",children:"تعليمات:"}),e.jsxs("ul",{className:"list-disc list-inside",children:[e.jsx("li",{children:"ألصق كود JSON لمصفوفة المستندات."}),e.jsx("li",{children:"بعد التأكيد، سيتم حفظ البيانات ورفع الملفات إلى GitHub تلقائياً."})]})]}),e.jsxs("div",{className:"bg-gray-100 p-3 rounded-md border flex gap-4 items-center mb-2",children:[e.jsx("span",{className:"font-bold text-gray-700 text-sm",children:"في حال وجود مستند بنفس ID أو Slug:"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"conflict",value:"skip",checked:He==="skip",onChange:()=>be("skip")}),e.jsx("span",{children:"تجاهل (Skip)"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"conflict",value:"overwrite",checked:He==="overwrite",onChange:()=>be("overwrite")}),e.jsx("span",{children:"تحديث (Overwrite)"})]})]}),e.jsx("textarea",{value:ke,onChange:t=>Fe(t.target.value),className:"flex-grow p-4 font-mono text-sm bg-gray-900 text-green-300 rounded-md",placeholder:'[ { \\"id\\": \\"doc-id\\", \\"name\\": \\"Name\\", \\"description\\": \\"...\\" } ]',dir:"ltr"}),me&&e.jsx("p",{className:"text-red-600 font-bold",children:me})]})}),e.jsx("div",{className:"p-6 border-t bg-gray-50 flex justify-end gap-3",children:Z?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>ue(null),className:"bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg",children:"عودة للتعديل"}),e.jsxs("button",{onClick:bt,disabled:R,className:"bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 disabled:bg-gray-400 flex items-center gap-2",children:[R?e.jsx(_,{className:"animate-spin"}):e.jsx(tt,{}),e.jsx("span",{children:"تأكيد وتنفيذ النشر"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:je,className:"bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300",children:"إلغاء"}),e.jsxs("button",{onClick:ft,disabled:qe||!ke.trim(),className:"bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 flex items-center gap-2",children:[qe?e.jsx(_,{className:"animate-spin"}):e.jsx(At,{}),e.jsx("span",{children:"تحليل ومعاينة"})]})]})})]})}),C.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-start p-4",children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-4xl",children:e.jsxs("form",{onSubmit:Nt,children:[e.jsx("div",{className:"p-6 border-b",children:e.jsx("h2",{className:"text-2xl font-bold",children:C.mode==="create"?"إضافة مستند جديد":"تعديل المستند"})}),e.jsxs("div",{className:"p-6 space-y-4 max-h-[70vh] overflow-y-auto",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 mb-1",children:"اسم المستند"}),e.jsx("input",{type:"text",name:"name",id:"name",value:v.name||"",onChange:de,required:!0,className:"w-full p-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"groupId",className:"block text-sm font-medium text-gray-700 mb-1",children:"معرف المجموعة (Group ID)"}),e.jsx("input",{type:"text",name:"groupId",id:"groupId",value:v.groupId||"",onChange:de,required:!0,className:"w-full p-2 border rounded-md"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"id",className:"block text-sm font-medium text-gray-700 mb-1",children:"المعرف الفريد (ID)"}),e.jsx("input",{type:"text",name:"id",id:"id",value:v.id||"",onChange:de,disabled:C.mode==="edit",className:"w-full p-2 border rounded-md bg-gray-100 disabled:cursor-not-allowed"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"slug",className:"block text-sm font-medium text-gray-700 mb-1",children:"الرابط الدائم (Slug)"}),e.jsx("input",{type:"text",name:"slug",id:"slug",value:v.slug||"",onChange:de,className:"w-full p-2 border rounded-md"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700",children:"الوصف"}),e.jsxs("button",{type:"button",onClick:ot,disabled:Ge,className:"flex items-center gap-1 text-xs bg-purple-100 text-purple-700 font-semibold py-1 px-2 rounded-md hover:bg-purple-200 disabled:opacity-50",children:[Ge?e.jsx(_,{className:"animate-spin"}):e.jsx(ce,{}),e.jsx("span",{children:"توليد وصف بالذكاء الاصطناعي"})]})]}),e.jsx(we,{theme:"snow",value:v.description||"",onChange:t=>B(s=>({...s,description:t}))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"countryCode",className:"block text-sm font-medium text-gray-700 mb-1",children:"رمز البلد"}),e.jsx("input",{type:"text",name:"countryCode",id:"countryCode",value:v.countryCode||"",onChange:de,className:"w-full p-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tags",className:"block text-sm font-medium text-gray-700 mb-1",children:"الوسوم"}),e.jsx("input",{type:"text",name:"tags",id:"tags",value:v.tags||"",onChange:de,className:"w-full p-2 border rounded-md"})]})]}),e.jsx("div",{className:"border-t pt-4",children:e.jsxs("button",{type:"button",onClick:ct,className:"flex items-center gap-2 bg-orange-100 text-orange-700 font-semibold py-2 px-4 rounded-lg hover:bg-orange-200 border border-orange-300",children:[e.jsx(Ee,{})," معاينة القالب"]})})]}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:Be,className:"bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300",children:"إلغاء"}),e.jsx("button",{type:"submit",disabled:R,className:"bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 disabled:bg-gray-400",children:R?"جاري الحفظ...":"حفظ المستند"})]})]})})}),e.jsx(Gt,{isOpen:o.isOpen,fieldId:o.fieldId,onClose:()=>b({isOpen:!1,fieldId:""}),onSave:ut}),F.isOpen&&F.doc&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-[95%] h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-lg",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800",children:["تخصيص المستند: ",F.doc.name]}),e.jsx("p",{className:"text-sm text-gray-500",children:"قم بتعديل بيانات JSON على اليسار، والقالب النهائي HTML على اليمين."})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("div",{className:"flex gap-1 mr-4",children:[e.jsx("button",{onClick:()=>Ze("prev"),className:"p-2 rounded-full hover:bg-gray-200 text-gray-600 transition-colors",title:"المستند السابق",children:e.jsx(Mt,{})}),e.jsx("button",{onClick:gt,className:"text-blue-600 p-2 rounded-full hover:bg-blue-100 transition-colors",title:"معاينة في نافذة جديدة",children:e.jsx(Ee,{})}),e.jsx("button",{onClick:()=>Ze("next"),className:"p-2 rounded-full hover:bg-gray-200 text-gray-600 transition-colors",title:"المستند التالي",children:e.jsx(zt,{})})]}),e.jsx("div",{className:"relative",children:e.jsxs("select",{className:"bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500",onChange:mt,defaultValue:"",children:[e.jsx("option",{value:"",disabled:!0,children:"إدراج رمز..."}),M.map(t=>e.jsxs("option",{value:t.key,children:[t.description," (",t.key,")"]},t.id))]})}),e.jsxs("button",{onClick:dt,disabled:$e,className:"flex items-center gap-2 bg-purple-100 text-purple-700 border border-purple-300 px-4 py-2 rounded hover:bg-purple-200 transition-colors",children:[$e?e.jsx(_,{className:"animate-spin"}):e.jsx(ce,{}),e.jsx("span",{children:"إعادة توليد ذكي"})]}),e.jsx("button",{onClick:Ke,className:"bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition-colors",children:"إلغاء"}),e.jsxs("button",{onClick:pt,disabled:R,className:"bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition-colors flex items-center gap-2",children:[R?e.jsx(_,{className:"animate-spin"}):e.jsx(Ut,{}),e.jsx("span",{children:"حفظ التعديلات"})]})]})]}),e.jsxs("div",{className:"flex-grow flex flex-col md:flex-row overflow-hidden",children:[e.jsxs("div",{className:"w-full md:w-1/2 flex flex-col border-b md:border-b-0 md:border-r border-gray-300",children:[e.jsxs("div",{className:"bg-gray-100 p-2 text-xs font-bold text-gray-600 uppercase tracking-wider flex justify-between",children:[e.jsx("span",{children:"JSON Configuration (Metadata & Fields)"}),e.jsx("span",{className:"text-red-500",children:me})]}),e.jsx("textarea",{value:oe,onChange:t=>W(t.target.value),className:"flex-grow w-full p-4 font-mono text-sm bg-[#1e1e1e] text-[#d4d4d4] resize-none focus:outline-none",spellCheck:!1,dir:"ltr"})]}),e.jsxs("div",{className:"w-full md:w-1/2 flex flex-col",children:[e.jsx("div",{className:"bg-gray-100 p-2 text-xs font-bold text-gray-600 uppercase tracking-wider",children:"Final HTML Template (Right Side)"}),e.jsx("textarea",{ref:r,value:X,onChange:t=>le(t.target.value),className:"flex-grow w-full p-4 font-mono text-sm bg-white text-gray-800 resize-none focus:outline-none border-l",spellCheck:!1,dir:"ltr",placeholder:"ضع المؤشر هنا ثم اختر رمزاً من القائمة لإدراجه..."})]})]})]})})]})};export{Yt as default};
