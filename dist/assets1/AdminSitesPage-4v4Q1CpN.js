import{a as K,r as c,j as e,i as Z,Z as D,a3 as H,bA as v}from"./index-DrB1YgVl.js";import{R as w}from"./index-jCUXYg4f.js";import"https://esm.sh/html-docx-js-typescript@0.1.5";import"https://esm.sh/file-saver@2.0.5";if(w.Quill){const m=w.Quill.import("attributors/style/size");m.whitelist=["8px","9px","10px","11px","12px","14px","16px","18px","20px","22px","24px","28px","36px","48px","72px"],w.Quill.register("attributors/style/size",m,!0)}const f={siteId:"",siteName:"",siteUrl:"",fields:[]},z=m=>m.toLowerCase().trim().replace(/\s+/g,"-").replace(/[^a-z0-9\u0600-\u06FF-]/g,""),se=()=>{var B;const{sites:m}=K(),[S,g]=c.useState(m),[n,k]=c.useState({isOpen:!1,mode:"create",site:null}),[a,i]=c.useState({name:"",url:"",type:"template",countryCode:"",description:"",tags:"",slug:"",jsonTemplate:f}),[M,C]=c.useState(!1),[T,O]=c.useState(`[
  
]`),[J,F]=c.useState(""),[I,E]=c.useState(!1),[x,j]=c.useState("builder"),[R,y]=c.useState(""),[N,p]=c.useState("");c.useEffect(()=>{g(m)},[m]),c.useEffect(()=>{if(n.isOpen&&a.type==="template"&&x==="builder")try{y(JSON.stringify(a.jsonTemplate||f,null,2)),p("")}catch{y("{}"),p("Error generating JSON string from form data.")}},[a.jsonTemplate,x,n.isOpen,a.type]);const $=()=>{j("builder"),i({name:"",url:"",type:"template",countryCode:"",description:"",tags:"",slug:"",jsonTemplate:f}),k({isOpen:!0,mode:"create",site:null})},U=t=>{j("builder");const l=t.jsonTemplate||{...f,siteName:t.name,siteUrl:t.url,siteId:t.id};i({...t,countryCode:t.countryCode||"",description:t.description||"",tags:t.tags||"",slug:t.slug||"",jsonTemplate:l}),y(JSON.stringify(l,null,2)),k({isOpen:!0,mode:"edit",site:t})},A=()=>{k({isOpen:!1,mode:"create",site:null})},b=(t,l,s)=>{i(r=>{var o;const d=[...((o=r.jsonTemplate)==null?void 0:o.fields)||[]];return d[t]={...d[t],[l]:s},{...r,jsonTemplate:{...r.jsonTemplate,fields:d}}})},q=()=>{i(t=>{var l;return{...t,jsonTemplate:{...t.jsonTemplate,fields:[...((l=t.jsonTemplate)==null?void 0:l.fields)||[],{fieldId:"fullName",label:"",cssSelector:"",action:"write",type:"text"}]}}})},L=t=>{i(l=>{var s;return{...l,jsonTemplate:{...l.jsonTemplate,fields:(((s=l.jsonTemplate)==null?void 0:s.fields)||[]).filter((r,d)=>d!==t)}}})},Q=t=>{const l=t.target.value;y(l);try{const s=JSON.parse(l);if(typeof s!="object"||s===null){p("Input must be a valid JSON object.");return}let r,d=!1;s.jsonTemplate&&typeof s.jsonTemplate=="object"&&Array.isArray(s.jsonTemplate.fields)?(r=s.jsonTemplate,d=!0):Array.isArray(s.fields)&&(r=s),r?(i(d?o=>({...o,name:s.name||o.name,url:s.url||o.url,countryCode:s.countryCode||o.countryCode,type:s.type==="template"?"template":o.type,description:s.description||o.description,tags:s.tags||o.tags,jsonTemplate:r}):o=>({...o,jsonTemplate:r})),p("")):p('JSON must be an object with a "fields" array, or a site object containing a "jsonTemplate" key.')}catch{p("Invalid JSON format.")}},P=async t=>{var r,d,o;if(t.preventDefault(),x==="raw"&&N){alert(`Please fix the JSON error before saving: ${N}`);return}let l=z(a.name);if((n.mode==="create"||n.mode==="edit"&&a.name!==((r=n.site)==null?void 0:r.name))&&S.find(u=>u.slug===l)){if(!window.confirm("يوجد موقع آخر بنفس الاسم (أو ينتج عنه نفس الرابط). هل تريد المتابعة وإنشاء نسخة جديدة برابط فريد؟"))return;l=`${l}-${Date.now().toString().slice(-6)}`}if((n.mode==="create"||n.mode==="edit"&&a.url!==((d=n.site)==null?void 0:d.url))&&S.find(u=>u.url===a.url)&&!window.confirm("يوجد موقع آخر بنفس الرابط. هل تريد المتابعة على أي حال؟"))return;const s={...a,slug:l,countryCode:a.countryCode||void 0,jsonTemplate:{...a.jsonTemplate||f,siteName:a.name,siteUrl:a.url,siteId:((o=n.site)==null?void 0:o.id)||a.name.toLowerCase().replace(/\s+/g,"-")}};s.type==="static"&&(s.jsonTemplate=void 0),n.mode==="create"?(await v.create(s),g(h=>[...h,{...s,id:s.name}])):n.site&&(await v.update(n.site.id,s),g(h=>h.map(u=>u.id===n.site.id?{...s,id:n.site.id}:u))),alert("تم الحفظ. قد تحتاج إلى تحديث الصفحة لرؤية التغييرات."),A()},_=t=>{window.confirm("هل أنت متأكد من أنك تريد حذف هذا الموقع؟")&&(v.delete(t),g(l=>l.filter(s=>s.id!==t)))},W=async()=>{F(""),E(!0);let t=0;try{const l=JSON.parse(T);if(!Array.isArray(l))throw new Error("The provided input must be a valid JSON array.");for(const s of l){if(!s.name||!s.url||!s.type){console.warn("Skipping invalid site object in bulk add:",s);continue}const r={...s,slug:z(s.name)};await v.create(r),g(d=>[...d,{...r,id:r.name}]),t++}alert(`تمت إضافة ${t} موقعًا بنجاح.`),C(!1),O(`[
  
]`)}catch(l){F(`خطأ: ${l.message}`)}finally{E(!1)}},G=Object.keys(D);return e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"إدارة المواقع"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>C(!0),className:"bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors",children:"+ إضافة مواقع متعددة (JSON)"}),e.jsx("button",{onClick:$,className:"bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors",children:"+ إضافة موقع جديد"})]})]}),e.jsx("div",{className:"bg-white p-2 rounded-lg border shadow-sm",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-right",children:[e.jsx("thead",{className:"bg-gray-50 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"اسم الموقع"}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"النوع"}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"البلد"}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"تفاصيل"}),e.jsx("th",{className:"p-3 font-semibold text-sm text-gray-600",children:"إجراءات"})]})}),e.jsx("tbody",{children:S.map(t=>{var l,s;return e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"p-3 text-gray-800 font-semibold",children:t.name}),e.jsx("td",{className:"p-3 text-gray-600",children:t.type==="static"?"ثابت":"نموذج"}),e.jsx("td",{className:"p-3 text-gray-600",children:t.countryCode||"الكل"}),e.jsx("td",{className:"p-3 text-gray-600 text-xs",children:t.type==="template"?`${((s=(l=t.jsonTemplate)==null?void 0:l.fields)==null?void 0:s.length)||0} حقول`:"-"}),e.jsxs("td",{className:"p-3 space-x-4 space-x-reverse whitespace-nowrap",children:[t.slug&&e.jsx("a",{href:`/${t.countryCode||"dz"}/site/${t.slug}`,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline text-sm font-semibold",children:"معاينة"}),e.jsx("button",{onClick:()=>U(t),className:"text-green-600 hover:underline text-sm font-semibold",children:"تعديل"}),e.jsx("button",{onClick:()=>_(t.id),className:"text-red-600 hover:underline text-sm font-semibold",children:"حذف"})]})]},t.id)})})]})})}),M&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-3xl flex flex-col h-[90vh]",children:[e.jsx("div",{className:"p-6 border-b",children:e.jsx("h2",{className:"text-2xl font-bold",children:"إضافة مواقع متعددة عبر JSON"})}),e.jsxs("div",{className:"p-6 space-y-4 flex-grow overflow-y-auto",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"ألصق مصفوفة JSON من المواقع أدناه. سيتم إنشاء كل عنصر في المصفوفة كموقع جديد."}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bulkJson",className:"block text-sm font-medium text-gray-700 mb-1",children:"JSON Array of Sites"}),e.jsx("textarea",{id:"bulkJson",value:T,onChange:t=>O(t.target.value),className:"w-full h-96 font-mono text-sm bg-gray-900 text-green-300 p-2 rounded-md",dir:"ltr",placeholder:`[
  {
    "name": "ANEM Wassit Online",
    "url": "https://wassitonline.anem.dz/",
    "type": "template",
    "countryCode": "dz",
    "jsonTemplate": {
      "fields": [
        { "fieldId": "nationalId", "label": "NIN", "cssSelector": "#nin", "action": "write", "type": "text" },
        { "fieldId": "dob", "label": "Date of Birth", "cssSelector": "#ddn", "action": "write", "type": "date" }
      ]
    }
  },
  {
    "name": "Google",
    "url": "https://google.com",
    "type": "static"
  }
]`}),J&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:J})]})]}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:()=>C(!1),className:"bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300",children:"إلغاء"}),e.jsx("button",{type:"button",onClick:W,disabled:I,className:"bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400",children:I?e.jsx(Z,{className:"animate-spin"}):"حفظ وإضافة المواقع"})]})]})}),n.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4",children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-3xl",children:e.jsxs("form",{onSubmit:P,children:[e.jsx("div",{className:"p-6 border-b",children:e.jsx("h2",{className:"text-2xl font-bold",children:n.mode==="create"?"إضافة موقع جديد":"تعديل الموقع"})}),e.jsxs("div",{className:"p-6 space-y-4 max-h-[70vh] overflow-y-auto",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"type",className:"block text-sm font-medium text-gray-700 mb-1",children:"نوع الموقع"}),e.jsxs("select",{id:"type",value:a.type,onChange:t=>i(l=>({...l,type:t.target.value})),required:!0,className:"block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500",children:[e.jsx("option",{value:"template",children:"نموذج موقع (لتعبئة النماذج)"}),e.jsx("option",{value:"static",children:"موقع ثابت (يفتح كرابط مباشر)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"countryCode",className:"block text-sm font-medium text-gray-700 mb-1",children:"البلد (رمز، مثال: dz)"}),e.jsx("input",{type:"text",id:"countryCode",value:a.countryCode||"",onChange:t=>i(l=>({...l,countryCode:t.target.value.toLowerCase()})),placeholder:"اتركه فارغًا للكل",className:"block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 mb-1",children:"اسم الموقع"}),e.jsx("input",{type:"text",id:"name",value:a.name,onChange:t=>i(l=>({...l,name:t.target.value})),required:!0,className:"block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"url",className:"block text-sm font-medium text-gray-700 mb-1",children:"رابط الموقع (URL)"}),e.jsx("input",{type:"url",id:"url",value:a.url,onChange:t=>i(l=>({...l,url:t.target.value})),required:!0,placeholder:"https://example.com",className:"block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 mb-1",children:"وصف الموقع (لصفحة التفاصيل)"}),e.jsx(w,{theme:"snow",value:a.description||"",onChange:t=>i(l=>({...l,description:t})),modules:{toolbar:[[{size:["8px","9px","10px","11px","12px","14px","16px","18px","20px","22px","24px","28px","36px","48px","72px",!1]}],["bold","italic","underline","strike","blockquote"],[{list:"ordered"},{list:"bullet"},{indent:"-1"},{indent:"+1"}],[{direction:"rtl"},{align:[]}],["link","image","video"],["clean"]]}})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tags",className:"block text-sm font-medium text-gray-700 mb-1",children:"الوسوم (مفصولة بفاصلة)"}),e.jsx("input",{type:"text",id:"tags",value:a.tags||"",onChange:t=>i(l=>({...l,tags:t.target.value})),placeholder:"مثال: تسجيل, عمل, anem",className:"block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"تستخدم هذه الوسوم لعرض الخدمات ذات الصلة في الشريط الجانبي."})]}),a.type==="template"&&e.jsxs("fieldset",{className:"border p-4 rounded-md",children:[e.jsx("legend",{className:"px-2 font-semibold text-gray-700",children:"إعدادات حقول النموذج (JSON)"}),e.jsxs("div",{className:"flex gap-1 mb-3 border-b pb-3 -mx-4 px-4",children:[e.jsx("button",{type:"button",onClick:()=>j("builder"),className:`px-3 py-1 text-sm rounded-full ${x==="builder"?"bg-green-600 text-white":"bg-gray-200"}`,children:"المنشئ المرئي"}),e.jsx("button",{type:"button",onClick:()=>j("raw"),className:`px-3 py-1 text-sm rounded-full ${x==="raw"?"bg-green-600 text-white":"bg-gray-200"}`,children:"إدخال JSON مباشر"})]}),x==="builder"?e.jsxs("div",{className:"space-y-3 mt-2",children:[(((B=a.jsonTemplate)==null?void 0:B.fields)||[]).map((t,l)=>e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 p-3 bg-gray-50 rounded-md border relative",children:[e.jsx("button",{type:"button",onClick:()=>L(l),className:"absolute top-2 left-2 bg-red-100 text-red-600 h-6 w-6 flex items-center justify-center rounded-full hover:bg-red-200",children:"×"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"اسم الحقل (Label)"}),e.jsx("input",{type:"text",value:t.label,onChange:s=>b(l,"label",s.target.value),required:!0,className:"block w-full p-2 border rounded-md text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"معرّف الحقل (Field ID)"}),e.jsx("select",{value:t.fieldId,onChange:s=>b(l,"fieldId",s.target.value),className:"block w-full p-2 border rounded-md text-sm bg-white",children:G.map(s=>e.jsx("option",{value:s,children:D[s].label},s))})]}),e.jsxs("div",{className:"lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"محدد CSS"}),e.jsx("input",{type:"text",value:t.cssSelector,onChange:s=>b(l,"cssSelector",s.target.value),required:!0,placeholder:"#id, .class",className:"block w-full p-2 border rounded-md text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"نوع الإجراء"}),e.jsxs("select",{value:t.action,onChange:s=>b(l,"action",s.target.value),className:"block w-full p-2 border rounded-md text-sm bg-white",children:[e.jsx("option",{value:"write",children:"كتابة"}),e.jsx("option",{value:"select",children:"اختيار"}),e.jsx("option",{value:"click",children:"ضغط"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"نوع الحقل"}),e.jsxs("select",{value:t.type,onChange:s=>b(l,"type",s.target.value),className:"block w-full p-2 border rounded-md text-sm bg-white",children:[e.jsx("option",{value:"text",children:"Text"}),e.jsx("option",{value:"textarea",children:"Textarea"}),e.jsx("option",{value:"date",children:"Date"}),e.jsx("option",{value:"select",children:"Select"}),e.jsx("option",{value:"checkbox",children:"Checkbox"}),e.jsx("option",{value:"radio",children:"Radio"}),e.jsx("option",{value:"email",children:"Email"}),e.jsx("option",{value:"tel",children:"Tel"}),e.jsx("option",{value:"number",children:"Number"})]})]})]})]},l)),e.jsxs("button",{type:"button",onClick:q,className:"mt-2 text-sm bg-green-100 text-green-800 font-semibold py-2 px-3 rounded-lg hover:bg-green-200 transition-colors flex items-center gap-2",children:[e.jsx(H,{})," إضافة حقل جديد"]})]}):e.jsxs("div",{children:[e.jsx("textarea",{value:R,onChange:Q,className:"w-full h-64 font-mono text-sm bg-gray-900 text-green-300 p-2 rounded-md",dir:"ltr"}),N&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:N})]})]})]}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:A,className:"bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300",children:"إلغاء"}),e.jsx("button",{type:"submit",className:"bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700",children:"حفظ"})]})]})})})]})};export{se as default};
