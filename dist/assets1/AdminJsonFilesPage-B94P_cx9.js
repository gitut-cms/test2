import{a as ne,r as l,j as e,i as b,bp as $,bJ as T,bk as O,k as X,bt as k,bm as j,bT as le,bU as oe,bV as ie}from"./index-DrB1YgVl.js";import{F as J}from"./FileSaver.min-BvARJSWY.js";import"https://esm.sh/html-docx-js-typescript@0.1.5";import"https://esm.sh/file-saver@2.0.5";const re=[{type:"country-dropdown",dataType:"cafes",label:"ملف المقاهي (Cafes)",fileNamePattern:r=>`${r}-cafes-public.json`},{type:"country-dropdown",dataType:"services",label:"ملف الخدمات (Services)",fileNamePattern:r=>`${r}-all-services-public.json`},{type:"country-dropdown",dataType:"cafe-documents",label:"ملف بيانات المقهى (Cafe Data)",fileNamePattern:r=>`cafe-data/${r}.json`},{type:"country-dropdown",dataType:"cafe-sites",label:"ملف بيانات مواقع المقهى (Cafe Site Data)",fileNamePattern:r=>`cafe-data/${r}-site.json`},{type:"single",dataType:"services",countryCode:"global",fileName:"all-services-public.json",label:"ملف الخدمات العالمي (Global)"},{type:"single",dataType:"blog",countryCode:"global",fileName:"blog-posts-public.json",label:"ملفات المدونة (متعدد)"},{type:"single",dataType:"pages",countryCode:"dz",fileName:"dz-pages-public.json",label:"ملف الصفحات العام (dz)"},{type:"single",dataType:"settings",countryCode:"global",fileName:"site-settings-public.json",label:"ملف الإعدادات العام"},{type:"single",dataType:"seo",countryCode:"global",fileName:"site-seo.json",label:"ملف SEO (site-seo.json)"},{type:"single",dataType:"ads",countryCode:"global",fileName:"ads-public.json",label:"ملف الإعلانات العام"},{type:"single",dataType:"documents",countryCode:"global",fileName:"documents.json",label:"ملف المستندات (documents.json)"}],Ne=()=>{const{refetchAdminData:r,cafes:ce,services:de,blogPosts:be,pages:ge}=ne(),[g,w]=l.useState(null),[h,E]=l.useState(null),[N,M]=l.useState(!1),[I,d]=l.useState(""),[A,i]=l.useState(""),[me,ue]=l.useState(!1),[pe,he]=l.useState(""),[v,R]=l.useState(!1),[G,xe]=l.useState(!1),[U,m]=l.useState(""),[z,F]=l.useState(!1),[p,x]=l.useState(null),[B,V]=l.useState(!1),[H,S]=l.useState(""),[Z,L]=l.useState(!1),[_,f]=l.useState(""),[Y,q]=l.useState(!1),D=l.useRef(null),C=l.useRef(null),K=l.useRef(new Map);l.useEffect(()=>{const s=a=>{if(D.current&&!D.current.contains(a.target)&&F(!1),C.current&&!C.current.contains(a.target)&&q(!1),p){const t=K.current.get(p);t&&!t.contains(a.target)&&x(null)}};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[p]);const Q=async(s,a,t)=>{w(t),d(""),i(""),x(null);try{i(`(1/2) Generating data for ${t}...`);const o=await k(s,a);if(s==="blog"){if(typeof o!="object"||o===null)throw new Error("Blog data generation returned an invalid format.");const n=Object.entries(o).map(([c,y])=>({path:`data/json/${c}`,content:JSON.stringify(y)}));if(n.length===0){i("لا توجد البيانات للمدونة ليتم نشرها."),w(null),setTimeout(()=>i(""),5e3);return}i(`(2/2) Publishing ${n.length} files to GitHub...`),await j({files:n,commitMessage:"feat: Update public blog data",repoConfig:{owner:"gitut-cms",repo:"files"}}),i(`تم نشر ${n.length} ملفات مدونة بنجاح إلى GitHub!`)}else if(s==="services"){const n=o,c=JSON.stringify(n.mainData),u=[{path:`data/json/${t}`,content:c}];n.extraFiles&&Array.isArray(n.extraFiles)&&n.extraFiles.forEach(W=>{u.push({path:W.path,content:JSON.stringify(W.data,null,2)})}),i(`(2/2) Publishing ${u.length} files (Main List + Individual Docs) to GitHub...`),await j({files:u,commitMessage:`feat: Update ${t} and associated documents`,repoConfig:{owner:"gitut-cms",repo:"files"}}),i(`تم نشر ${u.length} ملف (القائمة والمستندات) بنجاح!`)}else{const n=JSON.stringify(o),c=`data/json/${t}`;i(`(2/2) Publishing ${t} to GitHub...`),await j({files:[{path:c,content:n}],commitMessage:`feat: Update ${t}`,repoConfig:{owner:"gitut-cms",repo:"files"}}),i(`تم نشر ${t} بنجاح إلى GitHub!`)}}catch(o){console.error(o);const n=o instanceof Error?o.message:String(o);d(`فشل في نشر ${t}. ${n}`)}finally{w(null),setTimeout(()=>{i(""),d("")},5e3)}},ee=async(s,a,t)=>{E(t),d(""),x(null);try{const o=await k(s,a);if(s==="blog"){const n=new le;Object.entries(o).forEach(([y,u])=>{n.file(y,JSON.stringify(u))});const c=await n.generateAsync({type:"blob"});J.saveAs(c,"gitut-blog-data.zip")}else if(s==="services"){const n=o,c=new Blob([JSON.stringify(n.mainData)],{type:"application/json"});J.saveAs(c,t)}else{const n=new Blob([JSON.stringify(o)],{type:"application/json"});J.saveAs(n,t)}}catch(o){console.error(o);const n=o instanceof Error?o.message:String(o);d(`فشل في تنزيل ${t}. ${n}`)}finally{E(null)}},se=async s=>{M(!0),d("");try{await oe(s)}catch(a){console.error(a),d(`Failed to generate zip file for ${s}.`)}finally{M(!1)}},P=async s=>{R(!0),m(s?`بدء إنشاء ملفات JSON للمستندات لـ: ${s}`:"بدء إنشاء ملفات JSON للمستندات...");try{const a=await k("documents-json",s||"global");!a||!Array.isArray(a)||a.length===0?m("لا توجد مستندات للنشر لهذا الفلتر."):(m(`رفع ${a.length} ملف JSON للمستندات إلى GitHub...`),await j({files:a,commitMessage:`feat: Update individual document JSON files${s?` for ${s}`:""}`,repoConfig:{owner:"gitut-cms",repo:"files"}}),m(`تم نشر ${a.length} ملف بنجاح!`))}catch(a){console.error("Document JSON publishing failed:",a);const t=a instanceof Error?a.message:String(a);m(`فشل: ${t}`)}finally{R(!1),setTimeout(()=>m(""),8e3)}},te=async()=>{V(!0),S("");try{const{newVersion:s}=await ie();S(`تم تحديث إصدار البيانات بنجاح إلى ${s}. سيتم إجبار المستخدمين على إعادة المزامنة.`)}catch(s){const a=s instanceof Error?s.message:"An unknown error occurred.";S(`فشل: ${a}`)}finally{V(!1)}},ae=async()=>{L(!0),f("جاري مزامنة أحدث البيانات من الخادم...");try{await r(),f("اكتمل تحديث البيانات بنجاح!")}catch(s){console.error("Manual data refresh failed:",s),f("فشل تحديث البيانات.")}finally{L(!1),setTimeout(()=>f(""),5e3)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("section",{className:"bg-white p-6 rounded-lg shadow-md border",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"إدارة البيانات العامة (JSON)"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"هذه الأزرار تقوم بإنشاء ونشر ملفات JSON العامة التي يستخدمها زوار الموقع. انشر الملفات بعد أي تغييرات مهمة في البيانات."}),e.jsx("div",{className:"space-y-3",children:re.map((s,a)=>s.dataType==="documents"?e.jsxs("div",{className:"flex justify-between items-center bg-gray-50 p-3 rounded-md",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:s.label}),e.jsxs("div",{className:"relative",ref:D,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("button",{onClick:()=>P("global"),disabled:v||G,className:"bg-blue-600 text-white font-semibold py-1 px-3 rounded-r-md hover:bg-blue-700 disabled:bg-gray-400 text-sm flex items-center gap-2",children:[v?e.jsx(b,{className:"animate-spin"}):e.jsx($,{}),e.jsx("span",{children:"Global"})]}),e.jsx("button",{onClick:()=>F(!z),disabled:v||G,className:"bg-blue-700 text-white font-bold px-2 rounded-l-md hover:bg-blue-800 disabled:bg-gray-500 border-r border-blue-500",children:e.jsx(T,{})})]}),z&&e.jsxs("div",{className:"absolute left-0 mt-1 w-48 bg-white rounded-md shadow-lg border z-10 max-h-60 overflow-y-auto",children:[e.jsx("button",{onClick:()=>P("global"),className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold border-b",children:"Global (الكل)"}),O.en.map(t=>e.jsxs("button",{onClick:()=>P(t.code),className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",children:[e.jsx("span",{children:t.flag})," ",t.name]},t.code))]})]})]},s.label):s.type==="country-dropdown"?e.jsxs("div",{className:"flex justify-between items-center bg-gray-50 p-3 rounded-md",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:s.label}),e.jsxs("div",{className:"relative",ref:t=>{t&&K.current.set(s.dataType,t)},children:[e.jsxs("button",{onClick:()=>x(p===s.dataType?null:s.dataType),disabled:!!g||!!h,className:"bg-blue-600 text-white font-semibold py-1 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 text-sm flex items-center gap-2",children:[g&&g.includes(s.dataType)?e.jsx(b,{className:"animate-spin"}):e.jsx($,{}),e.jsx("span",{children:"اختر الدولة للنشر"}),e.jsx(T,{})]}),p===s.dataType&&e.jsx("div",{className:"absolute left-0 mt-1 w-56 bg-white rounded-md shadow-lg border z-10 max-h-60 overflow-y-auto",children:O.en.map(t=>e.jsxs("button",{onClick:()=>Q(s.dataType,t.code,s.fileNamePattern(t.code)),className:"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2 justify-between group",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t.flag})," ",t.name]}),e.jsx("span",{className:"text-xs text-gray-400 group-hover:text-gray-600",children:"نشر"})]},t.code))})]})]},s.label):e.jsxs("div",{className:"flex justify-between items-center bg-gray-50 p-3 rounded-md",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:s.label}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>ee(s.dataType,s.countryCode,s.fileName),disabled:!!g||h===s.fileName,title:"تنزيل الملف",className:"bg-gray-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-gray-700 disabled:bg-gray-400 text-sm flex items-center gap-2",children:h===s.fileName?e.jsx(b,{className:"animate-spin"}):e.jsx(X,{})}),e.jsxs("button",{onClick:()=>Q(s.dataType,s.countryCode,s.fileName),disabled:!!g||!!h,className:"bg-blue-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-blue-700 disabled:bg-gray-400 text-sm flex items-center gap-2",children:[g===s.fileName?e.jsx(b,{className:"animate-spin"}):e.jsx($,{}),e.jsx("span",{children:"نشر"})]})]})]},s.fileName))}),A&&e.jsx("p",{className:"text-green-600 text-sm mt-3",children:A}),I&&e.jsx("p",{className:"text-red-600 text-sm mt-3",children:I}),U&&e.jsx("p",{className:"text-blue-600 text-sm mt-2 text-center",children:U})]}),e.jsxs("section",{className:"bg-white p-6 rounded-lg shadow-md border",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"تنزيل النسخ الاحتياطي (ZIP)"}),e.jsxs("div",{className:"relative",ref:C,children:[e.jsxs("button",{onClick:()=>q(s=>!s),className:"w-full bg-gray-700 text-white font-bold py-3 px-5 rounded-lg hover:bg-gray-800 transition-colors flex items-center justify-center gap-2",disabled:N,children:[N?e.jsx(b,{className:"animate-spin"}):e.jsx(X,{}),e.jsx("span",{children:N?"جاري التجهيز...":"اختر بلدًا للتنزيل"}),e.jsx(T,{})]}),Y&&e.jsx("div",{className:"absolute top-full right-0 mt-2 w-full bg-white rounded-lg shadow-xl border z-10",children:e.jsx("ul",{className:"py-1 max-h-60 overflow-y-auto",children:O.en.map(s=>e.jsx("li",{children:e.jsxs("button",{onClick:()=>se(s.code),className:"w-full text-right px-4 py-2 hover:bg-gray-100 flex items-center gap-3",children:[e.jsx("span",{className:"text-xl",children:s.flag}),e.jsx("span",{children:s.name})]})},s.code))})})]})]}),e.jsxs("section",{className:"bg-white p-6 rounded-lg shadow-md border",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"إدارة إصدار البيانات & Sitemap"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("button",{onClick:te,disabled:B,className:"bg-yellow-500 text-white font-bold p-4 rounded-lg hover:bg-yellow-600 disabled:bg-gray-400",children:B?e.jsx(b,{className:"animate-spin"}):"رفع إصدار البيانات"}),e.jsx("button",{onClick:ae,disabled:Z,className:"bg-indigo-500 text-white font-bold p-4 rounded-lg hover:bg-indigo-600 disabled:bg-gray-400",children:Z?e.jsx(b,{className:"animate-spin"}):"تحديث البيانات المحلية"})]}),H&&e.jsx("p",{className:"text-center mt-2 text-sm text-blue-700",children:H}),_&&e.jsx("p",{className:"text-center mt-2 text-sm text-indigo-700",children:_})]})]})};export{Ne as default};
