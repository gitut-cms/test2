import{u as ce,a as de,m as ue,l as me,r as m,Z as B,_ as xe,j as e,i as K,a2 as ge,h as he,a3 as be,an as fe,ao as pe,a1 as ye,Q as je,k as ve,C as we,d as Ne,A as De,a4 as Ce,$ as Y}from"./index-DrB1YgVl.js";import{asBlob as Pe}from"https://esm.sh/html-docx-js-typescript@0.1.5";import Fe from"https://esm.sh/file-saver@2.0.5";const Se=(u,w)=>{var p,c;return!!((p=w.fieldCustomizations)!=null&&p[u])||!!((c=w.questions)!=null&&c[u])},Ie=()=>{const{user:u,updateUserCredits:w}=ce(),{siteSettings:p}=de(),{t:c}=ue(),N=me(),[h,X]=m.useState([]),[ee,O]=m.useState(!0),[b,D]=m.useState([]),[te,k]=m.useState(!1),[C,_]=m.useState(""),[v,E]=m.useState(""),[P,q]=m.useState([]),[I,F]=m.useState(0),[se,T]=m.useState(!1),[ae,$]=m.useState(null),z=m.useMemo(()=>!u||!p?0:u.credits.currency==="USD"?p.pricing.dynamicDocument.usd:p.pricing.dynamicDocument.dzd,[u,p]);m.useEffect(()=>{(async()=>{if(!(u!=null&&u.countryCode)){O(!1);return}try{const s=await De(u.countryCode);X(s)}catch(s){console.error("Failed to load country documents:",s)}finally{O(!1)}})()},[u==null?void 0:u.countryCode]),m.useEffect(()=>{if(N.state&&N.state.preSelectedDocIds&&h.length>0){const t=N.state.preSelectedDocIds,s=h.filter(l=>t.includes(l.id));if(s.length>0){const l={id:Date.now(),name:"زبون جديد",documentIds:s.map(n=>n.id),formData:{},complexFormData:{},saveClient:!0,isFromClientList:!1};D([l]),T(!0),F(0),window.history.replaceState({},document.title)}}},[N.state,h]);const M=m.useMemo(()=>{if(!v)return[];const t=v.toLowerCase();return h.filter(s=>s.name.toLowerCase().includes(t))},[v,h]),ne=t=>{P.find(s=>s.id===t.id)||q(s=>[...s,t]),E("")},re=t=>{q(s=>s.filter(l=>l.id!==t))},oe=()=>{if(!C.trim()||P.length===0){alert(c("multiPersonJobPage.alerts.enterNameAndDoc"));return}const t={id:Date.now(),name:C,documentIds:P.map(s=>s.id),formData:{fullName:C},complexFormData:{},saveClient:!0,isFromClientList:!1};D(s=>[...s,t]),_(""),q([]),E(""),k(!1)},R=m.useCallback(t=>{const s=new Map;return h.filter(n=>t.documentIds.includes(n.id)).forEach(n=>{var r;(r=n.requiredFields)==null||r.forEach(a=>{var U,W,Q,V,G,H,Z;if(a==="DateToday")return;const o=Se(a,n)||!B[a],i=B[a];let x=a;(U=n.questions)!=null&&U[a]?x=n.questions[a]:(Q=(W=n.fieldCustomizations)==null?void 0:W[a])!=null&&Q.customQuestion?x=n.fieldCustomizations[a].customQuestion:i?(x=c(i.label),x===i.label&&(x=xe[a]||i.label)):x=a;const y=((G=(V=n.fieldCustomizations)==null?void 0:V[a])==null?void 0:G.type)||(i==null?void 0:i.type)||"text";let j;const f=(Z=(H=n.fieldCustomizations)==null?void 0:H[a])==null?void 0:Z.options;f?j=f.map(g=>typeof g=="string"?{value:g,label:g}:{value:g.value,label:g.label,mappedValues:g.mappedValues}):i!=null&&i.options&&(j=i.options.map(g=>({value:g.value,label:c(g.label)})));const S=o?`${n.id}_${a}`:a;if(s.has(S)){const g=s.get(S);g.sourceDocs.includes(n.name)||g.sourceDocs.push(n.name)}else s.set(S,{uniqueId:S,fieldId:a,label:x,type:y,options:j,isCustom:o,sourceDocs:[n.name]})})}),Array.from(s.values())},[h,c]),d=b[I],A=m.useMemo(()=>d?R(d):[],[d,R]),L=(t,s,l)=>{D(n=>n.map((r,a)=>{if(a!==I)return r;const o={...r.formData};return A.forEach(i=>{if(i.fieldId===s&&(o[i.uniqueId]=l,i.uniqueId.includes("_")||(o[s]=l),i.type==="select"&&i.options)){const x=i.options.find(y=>y.value===l);x&&x.mappedValues&&Object.entries(x.mappedValues).forEach(([y,j])=>{o[y]=j})}}),{...r,formData:o}}))},J=async(t,s,l,n="pdf")=>{if(u){$(`${t.id}-${s}`);try{const r=await Ce(u,z);if(!r.success){alert(r.message),$(null);return}w(u.credits.amount-z),l==="download"?await le(t,s,n,!0):await ie(t,s,!0)}catch(r){console.error("Credit deduction or processing error:",r),alert("حدث خطأ أثناء العملية.")}finally{$(null)}}},le=async(t,s,l,n=!1)=>{const r=h.find(a=>a.id===s);if(r)try{const a={};if(Object.keys(t.formData).forEach(o=>{o.includes("_")||(a[o]=t.formData[o])}),Object.keys(t.formData).forEach(o=>{if(o.startsWith(`${r.id}_`)){const i=o.replace(`${r.id}_`,"");a[i]=t.formData[o]}}),l==="docx"){let o=r.finalTemplateHtml||"";if(!o&&r.finalTemplateUrl)try{const f=await fetch(r.finalTemplateUrl);f.ok&&(o=await f.text())}catch(f){console.error("Failed to fetch docx template",f)}if(!o)throw new Error("Template content not found.");const x=new Date().toLocaleDateString("ar-DZ");o=o.replace(/\[DateToday\]/g,x),Object.keys(a).forEach(f=>{o=o.replace(new RegExp(`\\[${f}\\]`,"g"),a[f]||"")}),o=o.replace(/\[[^\]]+\]/g,"");const y=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"></head><body>${o}</body></html>`,j=await Pe(y,{orientation:"portrait",margins:{top:720,right:720,bottom:720,left:720}});Fe.saveAs(j,`${r.slug||r.name}.docx`)}else await Y([r],r.id,a,{action:"download",targetLang:"ar",templateType:"final"})}catch(a){console.error("Generation failed:",a),alert("فشل إنشاء المستند.")}},ie=async(t,s,l=!1)=>{const n=h.find(r=>r.id===s);if(n)try{const r={};Object.keys(t.formData).forEach(a=>{a.includes("_")||(r[a]=t.formData[a])}),Object.keys(t.formData).forEach(a=>{a.startsWith(`${n.id}_`)&&(r[a.replace(`${n.id}_`,"")]=t.formData[a])}),await Y([n],n.id,r,{action:"print",targetLang:"ar",templateType:"final"})}catch(r){console.error(r),alert("فشل الطباعة")}};return ee?e.jsx("div",{className:"flex justify-center items-center p-10",children:e.jsx(K,{className:"animate-spin text-4xl text-green-600"})}):se?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("button",{onClick:()=>T(!1),className:"text-sm bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200",children:["← ",c("multiPersonJobPage.buttons.backToSetup")]}),e.jsxs("div",{className:"flex items-center bg-white rounded-full shadow-sm border p-1",children:[e.jsx("button",{onClick:()=>F(t=>(t-1+b.length)%b.length),className:"p-2 rounded-full hover:bg-gray-100 text-gray-600",disabled:b.length<=1,children:e.jsx(fe,{})}),e.jsxs("span",{className:"font-bold text-gray-800 px-4 min-w-[150px] text-center",children:[d==null?void 0:d.name," ",e.jsxs("span",{className:"text-gray-400 text-sm font-normal",children:["(",I+1,"/",b.length,")"]})]}),e.jsx("button",{onClick:()=>F(t=>(t+1)%b.length),className:"p-2 rounded-full hover:bg-gray-100 text-gray-600",disabled:b.length<=1,children:e.jsx(pe,{})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 bg-white rounded-xl shadow-md border p-6",children:[e.jsxs("h2",{className:"text-xl font-bold mb-4 text-gray-800 border-b pb-2",children:["بيانات ",d==null?void 0:d.name]}),e.jsx("div",{className:"space-y-4 max-h-[65vh] overflow-y-auto pr-2",children:A.length===0?e.jsx("p",{className:"text-gray-500 italic",children:"لا توجد حقول مطلوبة للمستندات المختارة."}):A.map(t=>e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg border border-gray-100",children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:[t.label,t.isCustom&&e.jsxs("span",{className:"text-xs text-blue-600 font-normal mr-2",children:["(مخصص لـ: ",t.sourceDocs.join(", "),")"]}),!t.isCustom&&t.sourceDocs.length>1&&e.jsxs("span",{className:"text-xs text-green-600 font-normal mr-2",children:["(مشترك بين ",t.sourceDocs.length," مستندات)"]})]}),t.type==="file"||t.fieldId==="profilePicture"?e.jsx(ye,{value:d.formData[t.uniqueId]||"",onChange:s=>L(t.uniqueId,t.fieldId,s)}):t.options?e.jsxs("select",{value:d.formData[t.uniqueId]||"",onChange:s=>L(t.uniqueId,t.fieldId,s.target.value),className:"w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-500",children:[e.jsxs("option",{value:"",children:["-- ",c("formPage.selectOption")||"اختر"," --"]}),t.options.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}):e.jsx("input",{type:t.type,value:d.formData[t.uniqueId]||"",onChange:s=>L(t.uniqueId,t.fieldId,s.target.value),className:"w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500",placeholder:t.label})]},t.uniqueId))})]}),e.jsxs("div",{className:"bg-gray-50 rounded-xl shadow-inner p-6 border h-fit",children:[e.jsx("h2",{className:"text-xl font-bold mb-4 text-gray-800",children:"المستندات الجاهزة"}),e.jsx("div",{className:"space-y-3",children:d.documentIds.map(t=>{const s=h.find(n=>n.id===t);if(!s)return null;const l=ae===`${d.id}-${s.id}`;return e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-sm border",children:[e.jsx("h3",{className:"font-bold text-gray-800 mb-2 truncate",title:s.name,children:s.name}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>J(d,s.id,"print"),disabled:l,className:"flex-1 bg-gray-100 text-gray-700 py-2 rounded-md hover:bg-gray-200 flex items-center justify-center gap-1 font-medium text-sm transition-colors",children:[l?e.jsx(K,{className:"animate-spin"}):e.jsx(je,{}),"طباعة"]}),e.jsxs("div",{className:"relative group flex-1",children:[e.jsxs("button",{className:"w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 flex items-center justify-center gap-1 font-medium text-sm transition-colors",children:[e.jsx(ve,{}),"تحميل"]}),e.jsxs("div",{className:"absolute top-full right-0 w-full bg-white border shadow-lg rounded-md hidden group-hover:block z-10 overflow-hidden mt-1",children:[e.jsxs("button",{onClick:()=>J(d,s.id,"download","pdf"),className:"w-full text-right px-3 py-2 hover:bg-gray-100 text-sm flex items-center gap-2",children:[e.jsx(we,{className:"text-red-500"})," PDF"]}),e.jsxs("button",{onClick:()=>J(d,s.id,"download","docx"),className:"w-full text-right px-3 py-2 hover:bg-gray-100 text-sm flex items-center gap-2",children:[e.jsx(Ne,{className:"text-blue-500"})," Word"]})]})]})]})]},s.id)})})]})]})]}):e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800 mb-2",children:c("multiPersonJobPage.title")}),e.jsx("p",{className:"text-gray-600 mb-6",children:c("multiPersonJobPage.step1Subtitle")}),e.jsx("div",{className:"space-y-4",children:b.map((t,s)=>e.jsxs("div",{className:"bg-white p-4 rounded-lg border flex justify-between items-center shadow-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-bold text-lg text-gray-800",children:[s+1,". ",t.name]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:t.documentIds.map(l=>{const n=h.find(r=>r.id===l);return n?e.jsx("span",{className:"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full",children:n.name},l):null})})]}),e.jsx("button",{onClick:()=>D(l=>l.filter(n=>n.id!==t.id)),className:"text-red-500 hover:text-red-700 bg-red-50 p-2 rounded-full",children:e.jsx(ge,{})})]},t.id))}),te?e.jsxs("div",{className:"bg-gray-50 p-6 rounded-lg border border-gray-200 mt-6 animate-fadeIn shadow-inner",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 text-gray-800",children:c("multiPersonJobPage.section.addPerson")}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"الاسم الكامل"}),e.jsx("input",{type:"text",value:C,onChange:t=>_(t.target.value),placeholder:"مثال: أحمد محمد",className:"w-full p-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"المستندات المطلوبة"}),e.jsx("div",{className:"flex gap-2",children:e.jsx("input",{type:"text",value:v,onChange:t=>E(t.target.value),placeholder:c("multiPersonJobPage.placeholders.searchService"),className:"flex-grow p-2 border rounded-md"})}),v&&M.length>0&&e.jsx("ul",{className:"mt-1 bg-white border rounded-md shadow-lg max-h-40 overflow-y-auto",children:M.map(t=>e.jsx("li",{onClick:()=>ne(t),className:"px-4 py-2 hover:bg-gray-100 cursor-pointer",children:t.name},t.id))}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:P.map(t=>e.jsxs("div",{className:"flex items-center gap-1 bg-green-100 text-green-800 rounded-full px-3 py-1 text-sm",children:[e.jsx("span",{children:t.name}),e.jsx("button",{onClick:()=>re(t.id),className:"text-green-900 hover:text-red-600",children:e.jsx(he,{})})]},t.id))})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx("button",{onClick:oe,className:"bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700",children:c("multiPersonJobPage.buttons.confirmAdd")}),e.jsx("button",{onClick:()=>k(!1),className:"bg-gray-200 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-300",children:c("multiPersonJobPage.buttons.cancel")})]})]})]}):e.jsxs("button",{onClick:()=>k(!0),className:"mt-6 w-full py-4 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-green-500 hover:text-green-600 flex items-center justify-center gap-2 transition-colors",children:[e.jsx(be,{}),e.jsx("span",{className:"font-semibold",children:c("multiPersonJobPage.buttons.addPerson")})]}),e.jsx("div",{className:"mt-8 pt-6 border-t",children:e.jsx("button",{onClick:()=>{T(!0),F(0)},disabled:b.length===0,className:"w-full bg-blue-600 text-white font-bold text-lg py-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed shadow-lg",children:c("multiPersonJobPage.buttons.startFilling",{count:b.length})})})]})};export{Ie as default};
